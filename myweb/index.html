<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>TuChamba Express | Vacantes Urgentes en Nuevo Le√≥n, CDMX y EdoMex 2026</title>
    
    <link rel="icon" href="favicon.png" type="image/png">

    <meta name="description" content="Encuentra trabajo sin experiencia y de contrataci√≥n inmediata en Nuevo Le√≥n, CDMX y Estado de Mexico. ¬°Sin registros! Contacta directo por WhatsApp. Vacantes vigentes 2026.">
    
    <meta name="keywords" content="bolsa de trabajo 2026, trabajo estado de mexico, ciudad de mexico, trabajo sin experiencia, cdmx, monterrey, nuevo leon, lunes a viernes, contrataci√≥n inmediata, ayudante general, ventas, atenci√≥n a clientes">

    <meta property="og:title" content="¬øBuscas chamba urgente? Vacantes en Nuevo Le√≥n, CDMX y EdoMex üöÄ">
    <meta property="og:description" content="Sin correos ni registros. Clic y directo al WhatsApp del reclutador. ¬°Entra ya!">
    <meta property="og:image" content="https://tuchamba-express.vercel.app/banner_1.png">
    <meta property="og:url" content="https://tuchamba-express.vercel.app/">
    <meta property="og:type" content="website">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
      body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: 
                linear-gradient(to bottom, rgba(10, 30, 60, 0.75), rgba(10, 30, 60, 0.85)),
                url('https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;       
            background-position: center;  
            background-attachment: fixed; 
            padding: 15px;
            min-height: 100vh;
        }

        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
            text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2147483647 !important;
            left: 50%; bottom: 30px; font-size: 15px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible !important; opacity: 1 !important; bottom: 50px !important; }

        .footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: #ccc; font-size: 12px; line-height: 1.6; }
        .footer-link { color: #fff; text-decoration: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .legal-note { color: #999; margin-top: 8px; font-style: italic; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 1000px 100%; display: inline-block; position: relative; animation: shimmer 2s infinite linear forwards; border-radius: 4px; }
        .skeleton-card { background: white; border-radius: 16px; padding: 25px; height: 200px; display: flex; flex-direction: column; gap: 15px; }
        .sk-title { width: 70%; height: 24px; } .sk-text { width: 90%; height: 16px; } .sk-tag { width: 30%; height: 20px; border-radius: 20px; }

        .welcome-container { 
            max-width: 480px; 
            margin: 60px auto; 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(8px);            
            -webkit-backdrop-filter: blur(8px);    
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-top: 5px solid #ffc107; 
            padding: 40px 25px; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            text-align: center; 
        }
        
        .welcome-title { font-size: 28px; color: #ffffff; margin-bottom: 10px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
        .welcome-subtitle { color: #f0f0f0; margin-bottom: 30px; font-size: 16px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5); line-height: 1.5; }
        
        .btn-big-guest { background: #0a66c2; color: white; border: none; padding: 16px; width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-big-guest:hover { background: #004182; transform: translateY(-2px); }
        
        .admin-toggle-link { display: block; margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 13px; text-decoration: underline; cursor: pointer; }
        .admin-login-form { display: none; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); text-align: left; animation: fadeIn 0.5s; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { max-width: 1250px; margin: 0 auto; }

        .header { 
            background: white; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .header h1 { 
            font-size: 20px; 
            color: #333; 
            font-weight: 800; 
            margin: 0;
            line-height: 1.2;
        }
        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #recruiterBanner { 
            background: #e3f2fd !important; 
            color: #0d47a1 !important; 
            padding: 10px 15px; 
            border-radius: 8px; 
            margin-top: 30px; 
            margin-bottom: 10px; 
            font-size: 13px; 
            display: flex !important; 
            align-items: center; 
            justify-content: center;
            gap: 10px; 
            border: 1px solid #bbdefb; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-align: center;
        }
        #recruiterBanner:hover { background: #bbdefb !important; }

        .search-container {
            width: 100%;
            margin-bottom: 10px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 15px;
            outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: border 0.2s;
        }
        .search-input:focus { border-color: #0a66c2; }
        
        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ddd;
            color: #666;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .search-clear-btn:hover { background: #ccc; }

        .filter-container { 
            background: white; 
            padding: 10px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; 
            gap: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            align-items: center; 
        }
        
        .filter-icon-box { display: flex; align-items: center; justify-content: center; background: #f0f2f5; padding: 10px; border-radius: 8px; border: 1px solid #ddd; height: 42px; width: 42px; flex-shrink: 0; }
        .filter-select { flex: 1; min-width: 0; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; outline: none; height: 42px; }

        #mobileFilterToggle { display: none; } 

        .btn-primary, .admin-btn { background: #0a66c2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; font-size: 14px; }
        .add-job-btn { background: #10a37f; padding: 12px 24px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .tool-btn { background: #2c3e50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .metrics-btn { background: #7b1fa2; } .team-btn { background: #e65100; } .settings-btn { background: #607d8b; }
        .danger-section { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 25px; }
        .danger-btn { background: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .page-btn {
            background: white;
            border: 1px solid #ddd;
            color: #0a66c2;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .page-btn:hover {
            background: #f0f2f5;
            border-color: #0a66c2;
        }
        .page-btn.active {
            background: #0a66c2;
            color: white;
            border-color: #0a66c2;
        }
        .page-btn:disabled {
            background: #f9f9f9;
            color: #ccc;
            cursor: not-allowed;
            border-color: #eee;
        }
        .page-info {
            width: 100%;
            text-align: center;
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px 20px 20px; margin: 20px -30px -30px; border-top: 1px solid #eee; text-align: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 100; }
        
        .whatsapp-btn-large { display: flex; align-items: center; justify-content: center; width: 100%; background-color: #25D366; color: white; text-decoration: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.3); transition: transform 0.1s, background-color 0.3s, opacity 0.3s; border: none; cursor: pointer; }
        .whatsapp-btn-large:active { transform: scale(0.98); }
        .whatsapp-btn-large:disabled { background-color: #9ccc65; cursor: not-allowed; transform: none; opacity: 0.7; }

        .share-btn { background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .admin-controls-wrapper { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .metrics-card { background: white; color: #333; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; font-size: 14px; }
        .metric-val { color: #0a66c2; font-weight: 800; margin-left: 4px; margin-right: 12px; }
        .admin-mode-indicator { background: #ffe0b2; color: #e65100; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #ffcc80; }

        .job-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        /* V16.27: Card Adjustment to support Badge */
        .job-card { background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; border: 1px solid #f0f0f0; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .job-card:hover { transform: translateY(-4px); }
        .job-card.hidden { display: none; }

        /* V16.27: ESTILO TOP VACANTE (Opci√≥n A - Gold) */
        .badge-featured {
            position: absolute;
            top: 15px;
            right: 40px; /* Un poco a la izquierda del bot√≥n de men√∫ */
            background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 800;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            z-index: 4;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #ffecb3;
        }

        .card-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; margin-right: 35px; }
        .card-header-date { font-size: 0.75rem; color: #888; background: #f5f5f5; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 12px; }
        
        .badge-vigente { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
        .badge-closed { background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }
        
        .badge-new { background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; margin-left: 5px; border: 1px solid #ffcc80; }

        .job-title { font-size: 1.2rem; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; line-height: 1.3; }
        .company-name { font-size: 0.9rem; color: #0a66c2; font-weight: 600; }
        .location { font-size: 0.9rem; color: #555; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
        .salary-text { color: #d32f2f; font-weight: 800; font-size: 1.1rem; margin-top: 5px; }

        .company-logo { width: 48px; height: 48px; background: linear-gradient(135deg, #0a66c2 0%, #004182 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }

        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; }
        .tag { background: #f3f2ef; color: #444; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }

        .more-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 24px; color: #ccc; cursor: pointer; width: 30px; height: 30px; z-index: 5; }
        .admin-actions { display: none; position: absolute; top: 45px; right: 15px; background: white; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 20; }
        .admin-actions.active { display: block; }
        .admin-action { padding: 10px 20px; width: 100%; text-align: left; border: none; background: none; cursor: pointer; }
        .admin-action:hover { background: #f9f9f9; }

        /* V16.22: AJUSTE DE MODALES (M√°rgenes optimizados) */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        /* Reduced padding to 25px */
        .modal-content { background: white; border-radius: 16px; max-width: 650px; width: 100%; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; padding-bottom: 0; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #f0f2f5; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #666; z-index: 10; }
        
        /* Adjusted margins inside modal */
        .job-details { display: grid; gap: 15px; margin-bottom: 15px; }
        .detail-item { font-size: 15px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .location-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .phone-group { display: flex; gap: 8px; align-items: center; }
        .phone-select { width: auto; min-width: 100px; max-width: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f0f2f5; cursor:pointer; }
        
        @media (max-width: 500px) { .location-grid { grid-template-columns: 1fr; } }
        
        .view-count-badge { background: #e3f2fd; color: #0277bd; font-size: 12px; padding: 6px 14px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 15px; font-weight: 700; border: 1px solid #bbdefb; margin-right: 5px; }
        .agency-badge { background: #fff3e0; color: #ef6c00; font-size: 12px; padding: 6px 14px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 15px; font-weight: 700; border: 1px solid #ffe0b2; }

        /* Adjusted section margins */
        .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 12px; margin-top: 20px; border-bottom: 2px solid #f0f2f5; padding-bottom: 5px; display: inline-block; }
        .item-list li { background: #f9f9f9; padding: 8px 12px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; }
        
        .recruiters-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .recruiters-table th, .recruiters-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .recruiters-table th { background: #f9fafb; color: #666; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .recruiters-table tr:hover { background-color: #f9f9f9; }

        .job-counter { color: white; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-bottom: 10px; display: block; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { 
                flex-direction: row; 
                justify-content: space-between; 
                align-items: center;
                gap: 5px;
            }
            .header h1 {
                font-size: 17px; 
                max-width: 50%; 
                line-height: 1.1;
            }
            .filter-container { 
                display: grid; 
                grid-template-columns: auto 1fr 1fr; 
                gap: 8px;
                overflow-x: visible; 
            }
            .filter-icon-box { height: 40px; width: 40px; }
            .filter-select { height: 40px; font-size: 13px; padding: 5px; }
            
            .admin-controls-wrapper button { flex: 1; min-width: 45%; }
        }

        /* V16.25: FLYER MARKETING VISUAL (Imagen + Badge + Caja Blanca) */
        #flyerTemplate {
            width: 1080px;
            min-height: 1080px;
            height: auto;
            /* Fondo Bodega + Overlay Oscuro para legibilidad */
            background-image: 
                linear-gradient(rgba(0, 20, 40, 0.85), rgba(0, 20, 40, 0.95)),
                url('https://images.unsplash.com/photo-1504328345606-18bbc8c9d7d1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            color: white;
            font-family: 'Arial Black', 'Arial', sans-serif;
            text-align: center;
            padding: 100px 50px;
            box-sizing: border-box;
        }
        
        .flyer-badge-top {
            background-color: #FF6D00; /* Naranja Impacto */
            color: white;
            font-size: 45px;
            padding: 20px 60px;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
            margin-bottom: 60px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 4px solid white;
        }

        .flyer-title { 
            font-size: 85px; 
            font-weight: 900; 
            line-height: 1.1; 
            margin-bottom: 50px; 
            text-shadow: 0 5px 15px rgba(0,0,0,0.8); 
            max-width: 95%;
            text-transform: uppercase;
        }
        
        .flyer-salary { 
            font-size: 110px; 
            color: #FFEB3B; /* Amarillo Gigante */
            font-weight: 900; 
            margin-bottom: 30px; 
            text-shadow: 0 5px 15px rgba(0,0,0,0.8); 
        }
        
        .flyer-salary-sub {
            font-size: 35px;
            color: #E3F2FD;
            margin-top: -20px;
            margin-bottom: 80px;
            font-weight: 500;
            font-family: 'Segoe UI', sans-serif;
            opacity: 0.9;
        }

        .flyer-location { 
            font-size: 45px; 
            margin-bottom: 80px; 
            color: #FFF; 
            font-weight: 700; 
            display:flex; 
            align-items:center; 
            gap:15px; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
            background: rgba(0,0,0,0.3);
            padding: 15px 40px;
            border-radius: 50px;
        }
        
        /* CAJA BLANCA PARA WHATSAPP (A Petici√≥n) */
        .flyer-cta-box { 
            background: white; 
            color: #000; 
            padding: 30px 70px; 
            border-radius: 20px; 
            font-size: 50px; 
            font-weight: 900; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); 
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 10px solid #ccc; /* Efecto 3D */
        }
    </style>
</head>
<body>

    <div id="flyerTemplate">
        <div class="flyer-badge-top">¬°ESTAMOS CONTRATANDO!</div>
        
        <div id="flyerTitle" class="flyer-title">CHOFER 3.5 TON</div>
        
        <div id="flyerSalary" class="flyer-salary">$12,000</div>
        <div class="flyer-salary-sub">Pago Semanal / Prestaciones</div>

        <div class="flyer-location">üìç <span id="flyerLocation">Valle de Chalco, EdoMex</span></div>
        
        <div class="flyer-cta-box">
            <span>üì≤ WhatsApp:</span> 
            <span id="flyerPhone">55 1234 5678</span>
        </div>
    </div>

    <div id="loginScreen" class="welcome-container">
        <div style="font-size: 50px; margin-bottom: 10px;">üöÄ</div>
        <h1 class="welcome-title">TuChamba Express</h1>
        <p class="welcome-subtitle">
            Tu nueva chamba a un mensaje de distancia.<br>
            Sin registros complicados.
        </p>
        <button class="btn-big-guest" onclick="enterAsGuest()">üîç Ver Vacantes Disponibles</button>
        <div class="admin-toggle-link" onclick="toggleAdminLogin()">¬øEres Reclutador? Ingresa aqu√≠</div>
        <div id="adminForm" class="admin-login-form">
            <div class="form-group"><label style="color:white;">Correo de Acceso</label><input type="email" id="adminEmail" placeholder="admin@empresa.com" autocomplete="off" style="background:rgba(255,255,255,0.9);"></div>
            <div class="form-group"><label style="color:white;">Contrase√±a</label><input type="password" id="adminPassword" placeholder="******" autocomplete="off" style="background:rgba(255,255,255,0.9);"></div>
            <button class="btn-primary" style="width: 100%;" onclick="login()">Entrar al Panel</button>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="container">
            
            <div class="header">
                <h1>Portal de Vacantes</h1>
                <div class="header-buttons">
                    <button class="share-btn" onclick="shareApp()">üì§ Compartir</button>
                    <span id="modeIndicator"></span>
                    <button class="admin-btn" style="background: #333;" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="adminControls" style="display: none;">
                <div class="admin-controls-wrapper">
                    <div class="metrics-card">
                        üåé <span class="metric-val" id="totalVisits">...</span>
                        üìÖ Mes: <span class="metric-val" id="monthlyVisits">...</span>
                    </div>
                    <button class="add-job-btn" onclick="openJobForm()">‚ûï Nueva</button>
                    <button class="tool-btn" onclick="exportToExcel()">üì¶ Respaldo</button> 
                    <button class="tool-btn metrics-btn" onclick="openMetricsModal()">üìä M√©tricas</button>
                    <button class="tool-btn team-btn" onclick="openTeamModal()">üë• Equipo</button>
                    <button class="tool-btn settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Ajustes</button>
                    
                    <button class="tool-btn" onclick="document.getElementById('excelFile').click()">üì§ Cargar</button>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importFromExcel(event)">
                    <button class="tool-btn" onclick="downloadTemplate()">üìã Plantilla</button>
                </div>
            </div>

            <button id="mobileFilterToggle" onclick="toggleMobileFilters()">
                üîç Filtros de B√∫squeda <span>‚ñº</span>
            </button>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar vacante, empresa, palabras clave..." onkeyup="filterJobs()" autocomplete="off">
                <button id="clearSearchBtn" class="search-clear-btn" onclick="clearSearch()">‚úï</button>
            </div>

            <div class="filter-container" id="filterContainer">
                <div class="filter-icon-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                </div>
                <select id="stateFilter" class="filter-select" onchange="filterJobs()" autocomplete="off">
                    <option value="">üìç Estado</option>
                </select>
                <select id="cityFilter" class="filter-select" onchange="filterJobs()" autocomplete="off">
                    <option value="">üèôÔ∏è Municipio</option>
                </select>
            </div>

            <div class="grid-header"><div class="job-counter" id="jobCounter"></div></div>
            
            <div id="skeletonLoader" class="job-grid">
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
            </div>

            <div class="job-grid" id="jobGrid" style="display: none;"></div>
            
            <div id="paginationContainer" class="pagination-container" style="display:none;"></div>

            <div id="recruiterBanner" onclick="contactCentralOffice()">
                üë§ Asistido por: <span id="recruiterNameDisplay">Oficina Central</span> (Clic para contacto)
            </div>

            <div class="footer">
                <p>TuChamba Express &copy; 2024. Todos los derechos reservados.<br>
                Aviso: Algunas empresas pueden solicitar examen m√©dico y/o antidoping.</p>
                <div style="margin-top:10px;">
                    <a class="footer-link" onclick="openPrivacyModal()">üîí Aviso de Privacidad</a>
                </div>
            </div>

            <div id="emptyState" class="welcome-container" style="display: none; padding: 30px; margin-top: 20px;">
                <h3>No hay vacantes publicadas üò¢</h3><p>Intenta m√°s tarde o ajusta los filtros.</p>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <div class="modal" id="viewModal"><div class="modal-content"><button class="close-btn" onclick="closeViewModal()">√ó</button><div id="viewModalBody"></div></div></div>

    <div class="modal" id="formModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeFormModal()">√ó</button>
            <h2 id="formTitle">Gestionar Vacante</h2>
            <form id="jobForm" onsubmit="saveJob(event)">
                <div class="form-group"><label>Estatus</label><select id="jobStatus"><option value="Vigente">Vigente (Verde)</option><option value="No Vigente">No Vigente (Rojo)</option></select></div>
                
                <div class="form-group" style="background: #fff8e1; padding: 10px; border-radius: 8px; border: 1px dashed #ffd54f;">
                    <label style="color: #ff8f00;">‚≠ê ¬øImpulsar Vacante? (Top 10)</label>
                    <select id="jobIsFeatured">
                        <option value="false">NO (Normal)</option>
                        <option value="true">S√ç (Destacar)</option>
                    </select>
                </div>

                <div class="form-group"><label>¬øMostrar nombre de empresa al p√∫blico?</label><select id="jobShowCompany"><option value="true">S√ç (Visible para todos)</option><option value="false">NO (Confidencial / Solo Admin)</option></select></div>
                
                <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ef6c00;">
                    <label style="color: #e65100;">üè¢ Tipo de Servicio o Agencia (Interno)</label>
                    <input type="text" id="jobAgency" placeholder="Ej. Agencia Norte - Solo visible para Reclutador">
                </div>
                <div class="form-group"><label>T√≠tulo *</label><input type="text" id="jobTitle" required></div>
                <div class="form-group"><label>Empresa (Nombre Real) *</label><input type="text" id="jobCompany" required placeholder="Escribe el nombre real aqu√≠"></div>
                
                <div class="form-group">
                    <label>Ubicaci√≥n Detallada *</label>
                    <div class="location-grid">
                        <input type="text" id="jobState" placeholder="Estado (Ej. CDMX)" required>
                        <input type="text" id="jobCity" placeholder="Municipio (Ej. Coyoac√°n)" required>
                        <input type="text" id="jobZone" placeholder="Colonia/Zona (Ej. Centro)">
                    </div>
                </div>

                <div class="form-group"><label>Fecha de Publicaci√≥n</label><input type="date" id="jobDate"></div>
                
                <div class="form-group"><label>Salario</label><input type="text" id="jobSalary" placeholder="$8,500/mes"></div>
                <div class="form-group"><label>Descripci√≥n *</label><textarea id="jobDescription" required></textarea></div>
                <div class="form-group"><label>Jornada / Horario</label><input type="text" id="jobSchedule" placeholder="Ej. Lunes a Viernes 9 a 6"></div>
                
                <div class="form-group"><label>Etiquetas</label><input type="text" id="jobTags" placeholder="#Ventas, #Seguros"></div>
                <div class="form-group"><label>Requisitos</label><div class="list-input"><input type="text" id="reqInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('req')">+</button></div><ul class="item-list" id="reqList"></ul></div>
                <div class="form-group"><label>Beneficios</label><div class="list-input"><input type="text" id="benInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('ben')">+</button></div><ul class="item-list" id="benList"></ul></div>
                
                <div class="form-group">
                    <label>WhatsApp Contacto (N√∫mero Real)</label>
                    <div class="phone-group">
                        <select id="jobPhoneCode" class="phone-select">
                            <option value="+52">üá≤üáΩ +52</option>
                            <option value="+1">üá∫üá∏ +1</option>
                            <option value="+57">üá®üá¥ +57</option>
                            <option value="+54">üá¶üá∑ +54</option>
                            <option value="+51">üáµüá™ +51</option>
                            <option value="+34">üá™üá∏ +34</option>
                        </select>
                        <input type="text" id="jobContact" placeholder="10 d√≠gitos (Ej. 5512345678)" style="flex:1;">
                    </div>
                </div>

                <div class="form-actions"><button type="button" class="tool-btn" style="background:#666; width:100%" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary" style="width:100%">Guardar</button></div>
            </form>
        </div>
    </div>

    <div class="modal" id="metricsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeMetricsModal()">√ó</button>
            <h2>üìä Exportar M√©tricas</h2>
            <p style="margin-bottom:10px; color:#666;">Selecciona los meses que deseas incluir en el reporte:</p>
            <div id="metricsMonthList" style="margin: 15px 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background:#f9f9f9;">
                <p style="text-align:center; color:#999;">Cargando historial...</p>
            </div>
            <button class="btn-primary" style="width:100%" onclick="downloadSelectedMetrics()">üì• Descargar Excel Consolidado</button>
        </div>
    </div>

    <div class="modal" id="teamModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeTeamModal()">√ó</button>
            <h2>üë• Equipo de Reclutadores</h2>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div class="form-group"><label>Nombre</label><input type="text" id="recName" placeholder="Ej. Juan P√©rez"></div>
                <div class="form-group">
                    <label>WhatsApp</label>
                    <div class="phone-group">
                        <select id="recPhoneCode" class="phone-select"><option value="+52">üá≤üáΩ +52</option><option value="+1">üá∫üá∏ +1</option><option value="+57">üá®üá¥ +57</option></select>
                        <input type="text" id="recPhone" placeholder="10 d√≠gitos" style="flex:1;">
                    </div>
                </div>
                <div class="form-group"><label>C√≥digo √önico (Link Personal)</label><input type="text" id="recCode" placeholder="Ej. JUAN"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" style="flex:1;" id="btnSaveRecruiter" onclick="saveRecruiter()">Agregar</button>
                    <button class="tool-btn" style="background:#666; display:none;" id="btnCancelRecruiter" onclick="resetRecruiterForm()">Cancelar Edici√≥n</button>
                </div>
            </div>
            <h3>Directorio</h3>
            <div style="overflow-x: auto;">
                <table class="recruiters-table">
                    <thead><tr><th>Nombre</th><th>C√≥digo</th><th>Link</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="recruitersList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            <h2>‚öôÔ∏è Ajustes del Sistema</h2>
            <div class="form-group">
                <label>üìû Tel√©fono Oficina Central (Respaldo)</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="settingsPhoneInput" placeholder="Ej. 5512345678" style="flex:1;">
                    <button class="btn-primary" id="btnSaveCentral" onclick="saveCentralConfig()">Guardar</button>
                </div>
                <p style="font-size:12px; color:#666; margin-top:5px;">Este n√∫mero se usa si la vacante no tiene contacto o est√° mal escrito.</p>
            </div>
            
            <div class="danger-section">
                <h3 style="color:#d32f2f; margin-bottom:10px;">‚ö†Ô∏è Zona de Peligro (Admin)</h3>
                <p style="font-size:13px; color:#666; margin-bottom:10px;">Acciones irreversibles protegidas por contrase√±a.</p>
                <button class="danger-btn" onclick="performSafeAction('resetMetrics')">üóëÔ∏è Resetear M√©tricas (Vistas)</button>
                <button class="danger-btn" onclick="performSafeAction('deleteJobs')">üî• Borrar TODAS las Vacantes</button>
            </div>
        </div>
    </div>

    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closePrivacyModal()">√ó</button>
            <h2>üîí Aviso de Privacidad</h2>
            <p style="line-height:1.6; color:#444;">
                <strong>TuChamba Express</strong> funciona como un enlace directo entre candidatos y reclutadores. 
                No almacenamos curr√≠culums ni datos personales sensibles en nuestros servidores.<br><br>
                Al hacer clic en "Contactar", ser√°s redirigido a WhatsApp, donde la pol√≠tica de privacidad aplicable ser√° la de Meta y la del reclutador contactado.<br><br>
                Las vacantes son responsabilidad exclusiva de las empresas publicantes.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB1k1lnQjQXiGYJRT9E9-KYzGSBBmrQGFI",
          authDomain: "vacancy-page-v2.firebaseapp.com",
          databaseURL: "https://vacancy-page-v2-default-rtdb.firebaseio.com",
          projectId: "vacancy-page-v2",
          storageBucket: "vacancy-page-v2.firebasestorage.app",
          messagingSenderId: "242419485392",
          appId: "1:242419485392:web:c486a767a1810ada876cd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isAdmin = false;
        let currentUserEmail = ""; 
        let currentEditId = null;
        let jobs = {};
        let jobStats = {}; 
        let recruiters = {}; 
        let clickLogs = {};
        
        let activeRecruiter = null; 
        let centralPhone = ''; 
        let editingRecruiterId = null; 

        let tempReqs = [];
        let tempBens = [];
        
        let currentPage = 1;
        const itemsPerPage = 15;
        let currentFilteredJobs = []; 

        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) sessionStorage.setItem('recruiterCode', refCode.toLowerCase());

        // V16.23: Limpieza autom√°tica al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('cityFilter').value = '';
        });

        // V16.23: Limpieza extra al regresar con bot√≥n "Atr√°s" del navegador
        window.onpageshow = function(event) {
            if (event.persisted) {
                document.getElementById('searchInput').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('cityFilter').value = '';
            }
        };

        // V16.26: Cierre con Tecla ESC (UX Master)
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                if(document.getElementById('viewModal').classList.contains('active')) closeViewModal();
                else if(document.getElementById('formModal').classList.contains('active')) closeFormModal();
                else if(document.getElementById('metricsModal').classList.contains('active')) closeMetricsModal();
                else if(document.getElementById('teamModal').classList.contains('active')) closeTeamModal();
                else if(document.getElementById('settingsModal').classList.contains('active')) closeSettingsModal();
                else if(document.getElementById('privacyModal').classList.contains('active')) closePrivacyModal();
                
                // Cerrar men√∫s de administrador
                document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
            }
        });

        onAuthStateChanged(auth, (user) => {
            const urlJobId = urlParams.get('id'); 
            if (user) { 
                isAdmin = true; 
                currentUserEmail = user.email; 
                setAdminMode(true); 
            } else {
                isAdmin = false;
                currentUserEmail = "";
                if (sessionStorage.getItem('isGuest') === 'true' || urlJobId) { 
                    setAdminMode(false); 
                } 
                else { showLogin(); }
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
        }

        window.openMetricsModal = function() {
            document.getElementById('metricsModal').classList.add('active');
            populateMetricsList(); 
        }
        window.closeMetricsModal = function() { document.getElementById('metricsModal').classList.remove('active'); }

        window.openTeamModal = function() { document.getElementById('teamModal').classList.add('active'); resetRecruiterForm(); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

        window.openSettingsModal = function() { document.getElementById('settingsModal').classList.add('active'); if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone; }
        window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.remove('active'); }

        window.openPrivacyModal = function() { document.getElementById('privacyModal').classList.add('active'); }
        window.closePrivacyModal = function() { document.getElementById('privacyModal').classList.remove('active'); }

        // V16.21: MEJORA EN RESET METRICS (Manejo de Errores)
        window.performSafeAction = function(action) {
            if (!isAdmin || !currentUserEmail) {
                alert("Acceso denegado. Debes ser administrador.");
                return;
            }
            if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esta acci√≥n es irreversible.")) {
                if (action === 'resetMetrics') {
                    Promise.all([
                        remove(ref(db, 'siteStats')),
                        remove(ref(db, 'jobStats')),
                        remove(ref(db, 'clickLogs'))
                    ]).then(() => {
                        window.showToast("‚úÖ M√©tricas reseteadas a 0");
                    }).catch(error => {
                        alert("‚ùå Error al borrar: " + error.message + " (Revisa los permisos)");
                    });
                }
                if (action === 'deleteJobs') deleteAllJobs();
            }
        }

        window.showToast = function(message) {
            const x = document.getElementById("toast");
            if(x) {
                x.textContent = message;
                x.className = "show";
                setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
            }
        }

        function deleteAllJobs() {
            remove(ref(db, 'jobs')).then(() => {
                window.showToast("üî• Todas las vacantes eliminadas");
            });
        }

        window.toggleMobileFilters = function() {
            const container = document.getElementById('filterContainer');
            container.classList.toggle('active');
        }

        window.toggleAdminLogin = function() { const f = document.getElementById('adminForm'); f.style.display = (f.style.display==='none'||f.style.display==='') ? 'block' : 'none'; }
        
        window.login = async function() {
            try { 
                await setPersistence(auth, browserSessionPersistence); 
                await signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPassword').value); 
                sessionStorage.removeItem('isGuest'); 
                localStorage.setItem('iamsuperadmin', 'true'); 
            } catch (error) { alert("Error: " + error.message); }
        }
        
        // V16.23: Limpieza al entrar como invitado
        window.enterAsGuest = function() { 
            sessionStorage.setItem('isGuest', 'true'); 
            isAdmin = false; 
            
            // LIMPIEZA FORZADA
            document.getElementById('searchInput').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('cityFilter').value = '';

            setAdminMode(false); 
        }

        // V16.23: Limpieza al cerrar sesi√≥n
        window.logout = function() { 
            signOut(auth).then(() => { 
                sessionStorage.removeItem('isGuest'); 
                isAdmin = false; 
                
                // LIMPIEZA FORZADA
                document.getElementById('searchInput').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('cityFilter').value = '';

                showLogin(); 
            }); 
        }

        function showLogin() { document.getElementById('loginScreen').style.display = 'block'; document.getElementById('mainApp').style.display = 'none'; document.getElementById('adminForm').style.display = 'none'; }
        function setAdminMode(enableAdmin) {
            document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block';
            
            const isRefMode = !!refCode;
            if (enableAdmin && !isRefMode) {
                document.getElementById('modeIndicator').innerHTML = '<span class="admin-mode-indicator">Super Admin</span>';
                document.getElementById('adminControls').style.display = 'block';
            } else {
                document.getElementById('modeIndicator').innerHTML = '';
                document.getElementById('adminControls').style.display = 'none';
            }
            loadData();
        }

        function parseJobDate(dateString) {
            if (!dateString) return 0;
            let jobDate;
            if (dateString.includes('/')) { 
                const parts = dateString.split('/');
                if (parts.length === 3) jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
            } else if (dateString.includes('-')) { 
                const parts = dateString.split('-');
                if (parts.length === 3) jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
            }
            return jobDate && !isNaN(jobDate.getTime()) ? jobDate.getTime() : 0;
        }

        function loadData() {
            onValue(ref(db, 'jobs'), (s) => { 
                jobs = s.val() || {}; 
                document.getElementById('skeletonLoader').style.display = 'none'; 
                document.getElementById('jobGrid').style.display = 'grid';
                populateFilters(jobs); 
                renderJobs(); 
                
                const urlJobId = urlParams.get('id');
                if (urlJobId && jobs[urlJobId]) {
                    const job = jobs[urlJobId];
                    if (job.status !== 'No Vigente' || isAdmin) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        if(!isAdmin) sessionStorage.setItem('isGuest', 'true');
                        window.openViewModal(urlJobId);
                    } else {
                        window.showToast("‚ö†Ô∏è Esta vacante ya no est√° disponible.");
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            });
            onValue(ref(db, 'jobStats'), (s) => { jobStats = s.val() || {}; });
            onValue(ref(db, 'clickLogs'), (s) => { clickLogs = s.val() || {}; });
            
            onValue(ref(db, 'recruiters'), (s) => { 
                recruiters = s.val() || {}; 
                checkActiveRecruiter(); 
                if(isAdmin) renderRecruitersTable(); 
            });
            
            onValue(ref(db, 'settings/centralPhone'), (s) => { 
                centralPhone = s.val() || '';
                if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone;
                updateBanner();
            });
        }

        function populateFilters(jobsData) {
            const allJobsArr = Object.values(jobsData);
            const stateSelect = document.getElementById('stateFilter');
            const citySelect = document.getElementById('cityFilter');

            const uniqueStates = [...new Set(allJobsArr.map(j => j.state).filter(Boolean))].sort();
            const uniqueCities = [...new Set(allJobsArr.map(j => j.city).filter(Boolean))].sort();
            
            const currState = stateSelect.value;
            const currCity = citySelect.value;

            stateSelect.innerHTML = '<option value="">üìç Estado</option>';
            uniqueStates.forEach(s => {
                stateSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            citySelect.innerHTML = '<option value="">üèôÔ∏è Municipio</option>';
            uniqueCities.forEach(c => {
                 citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            if(uniqueStates.includes(currState)) stateSelect.value = currState;
            if(uniqueCities.includes(currCity)) citySelect.value = currCity;
        }

        function checkActiveRecruiter() {
            const savedCode = sessionStorage.getItem('recruiterCode');
            activeRecruiter = null; 
            if (savedCode && recruiters) {
                const foundKey = Object.keys(recruiters).find(key => recruiters[key].code.toLowerCase() === savedCode);
                if (foundKey) { 
                    activeRecruiter = recruiters[foundKey]; 
                }
            }
            updateBanner();
        }

        function updateBanner() {
            const bannerName = document.getElementById('recruiterNameDisplay');
            if(activeRecruiter) {
                bannerName.textContent = activeRecruiter.name;
            } else {
                bannerName.textContent = "Oficina Central";
            }
        }

        window.contactCentralOffice = function() {
            let phoneToContact = '';
            if(activeRecruiter) {
                phoneToContact = activeRecruiter.phone;
            } else {
                phoneToContact = centralPhone;
            }

            if(phoneToContact) {
                const cleanPhone = phoneToContact.replace(/\D/g, '');
                window.open(`https://wa.me/${cleanPhone}?text=Hola,%20necesito%20ayuda%20general`, '_blank');
            } else {
                alert("No hay un n√∫mero de contacto general configurado.");
            }
        }

        window.saveCentralConfig = function() {
            const val = document.getElementById('settingsPhoneInput').value.trim();
            const btn = document.getElementById('btnSaveCentral');
            const originalText = btn.textContent;
            
            btn.textContent = "Guardando...";
            set(ref(db, 'settings/centralPhone'), val)
                .then(() => {
                    window.showToast('‚úÖ Tel√©fono de Oficina Central actualizado.');
                    btn.style.backgroundColor = '#2ecc71'; 
                    btn.textContent = '‚úÖ ¬°Guardado!';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                })
                .catch((error) => {
                    window.showToast('‚ùå Error al guardar: ' + error.message);
                    btn.style.backgroundColor = '#e74c3c'; btn.textContent = 'Error';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                });
        }

        window.openTeamModal = function() { document.getElementById('teamModal').classList.add('active'); resetRecruiterForm(); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

        window.saveRecruiter = function() {
            const name = document.getElementById('recName').value.trim();
            const rawPhone = document.getElementById('recPhone').value.trim();
            const phoneCode = document.getElementById('recPhoneCode').value;
            const code = document.getElementById('recCode').value.toUpperCase().replace(/\s/g, '');
            
            if(!name || !rawPhone || !code) return alert('Por favor, llena todos los campos.');
            
            let cleanPhone = rawPhone.replace(/\D/g, '');
            const codeDigits = phoneCode.replace('+', '');
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            
            const finalPhone = phoneCode + cleanPhone;

            const duplicateCheck = Object.entries(recruiters).find(([key, r]) => { return r.code === code && key !== editingRecruiterId; });
            if (duplicateCheck) { return alert(`‚ö†Ô∏è ERROR: El c√≥digo '${code}' ya est√° siendo usado por ${duplicateCheck[1].name}. Usa otro.`); }
            
            const idToSave = editingRecruiterId || 'rec-' + Date.now();
            set(ref(db, 'recruiters/' + idToSave), { name, phone: finalPhone, code }).then(() => { window.showToast(editingRecruiterId ? '‚úÖ Reclutador actualizado' : '‚úÖ Reclutador agregado'); resetRecruiterForm(); });
        }

        window.editRecruiter = function(id) {
            const r = recruiters[id]; if(!r) return;
            document.getElementById('recName').value = r.name; 
            
            let phoneVal = r.phone;
            if(phoneVal.startsWith('+52')) { document.getElementById('recPhoneCode').value = '+52'; phoneVal = phoneVal.replace('+52',''); }
            else if(phoneVal.startsWith('+1')) { document.getElementById('recPhoneCode').value = '+1'; phoneVal = phoneVal.replace('+1',''); }
            document.getElementById('recPhone').value = phoneVal; 

            document.getElementById('recCode').value = r.code;
            editingRecruiterId = id; const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Guardar Cambios"; btn.style.backgroundColor = "#f57c00"; 
            document.getElementById('btnCancelRecruiter').style.display = 'block';
        }

        window.resetRecruiterForm = function() {
            document.getElementById('recName').value = ''; document.getElementById('recPhone').value = ''; document.getElementById('recCode').value = ''; editingRecruiterId = null;
            const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Agregar"; btn.style.backgroundColor = "#0a66c2"; 
            document.getElementById('btnCancelRecruiter').style.display = 'none';
        }

        window.deleteRecruiter = function(id) { if(confirm('¬øSeguro que quieres eliminar a este reclutador?')) { remove(ref(db, 'recruiters/' + id)); if(editingRecruiterId === id) resetRecruiterForm(); } }
        
        window.copyLink = function(code) { 
            const link = `${window.location.origin}/?ref=${code}`; 
            navigator.clipboard.writeText(link).then(() => window.showToast('Link copiado')); 
        }
        
        function renderRecruitersTable() {
            const list = document.getElementById('recruitersList');
            if(Object.keys(recruiters).length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay reclutadores</td></tr>'; return; }
            list.innerHTML = Object.keys(recruiters).map(key => { 
                const r = recruiters[key]; 
                return `<tr><td>${r.name}</td><td><b>${r.code}</b></td><td><button class="copy-btn" onclick="copyLink('${r.code}')">Copiar</button></td><td><button onclick="editRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">‚úèÔ∏è</button><button onclick="deleteRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">üóëÔ∏è</button></td></tr>`; 
            }).join('');
        }

        function populateMetricsList() {
            const list = document.getElementById('metricsMonthList');
            if(!jobStats) { list.innerHTML = 'No hay datos'; return; }
            
            const months = new Set();
            // Wrap in try-catch/checks to prevent freeze if data is bad
            Object.values(clickLogs).forEach(log => {
                if(log && log.timestamp && typeof log.timestamp === 'string') {
                    try { months.add(log.timestamp.substring(0, 7)); } catch(e){}
                }
            });
            Object.values(jobStats).forEach(stat => {
                if(stat && stat.monthlyViews) {
                    Object.keys(stat.monthlyViews).forEach(m => months.add(m));
                }
            });

            if(months.size === 0) months.add(currentMonthKey);

            const sortedMonths = Array.from(months).sort().reverse();
            
            list.innerHTML = sortedMonths.map(m => 
                `<label style="display:block; padding:5px; border-bottom:1px solid #eee;">
                    <input type="checkbox" value="${m}" checked> ${m}
                </label>`
            ).join('');
        }

        // V16.21 FIX: FORZAR CREACI√ìN DE HOJAS AUNQUE EST√âN VAC√çAS
        window.downloadSelectedMetrics = function() {
            const checkboxes = document.querySelectorAll('#metricsMonthList input:checked');
            const selectedMonths = Array.from(checkboxes).map(cb => cb.value);
            
            if(selectedMonths.length === 0) return alert("Selecciona al menos un mes");

            const dataRows = [];
            
            Object.keys(jobs).forEach(jobId => {
                const j = jobs[jobId];
                const s = jobStats[jobId] || {};
                
                let totalViews = 0;
                let totalClicks = 0;

                selectedMonths.forEach(m => {
                    if(s.monthlyViews && s.monthlyViews[m]) {
                        totalViews += s.monthlyViews[m];
                    }
                });
                
                const clicksInMonths = Object.values(clickLogs).filter(l => 
                    l && l.jobId === jobId && 
                    l.timestamp && typeof l.timestamp === 'string' &&
                    selectedMonths.includes(l.timestamp.substring(0,7))
                ).length;

                dataRows.push({
                    'ID': jobId,
                    'T√≠tulo': j.title,
                    'Empresa': j.company,
                    'Vistas (Meses selecc.)': totalViews,
                    'Clics WhatsApp (Meses selecc.)': clicksInMonths,
                    'Estatus': j.status
                });
            });

            // LOGICA MEJORADA DE HOJAS
            const wb = XLSX.utils.book_new();
            
            // Hoja 1: Vacantes (Siempre tiene datos aunque sean ceros)
            const ws1 = XLSX.utils.json_to_sheet(dataRows);
            XLSX.utils.book_append_sheet(wb, ws1, "Desempe√±o Vacantes");

            // Hoja 2: Reclutadores (Puede estar vac√≠a)
            const recruiterMap = {};
            let totalRecruiterClicks = 0;
            Object.values(clickLogs).forEach(l => {
                if(l && l.timestamp && typeof l.timestamp === 'string' && selectedMonths.includes(l.timestamp.substring(0,7))) {
                    const recName = l.recruiter || 'Org√°nico';
                    if(!recruiterMap[recName]) recruiterMap[recName] = 0;
                    recruiterMap[recName]++;
                    totalRecruiterClicks++;
                }
            });
            let recruiterRows = Object.keys(recruiterMap).map(name => ({
                'Reclutador': name,
                'Clics Generados': recruiterMap[name],
                '% del Total': totalRecruiterClicks > 0 ? ((recruiterMap[name] / totalRecruiterClicks) * 100).toFixed(2) + '%' : '0%'
            }));
            
            // SI EST√Å VAC√çA, AGREGAR FILA DUMMY PARA QUE EXCEL NO OCULTE LA HOJA
            if (recruiterRows.length === 0) {
                recruiterRows = [{'Reclutador': 'Sin datos en este periodo', 'Clics Generados': 0, '% del Total': '0%'}];
            }
            const ws2 = XLSX.utils.json_to_sheet(recruiterRows);
            XLSX.utils.book_append_sheet(wb, ws2, "Rendimiento Equipo");

            // Hoja 3: Resumen
            const summaryRows = [
                { 'M√©trica': 'Periodo Analizado', 'Valor': selectedMonths.join(', ') },
                { 'M√©trica': 'Total Vistas', 'Valor': dataRows.reduce((a,b)=>a+b['Vistas (Meses selecc.)'],0) },
                { 'M√©trica': 'Total Clics (Leads)', 'Valor': dataRows.reduce((a,b)=>a+b['Clics WhatsApp (Meses selecc.)'],0) }
            ];
            const ws3 = XLSX.utils.json_to_sheet(summaryRows);
            XLSX.utils.book_append_sheet(wb, ws3, "Resumen Global");

            XLSX.writeFile(wb, `Reporte_TuChamba_${selectedMonths.join('_')}.xlsx`);
        }

        window.handleWhatsAppClick = function(btn, jobId, recruiterName, link) {
            const clickedKey = `clic_${jobId}_${new Date().toISOString().split('T')[0]}`; 
            const alreadyClicked = localStorage.getItem(clickedKey);

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Abriendo...';

            if (!alreadyClicked) {
                console.log("‚úÖ Nuevo interesado detectado");
                localStorage.setItem(clickedKey, 'true');
                window.registerClick(jobId, recruiterName);
            } else {
                console.log("‚ö†Ô∏è Clic repetido (Ignorado)");
            }

            setTimeout(() => { window.open(link, '_blank'); }, 300); 
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000);
        }

        window.registerClick = function(jobId, recruiterName) {
            runTransaction(ref(db, `jobStats/${jobId}/whatsappClicks`), (c) => (c || 0) + 1);
            push(ref(db, 'clickLogs'), { jobId, recruiter: recruiterName || 'Org√°nico', timestamp: new Date().toISOString(), date_readable: new Date().toLocaleString() });
        }

        // V16.25: FUNCI√ìN DE GENERAR FLYER MARKETING VISUAL (Fondo imagen + Badge + Caja blanca)
        window.generateFlyer = function(jobId) {
            const j = jobs[jobId];
            if (!j) return;

            window.showToast("üé® Creando Flyer...");

            // Llenar el molde oculto
            document.getElementById('flyerTitle').innerText = j.title;
            document.getElementById('flyerSalary').innerText = j.salary || 'Sueldo Competitivo';
            document.getElementById('flyerLocation').innerText = j.city + (j.state ? `, ${j.state}` : '');
            
            // Limpiar tel√©fono para mostrar
            let phoneShow = j.contact || centralPhone;
            phoneShow = phoneShow.replace(/^\+52/, '').replace(/(\d{2})(\d{4})(\d{4})/, '$1 $2 $3');
            document.getElementById('flyerPhone').innerText = phoneShow;

            // Tomar foto al molde con mejor calidad
            const flyerNode = document.getElementById('flyerTemplate');
            html2canvas(flyerNode, { 
                scale: 2, // Mayor resoluci√≥n
                useCORS: true, // Permitir imagen externa
                backgroundColor: null // Respetar el fondo CSS
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Flyer_${j.title.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
                window.showToast("‚úÖ ¬°Flyer descargado!");
            }).catch(err => {
                console.error(err);
                alert("Error al generar imagen. Verifica tu conexi√≥n.");
            });
        }

        const visitsRef = ref(db, 'siteStats/visits');
        const monthlyRef = ref(db, `siteStats/monthly/${currentMonthKey}`);
        
        const isMyDevice = localStorage.getItem('iamsuperadmin');
        const alreadyVisited = localStorage.getItem('visited_v2');

        if (!alreadyVisited && !isMyDevice) { 
            runTransaction(visitsRef, (c) => (c || 0) + 1); 
            runTransaction(monthlyRef, (c) => (c || 0) + 1); 
            localStorage.setItem('visited_v2', 'true'); 
        }
        
        onValue(visitsRef, (s) => { if(document.getElementById('totalVisits')) document.getElementById('totalVisits').innerText = s.val() || 0; });
        onValue(monthlyRef, (s) => { if(document.getElementById('monthlyVisits')) document.getElementById('monthlyVisits').innerText = s.val() || 0; });

        window.saveJob = function(e) {
            e.preventDefault();
            
            const phoneCode = document.getElementById('jobPhoneCode').value;
            const rawPhone = document.getElementById('jobContact').value.trim();
            
            let cleanPhone = rawPhone.replace(/\D/g, '');
            const codeDigits = phoneCode.replace('+', '');
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            const finalPhone = cleanPhone ? (phoneCode + cleanPhone) : '';

            // V16.27: Leer campo destacado manual
            const isFeaturedVal = document.getElementById('jobIsFeatured').value === 'true';

            const jobData = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                showCompany: document.getElementById('jobShowCompany').value === 'true', 
                state: document.getElementById('jobState').value,
                city: document.getElementById('jobCity').value,
                zone: document.getElementById('jobZone').value,
                location: `${document.getElementById('jobCity').value}, ${document.getElementById('jobState').value}`,
                
                fecha: document.getElementById('jobDate').value, 
                
                salary: document.getElementById('jobSalary').value,
                description: document.getElementById('jobDescription').value,
                schedule: document.getElementById('jobSchedule').value, 
                tags: document.getElementById('jobTags').value,
                contact: finalPhone, 
                status: document.getElementById('jobStatus').value,
                agency: document.getElementById('jobAgency').value,
                requirements: tempReqs,
                benefits: tempBens,
                isFeatured: isFeaturedVal // Guardar el flag
            };
            const id = currentEditId || 'job-' + Date.now();
            set(ref(db, 'jobs/' + id), jobData).then(() => {
                window.showToast("‚úÖ Vacante guardada");
                window.closeFormModal();
            });
        }

        window.deleteJob = function(id) { if(confirm('¬øBorrar vacante?')) remove(ref(db, 'jobs/' + id)); }

        function normalizeText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : ""; }

        function formatDateFriendly(dateString) {
            return dateString || '';
        }

        function isNewJob(dateString) {
            if (!dateString) return false;
            let jobDate;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } 
            else if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }
            }

            if (!jobDate || isNaN(jobDate.getTime())) return false;

            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const diffTime = Math.abs(today - jobDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays <= 3;
        }

        function renderJobs() {
            let keys = Object.keys(jobs);
            
            keys.sort((a, b) => {
                const jobA = jobs[a]; const jobB = jobs[b];
                const statusA = jobA.status === 'No Vigente' ? 1 : 0;
                const statusB = jobB.status === 'No Vigente' ? 1 : 0;
                if (statusA !== statusB) return statusA - statusB;
                
                // V16.27: Ordenar primero las destacadas
                const featA = jobA.isFeatured ? 1 : 0;
                const featB = jobB.isFeatured ? 1 : 0;
                if (featA !== featB) return featB - featA; // Destacadas primero

                const dateA = parseJobDate(jobA.fecha);
                const dateB = parseJobDate(jobB.fecha);
                
                if (dateA !== dateB) {
                    return dateB - dateA; 
                }
                return b.localeCompare(a); 
            });

            currentFilteredJobs = keys; 
            currentPage = 1; 
            applyFilterAndRender();
        }

        window.clearSearch = function() {
            document.getElementById('searchInput').value = '';
            filterJobs();
            document.getElementById('searchInput').focus();
        }

        function applyFilterAndRender() {
            const stateVal = document.getElementById('stateFilter').value;
            const cityVal = document.getElementById('cityFilter').value;
            const searchInput = document.getElementById('searchInput');
            const searchText = normalizeText(searchInput.value);
            
            const clearBtn = document.getElementById('clearSearchBtn');
            clearBtn.style.display = searchText.length > 0 ? 'flex' : 'none';

            const matchedKeys = currentFilteredJobs.filter(id => {
                const j = jobs[id];
                if (!isAdmin && j.status === 'No Vigente') return false;

                const matchState = stateVal === '' || j.state === stateVal;
                const matchCity = cityVal === '' || j.city === cityVal;
                
                let matchSearch = true;
                if(searchText) {
                    const fullText = normalizeText(`${j.title} ${j.company} ${j.tags} ${j.description}`);
                    matchSearch = fullText.includes(searchText);
                }

                return matchState && matchCity && matchSearch;
            });

            document.getElementById('jobCounter').textContent = `${matchedKeys.length} vacantes encontradas`;
            
            if (matchedKeys.length === 0) {
                document.getElementById('jobGrid').innerHTML = '';
                document.getElementById('paginationContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            const totalPages = Math.ceil(matchedKeys.length / itemsPerPage);
            if(currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const visibleKeys = matchedKeys.slice(startIndex, endIndex);

            const grid = document.getElementById('jobGrid');
            grid.innerHTML = visibleKeys.map(id => {
                const j = jobs[id];
                const tags = j.tags ? j.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                const isVigente = j.status !== 'No Vigente';
                
                let statusBadge = '<span class="badge-closed">Cerrada</span>';
                if(isVigente) statusBadge = '<span class="badge-vigente">üü¢ Vigente</span>';

                const showAdminButtons = isAdmin && !refCode;
                const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
                const finalCompanyName = (isAdmin && !refCode) || showNamePublicly ? j.company : "Empresa Confidencial";
                let displayLocation = j.location;
                if (j.city && j.state) displayLocation = `${j.city}, ${j.state}`;

                const niceDate = formatDateFriendly(j.fecha);
                const dateHtml = niceDate ? `<span class="card-header-date">üìÖ Publicaci√≥n: ${niceDate}</span>` : '';
                const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">üî• Nueva</span>' : '';

                // V16.27: BADGE DE TOP VACANTE (Opci√≥n A)
                const featuredBadge = j.isFeatured ? '<div class="badge-featured">‚≠ê TOP VACANTE</div>' : '';

                return `
                    <div class="job-card" onclick="window.openViewModal('${id}')">
                        ${featuredBadge}
                        ${showAdminButtons ? `<button class="more-btn" onclick="event.stopPropagation(); window.toggleMenu('${id}')">‚ãÆ</button>
                        <div class="admin-actions" id="menu-${id}">
                            <button class="admin-action" onclick="event.stopPropagation(); window.editJob('${id}')">‚úèÔ∏è Editar</button>
                            <button class="admin-action" onclick="event.stopPropagation(); window.generateFlyer('${id}')">üñºÔ∏è Descargar Flyer</button>
                            <button class="admin-action delete" onclick="event.stopPropagation(); window.deleteJob('${id}')">üóëÔ∏è Eliminar</button>
                        </div>` : ''}
                        
                        <div class="card-header-top">
                            <div>
                                ${statusBadge}
                                ${newBadge}
                            </div>
                        </div>
                        ${dateHtml}
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px; margin-top: 10px;">
                            <div class="company-logo">${j.company.charAt(0)}</div>
                            <div>
                                <div class="job-title">${j.title}</div>
                                <div class="company-name">${finalCompanyName}</div>
                            </div>
                        </div>
                        
                        <div class="location">üìç ${displayLocation}</div>
                        <div class="salary-text">üí∞ ${j.salary || 'A convenir'}</div>
                        
                        ${tags.length > 0 ? `<div class="tags">${tags.slice(0,3).map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            }).join('');

            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            const container = document.getElementById('paginationContainer');
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';
            
            let html = '';
            
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span style="color:#999;">...</span>`;
                }
            }

            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente &raquo;</button>`;
            
            html += `<div class="page-info">P√°gina ${currentPage} de ${totalPages}</div>`;
            
            container.innerHTML = html;
        }

        window.changePage = function(newPage) {
            currentPage = newPage;
            applyFilterAndRender();
            document.querySelector('.search-container').scrollIntoView({ behavior: 'smooth' });
        }

        window.filterJobs = function() {
            currentPage = 1; 
            applyFilterAndRender();
        }

        window.loadMoreJobs = function() {
            displayLimit += 20;
            applyFilterAndRender();
        }

        window.toggleMenu = function(id) { 
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active')); 
            document.getElementById(`menu-${id}`).classList.toggle('active'); 
        }

        window.openViewModal = function(id) {
            const j = jobs[id];
            const isRefMode = !!refCode;

            if (!isAdmin || isRefMode) {
                runTransaction(ref(db, `jobStats/${id}/totalViews`), (c) => (c || 0) + 1);
                runTransaction(ref(db, `jobStats/${id}/monthlyViews/${currentMonthKey}`), (c) => (c || 0) + 1);
            }
            
            document.title = `Trabajo en ${j.city || 'M√©xico'} - ${j.title} | TuChamba`;

            const stats = jobStats[id] || {};
            const totalViews = stats.totalViews || 0;
            const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
            const companyDisplay = (isAdmin && !isRefMode) || showNamePublicly ? j.company : "Empresa Confidencial";
            
            let contactHtml = '';
            let targetPhone = '';
            let isReferral = false;

            let excelContact = j.contact ? j.contact.replace(/\D/g, '') : '';
            let isExcelContactValid = excelContact.length >= 10;

            if (activeRecruiter) { 
                targetPhone = activeRecruiter.phone; 
                isReferral = true; 
            } 
            else if (isExcelContactValid) { 
                targetPhone = excelContact; 
            } 
            else if (centralPhone) { 
                targetPhone = centralPhone.replace(/\D/g, ''); 
            }

            if (targetPhone) {
                let msg = `Hola, vi la vacante ${j.title} (C√≥d: ${id})`;
                if(isReferral) msg += ` (Referido por ${activeRecruiter.name})`;
                const waLink = `https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`;
                const recNameSafe = activeRecruiter ? activeRecruiter.name : 'Org√°nico';
                
                contactHtml = `<div class="sticky-footer">
                                    <p style="font-size:12px; color:#666; margin-bottom:5px;">üëá Respuesta Inmediata üëá</p>
                                    <button onclick="window.handleWhatsAppClick(this, '${id}', '${recNameSafe}', '${waLink}')" class="whatsapp-btn-large">
                                        üìÖ Agenda Entrevista Ahora üì≤
                                    </button>
                               </div>`;
            }

            let adminInfoHtml = '';
            if (isAdmin && !isRefMode) {
                adminInfoHtml = `<div style="display:flex; flex-wrap:wrap; gap:10px;">
                        <div class="view-count-badge">üëÅÔ∏è ${totalViews} Vistas</div>
                        <div class="agency-badge">${j.agency || 'Sin asignar'}</div>
                    </div>`;
            }

            let locationDetail = j.location;
            if (j.state && j.city) locationDetail = `${j.city}, ${j.state} ${j.zone ? '('+j.zone+')' : ''}`;
            
            const isVigente = j.status !== 'No Vigente';
            const badgeHtml = isVigente ? '<span class="badge-vigente">üü¢ Vigente</span>' : '<span class="badge-closed">Cerrada</span>';
            const niceDate = formatDateFriendly(j.fecha);
            const dateHtml = niceDate ? `<span class="card-header-date">üìÖ Publicaci√≥n: ${niceDate}</span>` : '';
            const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">üî• Nueva</span>' : '';

            const shareUrl = `${window.location.origin}/?id=${id}${refCode ? '&ref='+refCode : ''}`;
            
            document.getElementById('viewModalBody').innerHTML = `
                ${adminInfoHtml}
                
                <div class="card-header-top">
                    <div>
                        ${badgeHtml}
                        ${newBadge}
                    </div>
                </div>
                ${dateHtml}

                <div style="display: flex; justify-content: space-between; align-items: start; margin-top: 15px;">
                    <h2 style="font-size: 24px; margin-bottom: 5px; color:#333; flex:1;">${j.title}</h2>
                    <button class="tool-btn" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => window.showToast('üîó Link copiado'))" style="padding: 5px 10px; font-size: 12px;">üîó Copiar Link</button>
                </div>
                
                <div style="font-size: 18px; color: #0a66c2; margin-bottom: 20px;">${companyDisplay}</div>

                <div class="job-details">
                    <div class="detail-item">üìç ${locationDetail}</div>
                    <div class="detail-item salary-text">üí∞ ${j.salary || 'A convenir'}</div>
                    <div class="detail-item">üïí ${j.schedule || 'Horario a definir'}</div>
                </div>

                <div class="section-title">Descripci√≥n</div>
                <p style="color: #444; line-height: 1.6;">${j.description}</p>
                ${(j.requirements||[]).length ? `<div class="section-title">Requisitos</div><ul class="item-list">${j.requirements.map(r=>`<li>${r}</li>`).join('')}</ul>` : ''}
                ${(j.benefits||[]).length ? `<div class="section-title">Beneficios</div><ul class="item-list">${j.benefits.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
                
                ${contactHtml}
            `;
            document.getElementById('viewModal').classList.add('active');
        }

        window.closeViewModal = function() { 
            document.title = "TuChamba Express | Vacantes Urgentes en Nuevo Le√≥n, CDMX y EdoMex 2026";
            document.getElementById('viewModal').classList.remove('active'); 
        }
        window.closeFormModal = function() { document.getElementById('formModal').classList.remove('active'); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }
        
        window.openJobForm = function() {
            currentEditId = null; document.getElementById('formTitle').textContent = 'Nueva Vacante'; document.getElementById('jobForm').reset();
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('jobDate').value = todayISO; 
            
            tempReqs = []; tempBens = []; updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('jobShowCompany').value = 'true';
            
            // Reset manual de featured
            document.getElementById('jobIsFeatured').value = 'false';

            document.getElementById('formModal').classList.add('active');
        }

        window.editJob = function(id) {
            currentEditId = id; const j = jobs[id];
            document.getElementById('formTitle').textContent = 'Editar Vacante';
            document.getElementById('jobTitle').value = j.title; document.getElementById('jobCompany').value = j.company;
            document.getElementById('jobShowCompany').value = (j.showCompany === false || j.showCompany === 'false') ? 'false' : 'true';
            document.getElementById('jobState').value = j.state || '';
            document.getElementById('jobCity').value = j.city || '';
            document.getElementById('jobZone').value = j.zone || '';
            
            document.getElementById('jobDate').value = j.fecha || ''; 

            if(!j.city && j.location) document.getElementById('jobCity').value = j.location;
            document.getElementById('jobSalary').value = j.salary||'';
            document.getElementById('jobDescription').value = j.description; document.getElementById('jobStatus').value = j.status||'Vigente';
            document.getElementById('jobAgency').value = j.agency||'';
            
            // V16.27: Cargar valor de featured
            document.getElementById('jobIsFeatured').value = j.isFeatured ? 'true' : 'false';

            let contactVal = j.contact || '';
            let codeVal = '+52';
            if(contactVal.startsWith('+52')) { codeVal = '+52'; contactVal = contactVal.replace('+52',''); }
            else if(contactVal.startsWith('+1')) { codeVal = '+1'; contactVal = contactVal.replace('+1',''); }
            document.getElementById('jobPhoneCode').value = codeVal;
            document.getElementById('jobContact').value = contactVal;

            document.getElementById('jobSchedule').value = j.schedule||''; 
            tempReqs = j.requirements||[]; tempBens = j.benefits||[];
            updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('formModal').classList.add('active');
        }

        window.addItem = function(type) {
            const val = document.getElementById(type+'Input').value.trim();
            if(val) { (type==='req'?tempReqs:tempBens).push(val); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); document.getElementById(type+'Input').value=''; }
        }
        window.removeItem = function(type, i) { (type==='req'?tempReqs:tempBens).splice(i,1); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); }
        function updateList(id, arr, type) { document.getElementById(id).innerHTML = arr.map((item,i)=>`<li>${item}<button onclick="removeItem('${type}',${i})" style="color:red;border:none;background:none;cursor:pointer">√ó</button></li>`).join(''); }

        window.exportToExcel = function() {
            if(!Object.keys(jobs).length) return alert('Sin datos');
            const data = Object.keys(jobs).map(id => {
                const j = jobs[id];
                return { 
                    'ID': id, 'T√≠tulo': j.title, 'Empresa': j.company, 
                    'Mostrar Empresa Publicamente': (j.showCompany === true || j.showCompany === 'true') ? 'SI' : 'NO',
                    'Estado': j.state, 'Municipio': j.city, 'Zona': j.zone, 
                    'Fecha': j.fecha, 
                    'Salario': j.salary, 'Descripci√≥n': j.description, 
                    'Jornada': j.schedule, 
                    'Etiquetas': j.tags,
                    'Requisitos': (j.requirements||[]).join(' | '), 
                    'Beneficios': (j.benefits||[]).join(' | '),
                    'Contacto': j.contact, 'Estatus': j.status, 'Tipo de Servicio o Agencia': j.agency,
                    'IMPULSAR': j.isFeatured ? 'SI' : 'NO' // V16.27
                };
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Vacantes"); XLSX.writeFile(wb, "Respaldo_Completo.xlsx");
        }

        window.downloadTemplate = function() {
            const data = [{
                'ID': 'ej-1', 
                'FECHA': '15/01/2026', 
                'T√çTULO': 'Ejemplo', 
                'EMPRESA': 'Empresa', 
                'MOSTRAR EMPRESA PUBLICAMENTE': 'SI',
                'ESTADO': 'CDMX', 
                'MUNICIPIO': 'Coyoac√°n', 
                'ZONA': 'Centro',
                'SALARIO': '10000', 
                'DESCRIPCI√ìN': 'Desc...', 
                'JORNADA': 'Lunes a Viernes', 
                'ETIQUETAS': '#Ventas', 
                'REQUISITOS': 'Req 1 | Req 2', 
                'BENEFICIOS': 'Ben 1 | Ben 2', 
                'CONTACTO': '5512345678', 
                'ESTATUS': 'Vigente', 
                'TIPO DE SERVICIO O AGENCIA': 'Agencia Interna',
                'IMPULSAR': 'SI' // V16.27
            }];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla'); XLSX.writeFile(wb, 'plantilla.xlsx');
        }

        window.shareApp = async function() {
             const refCode = sessionStorage.getItem('recruiterCode');
             const encodedRef = refCode ? encodeURIComponent(refCode) : '';
             const url = encodedRef ? `${window.location.origin}/?ref=${encodedRef}` : window.location.href;
             
             const data = { 
                 title: 'TuChamba', 
                 text: '¬°Checa esta vacante! Contrataci√≥n r√°pida en CDMX, NL y EdoMex. Detalles aqu√≠:', 
                 url: url 
             };
             if(navigator.share) await navigator.share(data); else window.open(`https://wa.me/?text=${encodeURIComponent(data.text+' '+data.url)}`);
        }
        
        window.importFromExcel = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    if(!json.length) { alert('Archivo vac√≠o'); return; }
                    let count = 0;
                    
                    const normalizeKey = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

                    const findKey = (row, keyName) => {
                        return Object.keys(row).find(k => normalizeKey(k) === normalizeKey(keyName));
                    };

                    json.forEach((row, i) => {
                         const titleKey = findKey(row, 't√≠tulo');
                         const companyKey = findKey(row, 'empresa');
                         
                         const title = titleKey ? row[titleKey] : null;
                         const company = companyKey ? row[companyKey] : null;
                         
                         if(!title || !company) return;
                         
                         const id = row['ID'] || 'job-'+Date.now()+'-'+i;
                         const state = row[findKey(row, 'estado')] || ''; 
                         const city = row[findKey(row, 'municipio')] || ''; 
                         const zone = row[findKey(row, 'zona')] || '';
                         const legacyLoc = row['Ubicaci√≥n'] || ''; 

                         const showCompKey = findKey(row, 'mostrar empresa publicamente');
                         const showCompanyRaw = showCompKey ? row[showCompKey] : 'SI';

                         // V16.27: Detectar columna IMPULSAR o DESTACAR
                         const featuredKey = findKey(row, 'impulsar') || findKey(row, 'destacar') || findKey(row, 'top');
                         const isFeaturedRaw = featuredKey ? row[featuredKey] : 'NO';

                         let contactRaw = row[findKey(row, 'contacto')] || '';
                         contactRaw = String(contactRaw).replace(/\D/g, ''); 
                         
                         if(contactRaw.length === 10) {
                             contactRaw = '+52' + contactRaw;
                         } else if (contactRaw.length > 10 && !contactRaw.startsWith('+')) {
                             contactRaw = '+' + contactRaw;
                         }

                         const jobData = {
                             title: title, 
                             company: company, 
                             showCompany: String(showCompanyRaw).toUpperCase() === 'SI',
                             state: state, city: city, zone: zone,
                             location: (city && state) ? `${city}, ${state}` : legacyLoc, 
                             
                             fecha: row[findKey(row, 'fecha')] || '', 
                             
                             salary: row[findKey(row, 'salario')] || '', 
                             description: row[findKey(row, 'descripci√≥n')] || '',
                             schedule: row[findKey(row, 'jornada')] || 'Horario a definir',
                             tags: row[findKey(row, 'etiquetas')] || '',
                             requirements: (row[findKey(row, 'requisitos')]) ? String(row[findKey(row, 'requisitos')]).split(' | ') : [],
                             benefits: (row[findKey(row, 'beneficios')]) ? String(row[findKey(row, 'beneficios')]).split(/\s*\|\s*/) : [],
                             contact: contactRaw, 
                             status: row[findKey(row, 'estatus')] || 'Vigente',
                             agency: row[findKey(row, 'tipo de servicio o agencia')] || '',
                             // V16.27: Guardar flag
                             isFeatured: String(isFeaturedRaw).toUpperCase() === 'SI' 
                         };
                         set(ref(db, 'jobs/' + id), jobData);
                         count++;
                    });
                    window.showToast(`‚úÖ ${count} vacantes cargadas`);
                } catch(err) { alert('Error: ' + err.message); }
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
