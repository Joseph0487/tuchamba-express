<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>TuChamba Express | Vacantes Urgentes en Nuevo LeÃ³n, CDMX y EdoMex 2026</title>
    
    <link rel="icon" href="favicon.png" type="image/png">

    <meta name="description" content="Encuentra trabajo sin experiencia y de contrataciÃ³n inmediata en Nuevo LeÃ³n, CDMX y Estado de Mexico. Â¡Sin registros! Contacta directo por WhatsApp. Vacantes vigentes 2026.">
    
    <meta property="og:title" content="Â¿Buscas chamba urgente? Vacantes en Nuevo LeÃ³n, CDMX y EdoMex ğŸš€">
    <meta property="og:description" content="Sin correos ni registros. Clic y directo al WhatsApp del reclutador. Â¡Entra ya!">
    <meta property="og:image" content="https://tuchamba-express.vercel.app/banner_1.png">
    <meta property="og:url" content="https://tuchamba-express.vercel.app/">
    <meta property="og:type" content="website">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
       body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 15px;
            padding-top: 10px;
            min-height: 100vh;
            background-color: #f0f2f5; 
            overflow-anchor: none;  /* <--- ESTA ES LA LÃNEA MÃGICA */
        }

        /* Fondo Global Fijo */
        #globalBackground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            background-image: 
                linear-gradient(to bottom, rgba(10, 30, 60, 0.75), rgba(10, 30, 60, 0.85)),
                url('https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
        }

        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
            text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2147483647 !important;
            left: 50%; bottom: 30px; font-size: 15px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible !important; opacity: 1 !important; bottom: 50px !important; }

        .footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: #ccc; font-size: 12px; line-height: 1.6; }
        
        .footer-link { color: #fff; text-decoration: underline; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        
        .powered-by { margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 10px; font-family: monospace; letter-spacing: 1.5px; text-transform: uppercase; }
        .powered-by strong { color: rgba(255,255,255,0.7); font-weight: 900; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 1000px 100%; display: inline-block; position: relative; animation: shimmer 2s infinite linear forwards; border-radius: 4px; }
        .skeleton-card { background: white; border-radius: 16px; padding: 25px; height: 200px; display: flex; flex-direction: column; gap: 15px; }
        .sk-title { width: 70%; height: 24px; } .sk-text { width: 90%; height: 16px; } .sk-tag { width: 30%; height: 20px; border-radius: 20px; }

        .welcome-container { max-width: 480px; margin: 60px auto; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.2); border-top: 5px solid #ffc107; padding: 40px 25px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); text-align: center; }
        .welcome-title { font-size: 28px; color: #ffffff; margin-bottom: 10px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
        .welcome-subtitle { color: #f0f0f0; margin-bottom: 30px; font-size: 16px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5); line-height: 1.5; }
        .btn-big-guest { background: #0a66c2; color: white; border: none; padding: 16px; width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-big-guest:hover { background: #004182; transform: translateY(-2px); }
        .admin-toggle-link { display: block; margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 13px; text-decoration: underline; cursor: pointer; }
        /* --- CORRECCIÃ“N LOGIN MODERNO (V18.1) --- */
        .admin-login-form { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); text-align: left; animation: fadeIn 0.5s; }
        .admin-login-form label { display: block; color: white; margin-bottom: 8px; font-weight: bold; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .admin-login-form input { 
            width: 100%; 
            padding: 12px 15px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            border: none; 
            font-size: 16px; 
            background: rgba(255,255,255,0.95) !important; 
            color: #333; 
            outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .admin-login-form input:focus { transform: scale(1.02); transition: 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { max-width: 1250px; margin: 0 auto; }

        .header { 
            background: white; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-wrap: wrap; gap: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 1100; 
        }
        
        /* Sticky solo para Admin en el Header */
        body.admin-mode .header { position: sticky; top: 0; }

        .header h1 { font-size: 20px; color: #333; font-weight: 800; margin: 0; line-height: 1.2; }
        .header-buttons { display: flex; gap: 8px; align-items: center; }

        #recruiterBanner { background: #e3f2fd !important; color: #0d47a1 !important; padding: 10px 15px; border-radius: 8px; margin-top: 30px; margin-bottom: 10px; font-size: 13px; display: flex !important; align-items: center; justify-content: center; gap: 10px; border: 1px solid #bbdefb; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
        #recruiterBanner:hover { background: #bbdefb !important; }

        /* --- V18.2 MEJORA DE DISEÃ‘O DE BÃšSQUEDA (Estilo App Moderna) --- */
        #userStickyTools {
            position: sticky;
            top: 10px; 
            z-index: 990; 
            margin-bottom: 15px;
            
            /* Nuevo Look Flotante */
            background: white;
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); /* Sombra suave */
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* --- FIX V18.2: Descongelar bÃºsqueda en modo Admin/Reclutador --- */
        body.admin-mode #userStickyTools {
            position: static !important; /* Deja de ser sticky */
            margin-top: 10px;
            box-shadow: none; /* Se integra mÃ¡s plano en modo trabajo */
            background: rgba(255,255,255,0.9);
        }

        .search-container { width: 100%; position: relative; margin-bottom: 8px; }
        
        /* Input mÃ¡s moderno */
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            font-size: 15px;
            outline: none;
            background: #f9f9f9; /* Gris muy tenue */
            transition: all 0.2s;
        }
        .search-input:focus { border-color: #0a66c2; background: #fff; box-shadow: 0 0 0 2px rgba(10,102,194,0.1); }
        
        .search-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #ddd; color: #666; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }

        .filter-container { 
            display: flex; gap: 8px; align-items: center; 
            padding: 0; /* Quitamos padding extra */
            background: transparent; 
            box-shadow: none; /* Quitamos sombra vieja */
        }
        
        .filter-icon-box { display: flex; align-items: center; justify-content: center; background: #f0f2f5; padding: 0; border-radius: 10px; border: 1px solid #eee; height: 42px; width: 42px; flex-shrink: 0; }
        .filter-select { 
            flex: 1; min-width: 0; padding: 0 12px; 
            border: 1px solid #eee; border-radius: 10px; 
            font-size: 14px; background: #f9f9f9; outline: none; height: 42px; 
            cursor: pointer;
        }
        .filter-select:focus { background: white; border-color: #0a66c2; }

        #mobileFilterToggle { display: none; } 

        .btn-primary, .admin-btn { background: #0a66c2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; font-size: 14px; }
        .add-job-btn { background: #10a37f; padding: 12px 24px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .tool-btn { background: #2c3e50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .metrics-btn { background: #7b1fa2; } .team-btn { background: #e65100; } .settings-btn { background: #607d8b; }
        .danger-section { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 25px; }
        .danger-btn { background: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .page-btn { background: white; border: 1px solid #ddd; color: #0a66c2; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .page-btn:hover { background: #f0f2f5; border-color: #0a66c2; }
        .page-btn.active { background: #0a66c2; color: white; border-color: #0a66c2; }
        .page-btn:disabled { background: #f9f9f9; color: #ccc; cursor: not-allowed; border-color: #eee; }
        .page-info { width: 100%; text-align: center; font-size: 13px; color: #666; margin-top: 10px; }

        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px 20px 20px; margin: 20px -30px -30px; border-top: 1px solid #eee; text-align: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 100; }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.05); } 30% { transform: scale(1); } 100% { transform: scale(1); } }
        .whatsapp-btn-large { display: flex; align-items: center; justify-content: center; width: 100%; background-color: #25D366; color: white; text-decoration: none; padding: 12px 15px; border-radius: 12px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.3); border: none; cursor: pointer; animation: heartbeat 2s infinite ease-in-out; white-space: nowrap; }
        .whatsapp-btn-large:active { transform: scale(0.98); animation: none; }
        .whatsapp-btn-large:disabled { background-color: #9ccc65; cursor: not-allowed; transform: none; opacity: 0.7; animation: none; }

        .share-btn { background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        
        #adminControls {
            z-index: 1001;
            background: rgba(240, 242, 245, 0.95);
            backdrop-filter: blur(5px);
            padding-top: 10px; padding-bottom: 10px; margin-top: 0 !important; margin-bottom: 0px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        /* CORRECCIÃ“N: Botones Admin Sticky (Te siguen al bajar) */
        body.admin-mode #adminControls { 
            position: sticky; 
            top: 60px; /* Ajuste para quedar debajo de la barra blanca */
            z-index: 900; /* Menor que el header (1100) pero visible */
        }

        .admin-controls-wrapper { display: flex; gap: 10px; margin-bottom: 0px; flex-wrap: wrap; }
        .metrics-card { background: white; color: #333; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; font-size: 14px; }
        .metric-val { color: #0a66c2; font-weight: 800; margin-left: 4px; margin-right: 12px; }
        .admin-mode-indicator { background: #ffe0b2; color: #e65100; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #ffcc80; }

        .job-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; margin-top: 10px; }
        .job-card { background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; border: 1px solid #f0f0f0; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .job-card:hover { transform: translateY(-4px); }
        .badge-featured { position: absolute; top: 15px; right: 40px; background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%); color: white; padding: 5px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; box-shadow: 0 4px 8px rgba(98, 0, 234, 0.3); z-index: 4; display: flex; align-items: center; gap: 5px; border: none; letter-spacing: 0.5px; }
        .verified-badge { display: inline-flex; align-items: center; justify-content: center; background-color: #1da1f2; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; margin-left: 6px; vertical-align: middle; }
        .card-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; margin-right: 35px; }
        .card-header-date { font-size: 0.75rem; color: #888; background: #f5f5f5; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 12px; }
        .badge-vigente { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
        .badge-closed { background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }
        .badge-new { background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; margin-left: 5px; border: 1px solid #ffcc80; }
        .job-title { font-size: 1.2rem; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; line-height: 1.3; }
        .company-name { font-size: 0.9rem; color: #0a66c2; font-weight: 600; display: flex; align-items: center; }
        .location { font-size: 0.9rem; color: #555; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
        .salary-text { color: #d32f2f; font-weight: 800; font-size: 1.3rem; margin-top: 5px; }
        .company-logo { width: 48px; height: 48px; background: linear-gradient(135deg, #0a66c2 0%, #004182 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; flex-shrink: 0; }
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; }
        .tag { background: #f3f2ef; color: #444; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .more-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 24px; color: #333; cursor: pointer; width: 30px; height: 30px; z-index: 5; font-weight: 900; }
        .admin-actions { display: none; position: absolute; top: 45px; right: 15px; background: white; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 20; }
        .admin-actions.active { display: block; }
        .admin-action { padding: 10px 20px; width: 100%; text-align: left; border: none; background: none; cursor: pointer; }
        .admin-action:hover { background: #f9f9f9; }

        /* CORRECCIÃ“N: Modal siempre hasta el frente (Nivel 3000) */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 3000 !important; /* Â¡FUERZA BRUTA! Para que nada lo tape */
            padding: 20px; 
            backdrop-filter: blur(4px); 
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; max-width: 650px; width: 100%; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; overflow-x: hidden; padding-bottom: 0; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #f0f2f5; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #666; z-index: 10; }
        .job-details { display: grid; gap: 15px; margin-bottom: 25px; margin-top: 15px; }
        .detail-item { font-size: 15px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 10px; line-height: 1.4; word-break: break-word; }
        .modal-share-btn { background: #455a64; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; flex-shrink: 0; white-space: nowrap; }
        .view-count-badge { background: #e3f2fd; color: #0277bd; font-size: 12px; padding: 6px 14px; border-radius: 50px; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; border: 1px solid #bbdefb; }
        .agency-badge { background: #fff3e0; color: #ef6c00; font-size: 12px; padding: 6px 14px; border-radius: 50px; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; border: 1px solid #ffe0b2; }
        .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 12px; margin-top: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 5px; display: block; }
        .item-list li { background: #f9f9f9; padding: 10px 14px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 15px; }
        .recruiters-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .recruiters-table th, .recruiters-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .recruiters-table th { background: #f9fafb; color: #666; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .recruiters-table tr:hover { background-color: #f9f9f9; }
        .job-counter { color: white; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-bottom: 15px; margin-top: 10px; display: block; font-size: 16px; }

        /* ESTILOS PARA LA TABLA DE GESTIÃ“N (RECLUTADOR) */
        .job-table-container { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .management-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        
        /* --- FIX V18.2: Sticky TÃ­tulos Tabla Corregido --- */
        .management-table th {
            background: #0a66c2; color: white; padding: 15px; text-align: left; font-weight: 600; 
            z-index: 950;
        }
        
        /* CORRECCIÃ“N BARRA AZUL + CURSOR DE ORDENAR (V18.1) */
        body.admin-mode .management-table th {
            position: relative; 
            top: 0;
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; /* Manita para indicar clic */
            user-select: none; /* Evita que se seleccione el texto al dar clic rÃ¡pido */
            transition: background 0.2s;
        }
        body.admin-mode .management-table th:hover {
            background-color: #004182; /* Color un poco mÃ¡s oscuro al pasar el mouse */
        }
        /* Ocultar botones delicados en modo Reclutador */
        body.recruiter-view .admin-only { display: none !important; }

        .management-table td { padding: 8px 10px; border-bottom: 1px solid #eee; color: #333; }
        .management-table tr:hover { background: #f5f5f5; }
        
        .action-icon-btn { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 5px; padding: 5px; border-radius: 4px; }
        .action-icon-btn:hover { background: #e3f2fd; }
        .management-table td:last-child { white-space: nowrap; display: flex; gap: 5px; align-items: center; }

        #flyerTemplate { width: 1080px; min-height: 1080px; height: auto; position: fixed; top: 0; left: -9999px; z-index: -1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: 'Arial Black', 'Arial', sans-serif; text-align: center; padding: 80px 60px; box-sizing: border-box; background: #0a192d; }
        .flyer-badge-top { background-color: #FF9800; color: white; font-size: 55px; padding: 15px 80px; border-radius: 10px; text-transform: uppercase; letter-spacing: 4px; font-weight: 900; margin-bottom: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); border: 4px solid #FFF; transform: skew(-10deg); z-index: 2; position: relative; }
        .flyer-title { font-size: 90px; font-weight: 900; line-height: 1.1; margin-bottom: 20px; text-shadow: 0 5px 20px rgba(0,0,0,0.9); max-width: 95%; text-transform: uppercase; color: #FFFFFF; z-index: 2; position: relative; }
        .flyer-company { font-size: 35px; color: #BBDEFB; font-family: 'Segoe UI', sans-serif; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; z-index: 2; position: relative; }
        .flyer-salary { font-size: 100px; color: #C6FF00; font-weight: 900; margin-bottom: 50px; text-shadow: 0 5px 20px rgba(0,0,0,0.9); z-index: 2; position: relative; }
        .flyer-benefits-container { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 30px; padding: 40px; width: 90%; margin-bottom: 60px; backdrop-filter: blur(10px); z-index: 2; position: relative; }
        .flyer-benefits-title { font-size: 40px; color: #FFD740; margin-bottom: 30px; text-transform: uppercase; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 15px; display: inline-block; }
        .flyer-benefits-list { list-style: none; padding: 0; margin: 0; font-size: 55px; font-family: 'Segoe UI', sans-serif; font-weight: 600; color: white; text-align: left; display: inline-block; }
        .flyer-benefits-list li { margin-bottom: 15px; }
        .flyer-cta-box { background: white; color: #D50000; padding: 40px 60px; border-radius: 20px; font-size: 42px; font-weight: 900; box-shadow: 0 15px 50px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; gap: 20px; border-bottom: 15px solid #b71c1c; width: 100%; text-transform: uppercase; z-index: 2; position: relative; }
        #flyerQr { margin-left: 20px; border: 2px solid #ddd; padding: 5px; border-radius: 10px; background: white; }
        #flyerQr img { display: block; }
        /* --- ESTILOS MODERNOS PARA MODALES (V18.3) --- */
        .modal-header-pro {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header-pro h2 { margin: 0; font-size: 1.4rem; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        
        .modern-form-box {
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        
        /* Grid para ahorrar espacio (2 columnas) */
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Tabla Pro */
        .table-container-pro {
            border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 10px;
        }
        .recruiters-table { width: 100%; border-collapse: collapse; }
        .recruiters-table thead { background: #f1f3f5; }
        .recruiters-table th { color: #495057; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; padding: 12px 15px; letter-spacing: 0.5px; }
        .recruiters-table td { padding: 12px 15px; border-bottom: 1px solid #f1f3f5; color: #333; font-size: 0.9rem; vertical-align: middle; }
        .recruiters-table tr:hover { background: #fffde7; }

        /* Botones de acciÃ³n pequeÃ±os */
        .btn-icon-small { border: none; background: transparent; cursor: pointer; font-size: 16px; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .btn-icon-small:hover { background: #eee; }
        .copy-badge { background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; border: none; }
        .copy-badge:hover { background: #bbdefb; }

        /* Zona de Peligro Bonita */
        .danger-zone-pro {
            background: #fff5f5; border: 1px solid #ffc9c9; border-radius: 12px; padding: 20px;
            position: relative; overflow: hidden; margin-top: 10px;
        }
        .danger-zone-pro::before { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #ff6b6b; }
        .danger-title { color: #c92a2a; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 1rem; }
        
        @media (max-width: 600px) { .form-grid-2 { grid-template-columns: 1fr; } }
        /* --- ESTILOS V18.6 (SeparaciÃ³n Total: App vs Login) --- */

        /* GRUPO 1: DENTRO DE LA APP (Compactos y Modernos) */
        /* Excluimos explÃ­citamente el #adminForm para que no lo toque */
        :not(#adminForm) > .form-group input, 
        :not(#adminForm) > .form-group textarea, 
        :not(#adminForm) > .form-group select { 
            width: 100% !important; 
            padding: 8px 12px !important; /* Compactos */
            background-color: #f0f2f5 !important; /* Gris App */
            border: 1px solid transparent !important; 
            border-radius: 8px !important;
            font-size: 14px !important; 
            color: #1c1e21 !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            box-shadow: none !important;
            min-height: 38px !important;
        }
        
        /* Efecto Focus App */
        :not(#adminForm) > .form-group input:focus, 
        :not(#adminForm) > .form-group select:focus {
            background-color: #ffffff !important;
            border: 1px solid #0a66c2 !important;
            box-shadow: 0 2px 6px rgba(10, 102, 194, 0.15) !important;
        }

        /* Etiquetas App (Gris oscuro) */
        :not(#adminForm) > .form-group label {
            display: block !important;
            margin-bottom: 4px !important;
            color: #444 !important;
            font-size: 11px !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
        }

        /* GRUPO 2: LOGIN (Rescatando el estilo original) */
        #adminForm .form-group input {
            background-color: #ffffff !important; /* BLANCO PURO */
            color: #000000 !important; /* Texto NEGRO */
            border: none !important;
            padding: 12px 15px !important; /* Grandes y cÃ³modos */
            border-radius: 10px !important;
            font-size: 16px !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
            margin-bottom: 15px !important;
        }

        /* Etiquetas del Login (BLANCAS para que se vean en el fondo oscuro) */
        #adminForm .form-group label {
            color: #ffffff !important; 
            font-size: 14px !important;
            font-weight: bold !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important;
            margin-bottom: 8px !important;
            text-transform: none !important; /* Normal, no mayÃºsculas */
        }

        /* Ajustes tÃ©cnicos globales */
        .phone-group input { border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; }
        .phone-select { border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; background-color: #e4e6eb !important; border-right: 1px solid #ccc !important; padding: 5px !important; }

        /* Efecto al dar clic (Se ilumina) */
        .form-group input:focus, 
        .form-group textarea:focus, 
        .form-group select:focus { 
            background-color: #ffffff !important;
            border: 1px solid #0a66c2 !important; /* Borde azul al escribir */
            box-shadow: 0 4px 15px rgba(10, 102, 194, 0.15) !important;
            outline: none !important;
        }

        /* Etiquetas (TÃ­tulos de los campos) */
        .form-group label {
            display: block !important;
            margin-bottom: 8px !important;
            margin-left: 5px !important;
            font-weight: 700 !important;
            color: #444 !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        /* Ajuste especial para el grupo de telÃ©fono (que no se rompa) */
        .phone-group input {
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }
        .phone-select {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            background-color: #e4e6eb !important;
            border-right: 1px solid #ccc !important;
        }
        /* --- ESTILO BARRA DE BÃšSQUEDA DE ALTO CONTRASTE (V18.7) --- */
        
        /* 1. La barra contenedora (Fondo Gris) */
        #userStickyTools, body.admin-mode #userStickyTools {
            background-color: #e4e6eb !important; /* Gris sÃ³lido para el fondo */
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important; /* Sombra suave para que flote */
        }

        /* 2. Los campos de bÃºsqueda y filtros (Blancos Brillantes) */
        .search-input, 
        .filter-select, 
        .filter-icon-box {
            background-color: #ffffff !important; /* BLANCO PURO */
            border: 1px solid transparent !important; /* Sin bordes grises */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important; /* PequeÃ±a sombra 3D */
            color: #333 !important;
        }

        /* 3. Efecto al hacer clic en ellos (Resplandor Azul) */
        .search-input:focus, 
        .filter-select:focus {
            background-color: #ffffff !important;
            box-shadow: 0 0 0 3px rgba(10, 102, 194, 0.2) !important; /* Anillo azul suave */
            border-color: #0a66c2 !important;
        }

        /* Ajuste para el icono del embudo */
        .filter-icon-box svg {
            stroke: #555 !important;
        }
        /* --- FICHAS COMPACTAS (OptimizaciÃ³n de Espacio V18.8) --- */
        
        /* 1. Reducir el "aire" general de la tarjeta */
        .job-card {
            padding: 14px !important; /* Antes era 20px */
            border-radius: 12px !important;
        }

        /* 2. Pegar mÃ¡s los elementos internos */
        .card-header-top { margin-bottom: 4px !important; } /* Menos espacio arriba */
        .card-header-date { margin-bottom: 8px !important; font-size: 0.7rem !important; }
        
        /* El bloque del Logo y TÃ­tulo */
        .job-card > div[style*="display: flex"] {
            margin-top: 5px !important; /* Pegarlo a la fecha */
            margin-bottom: 8px !important; /* Pegarlo a la ubicaciÃ³n */
            gap: 10px !important; /* Acercar logo al texto */
        }
        
        /* Ajustar mÃ¡rgenes de textos clave */
        .job-title { margin-bottom: 0px !important; line-height: 1.2 !important; }
        .company-name { margin-bottom: 2px !important; }
        .location { margin-top: 4px !important; }
        .salary-text { margin-top: 4px !important; }

        /* Las etiquetas de abajo (Tags) */
        .tags { margin-top: 10px !important; gap: 5px !important; }
        .tag { padding: 3px 8px !important; font-size: 11px !important; }

        /* Hacer los botones de "Destacado" y "Vigente" mÃ¡s delgados */
        .badge-featured, .badge-vigente, .badge-closed, .badge-new {
            padding: 3px 8px !important;
            top: 12px !important; /* Subirlos un poquito */
        }
        .more-btn { top: 10px !important; right: 10px !important; } /* Ajustar botÃ³n de menÃº */
        /* --- CORRECCIÃ“N FINAL LADAS (V18.9) --- */
        .phone-group {
            display: flex !important; /* Obliga a ponerse en fila */
            align-items: stretch !important;
            width: 100% !important;
            gap: 0 !important; /* Pegaditos */
        }
        
        .phone-select {
            width: auto !important; /* Que solo ocupe lo necesario */
            flex: 0 0 auto !important; /* No permitir que se estire */
            min-width: 100px !important; /* Ancho fijo ideal para "ğŸ‡²ğŸ‡½ +52" */
            padding: 8px 5px !important;
            text-align: center !important;
            border-right: 1px solid #ccc !important;
            background-color: #e4e6eb !important;
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            cursor: pointer !important;
        }

        .phone-group input {
            flex: 1 !important; /* El input toma TODO el espacio sobrante */
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
            border-left: none !important;
        }
        /* --- CORRECCIÃ“N FINAL MAESTRA LADAS (V18.11) --- */
        
        /* 1. Forzamos al contenedor a ser flexible horizontalmente */
        .form-group .phone-group {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            width: 100% !important;
        }

        /* 2. AL SELECTOR DE PAÃS: Lo obligamos a ser pequeÃ±o */
        .form-group .phone-group select.phone-select {
            width: 110px !important; /* Ancho fijo pequeÃ±o */
            min-width: 110px !important;
            max-width: 110px !important;
            flex: 0 0 110px !important; /* No te estires ni te encojas */
            
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-right: 1px solid #ccc !important;
            margin: 0 !important;
        }

        /* 3. AL CAMPO DE NÃšMERO: Le decimos que ocupe TODO el resto */
        .form-group .phone-group input {
            width: auto !important; 
            flex-grow: 1 !important; /* Crece para llenar el hueco */
            min-width: 0 !important;
            
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
            margin: 0 !important;
        }
       /* --- SOLUCIÃ“N MAESTRA MÃ“VIL V24 (Final) --- */
       /* --- CORRECCIÃ“N FINAL: INSTRUCCIONES EXACTAS (V25) --- */
        @media (max-width: 768px) {

            /* ==============================================
               1. ARREGLO VISTA INVITADO (Volver a una lÃ­nea)
            ============================================== */
            /* Aseguramos que el header normal no se rompa */
            .header {
                flex-wrap: nowrap !important;
                white-space: nowrap !important;
                overflow: hidden !important;
            }
            .header h1 {
                font-size: 16px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }


            /* ==============================================
               2. MODO RECLUTADOR: ENCABEZADO FIJO (2 PISOS)
            ============================================== */
            body.recruiter-view .header {
                position: sticky !important;
                top: 0 !important;
                z-index: 1200 !important;
                background: white !important;
                border-bottom: 1px solid #ccc !important;
                /* Altura fija calculada para 2 pisos: 35px + 35px + espacios = 82px */
                height: 82px !important; 
                padding: 5px 10px !important;
                margin: 0 !important;
                
                /* Usamos GRID para definir las posiciones exactas */
                display: grid !important;
                grid-template-areas: 
                    "titulo salir"
                    "compartir modo";
                grid-template-columns: 1fr auto !important;
                grid-template-rows: 1fr 1fr !important;
                gap: 2px 10px !important;
                align-content: center !important;
            }

            /* Desarmamos contenedores para mover las piezas */
            body.recruiter-view .header-buttons { display: contents !important; }

            /* ASIGNACIÃ“N DE LUGARES (SegÃºn tu diagrama) */
            /* Piso 1 */
            body.recruiter-view .header h1 { 
                grid-area: titulo;
                font-size: 15px !important; margin: 0 !important; align-self: center;
            }
            body.recruiter-view .admin-btn { /* BotÃ³n Salir */
                grid-area: salir;
                padding: 4px 10px !important; height: 26px !important; font-size: 11px !important; 
                margin: 0 !important; align-self: center;
            }

            /* Piso 2 */
            body.recruiter-view .share-btn { /* BotÃ³n Compartir */
                grid-area: compartir;
                width: 100% !important; height: 28px !important; font-size: 12px !important;
                margin: 0 !important; display: flex; align-items: center; justify-content: center;
                background: #0a66c2 !important; align-self: center;
            }
            body.recruiter-view #modeIndicator { /* Etiqueta Modo */
                grid-area: modo; align-self: center;
            }
            body.recruiter-view .admin-mode-indicator {
                font-size: 10px !important; padding: 4px 8px !important;
            }
            
            /* Ocultar lo que no se pidiÃ³ */
            body.recruiter-view #viewToggleBtn { display: none !important; }


            /* ==============================================
               3. MODO RECLUTADOR: BOTONES DELGADOS (GRID 2 COL)
            ============================================== */
            body.recruiter-view #adminControls {
                position: static !important; /* Este panel SÃ se desplaza */
                padding: 10px !important;
                background: #f4f6f8 !important;
                border-bottom: 1px solid #e0e0e0;
            }

            body.recruiter-view .admin-controls-wrapper {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important; /* 2 columnas */
                gap: 8px !important;
            }

            /* Estilo UNIFICADO para botones DELGADOS (Slim) */
            body.recruiter-view .admin-controls-wrapper > * {
                height: 40px !important; /* Altura delgada */
                min-height: 0 !important;
                font-size: 11px !important;
                font-weight: 600 !important;
                color: #444 !important;
                background: white !important;
                border: 1px solid #ccc !important;
                border-radius: 6px !important;
                padding: 0 8px !important;
                margin: 0 !important;
                width: 100% !important;
                display: flex !important; align-items: center !important; justify-content: flex-start !important;
                gap: 6px !important;
            }

            /* ORDEN DE LA CUADRILLA (Incluyendo Nueva Vacante para poder trabajar) */
            body.recruiter-view .add-job-btn { order: 1; background: #10a37f !important; color: white !important; justify-content: center !important; }
            
            /* Tu lista solicitada */
            body.recruiter-view .metrics-card { order: 2; border-left: 3px solid #0a66c2 !important; }
            body.recruiter-view .metrics-card span { display: none !important; }
            body.recruiter-view .metrics-card::after { content: "Vistas"; font-weight: normal; }
            
            body.recruiter-view button[onclick="exportToExcel()"] { order: 3; border-left: 3px solid #455a64 !important; }
            
            body.recruiter-view button[onclick="openMetricsModal()"] { order: 4; border-left: 3px solid #7b1fa2 !important; }
            
            body.recruiter-view button[onclick="downloadTemplate()"] { order: 5; border-left: 3px solid #00796b !important; }

            /* Ocultar sobrantes de Admin */
            body.recruiter-view .team-btn, body.recruiter-view .settings-btn, body.recruiter-view button[onclick*="excelFile"] { display: none !important; }


            /* ==============================================
               4. BARRA AZUL (Pegada exactamente debajo del header)
            ============================================== */
            /* Header mide 82px -> La tabla se pega en 82px */
            body.recruiter-view .management-table th {
                position: sticky !important;
                top: 82px !important; 
                z-index: 1100 !important;
                padding: 8px 4px !important;
                height: 35px !important;
                font-size: 10px !important;
                box-shadow: 0 4px 5px rgba(0,0,0,0.15) !important;
            }
            .job-table-container { margin-top: 0 !important; border: none !important; }
        }

    </style>
</head>
<body>

    <div id="globalBackground"></div>

    <div id="flyerTemplate">
        <div style="position: absolute; top:0; left:0; width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') center center / cover no-repeat; opacity: 0.1; z-index: 0;"></div>
        <div style="position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(10, 25, 45, 0.85); z-index: 1;"></div>
        <div class="flyer-badge-top">Â¡SE SOLICITA!</div>
        <div class="flyer-company">RECONOCIDA EMPRESA BUSCA:</div>
        <div id="flyerTitle" class="flyer-title">CHOFER 3.5 TON</div>
        <div id="flyerSalary" class="flyer-salary">$12,000</div>
        <div class="flyer-benefits-container">
            <div class="flyer-benefits-title">OFRECEMOS:</div>
            <ul id="flyerBenefitsList" class="flyer-benefits-list">
                <li>âœ… Pago Semanal</li>
                <li>âœ… Prestaciones de Ley</li>
                <li>âœ… ContrataciÃ³n Inmediata</li>
            </ul>
        </div>
        <div class="flyer-cta-box">
            ğŸ”— DALE CLIC AL LINK DE LA PUBLICACIÃ“N PARA AGENDAR
            <div id="flyerQr"></div>
        </div>
    </div>

    <div id="loginScreen" class="welcome-container">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸš€</div>
        <h1 class="welcome-title">TuChamba Express</h1>
        <p class="welcome-subtitle">
            Tu nueva chamba a un mensaje de distancia.<br>
            Sin registros complicados.
        </p>
        <button class="btn-big-guest" onclick="enterAsGuest()">ğŸ” Ver Vacantes Disponibles</button>
        <div class="admin-toggle-link" onclick="toggleAdminLogin()">Â¿Eres Reclutador? Ingresa aquÃ­</div>
        <form id="adminForm" class="admin-login-form" onsubmit="event.preventDefault(); login();">
            <div class="form-group">
                <label style="color:white;">Usuario / Correo</label>
                <input type="text" id="adminEmail" placeholder="Usuario o Correo" autocomplete="username" enterkeyhint="next" style="background:rgba(255,255,255,0.9);">
            </div>
            <div class="form-group">
                <label style="color:white;">ContraseÃ±a</label>
                <input type="password" id="adminPassword" placeholder="******" autocomplete="current-password" enterkeyhint="go" style="background:rgba(255,255,255,0.9);">
            </div>
            <button type="submit" id="btnLogin" class="btn-primary" style="width: 100%;">Entrar al Panel</button>
        </form>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="container">
            
            <div class="header">
                <h1>Portal de Vacantes</h1>
                <div class="header-buttons">
                    <button class="share-btn" onclick="shareApp()">ğŸ“¤ Compartir</button>
                    <span id="modeIndicator"></span>
                    <button id="viewToggleBtn" class="tool-btn" style="display:none; background:#00796b;" onclick="toggleViewMode()">ğŸ‘ï¸ Cambiar Vista</button>
                    <button class="admin-btn" style="background: #333;" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="adminControls" style="display: none;">
                <div class="admin-controls-wrapper">
                <div class="metrics-card">
                    ğŸŒ <span class="metric-val" id="totalVisits">...</span>
                    ğŸ“… Mes: <span class="metric-val" id="monthlyVisits">...</span>
                </div>
                <button class="add-job-btn admin-only" onclick="openJobForm()">â• Nueva</button>
                
                <button class="tool-btn" onclick="exportToExcel()">ğŸ“¦ Respaldo</button> 
                <button class="tool-btn metrics-btn" onclick="openMetricsModal()">ğŸ“Š MÃ©tricas</button>
                
                <button class="tool-btn team-btn admin-only" onclick="openTeamModal()">ğŸ‘¥ Equipo</button>
                <button class="tool-btn settings-btn admin-only" onclick="openSettingsModal()">âš™ï¸ Ajustes</button>
                <button class="tool-btn admin-only" onclick="document.getElementById('excelFile').click()">ğŸ“¤ Cargar</button>
                
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importFromExcel(event)">
                <button class="tool-btn" onclick="downloadTemplate()">ğŸ“‹ Plantilla</button>
            </div>
            </div>

            <div id="userStickyTools">
                <button id="mobileFilterToggle" onclick="toggleMobileFilters()">
                    ğŸ” Filtros de BÃºsqueda <span>â–¼</span>
                </button>

                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Buscar vacante, empresa, palabras clave..." onkeyup="filterJobs()" autocomplete="off">
                    <button id="clearSearchBtn" class="search-clear-btn" onclick="clearSearch()">âœ•</button>
                </div>

                <div class="filter-container" id="filterContainer">
                    <div class="filter-icon-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    </div>
                    <select id="stateFilter" class="filter-select" onchange="handleStateChange()" autocomplete="off">
                        <option value="">ğŸ“ Estado</option>
                    </select>
                    <select id="cityFilter" class="filter-select" onchange="filterJobs()" autocomplete="off">
                        <option value="">ğŸ™ï¸ Municipio</option>
                    </select>
                </div>
            </div>
            <div class="grid-header"><div class="job-counter" id="jobCounter"></div></div>
            
            <div id="skeletonLoader" class="job-grid">
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
            </div>

            <div class="job-grid" id="jobGrid" style="display: none;"></div>

            <div class="job-table-container" id="jobTableContainer" style="display: none;">
                <table class="management-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th onclick="window.handleSort('company')" title="Ordenar por Empresa">Empresa â†•ï¸</th>
                            <th onclick="window.handleSort('title')" title="Ordenar por TÃ­tulo">TÃ­tulo â†•ï¸</th>
                            <th onclick="window.handleSort('location')" title="Ordenar por UbicaciÃ³n">UbicaciÃ³n â†•ï¸</th>
                            <th onclick="window.handleSort('salary')">Salario</th>
                            <th onclick="window.handleSort('status')" title="Ordenar por Estatus">Estatus â†•ï¸</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="jobTableBody"></tbody>
                </table>
            </div>
            <div id="paginationContainer" class="pagination-container" style="display:none;"></div>
            
            <div id="recruiterBanner" onclick="contactCentralOffice()">
                ğŸ‘¤ Asistido por: <span id="recruiterNameDisplay">Oficina Central</span> (Clic para contacto)
            </div>

            <div class="footer">
                <p>TuChamba Express &copy; 2026. Todos los derechos reservados.<br>
                Aviso: Algunas empresas pueden solicitar examen mÃ©dico y/o antidoping.</p>
                <div style="margin-top:10px;">
                    <a class="footer-link" onclick="openPrivacyModal()">ğŸ”’ Aviso de Privacidad</a>
                </div>
                <p class="powered-by">Powered by <strong>BitX</strong></p>
            </div>

            <div id="emptyState" class="welcome-container" style="display: none; padding: 30px; margin-top: 20px;">
                <h3>No hay vacantes publicadas ğŸ˜¢</h3><p>Intenta mÃ¡s tarde o ajusta los filtros.</p>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <div class="modal" id="viewModal"><div class="modal-content"><button class="close-btn" onclick="closeViewModal()">Ã—</button><div id="viewModalBody"></div></div></div>

    <div class="modal" id="formModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeFormModal()">Ã—</button>
            <h2 id="formTitle">Gestionar Vacante</h2>
            <form id="jobForm" onsubmit="saveJob(event)">
                <div class="form-group"><label>Estatus</label><select id="jobStatus"><option value="Vigente">Vigente (Verde)</option><option value="No Vigente">No Vigente (Rojo)</option></select></div>
                
                <div class="form-group" style="background: #fff8e1; padding: 10px; border-radius: 8px; border: 1px dashed #ffd54f;">
                    <label style="color: #ff8f00;">â­ Â¿Impulsar Vacante? (Destacada)</label>
                    <select id="jobIsFeatured">
                        <option value="false">NO (Normal)</option>
                        <option value="true">SÃ (Destacar)</option>
                    </select>
                </div>

                <div class="form-group"><label>Â¿Mostrar nombre de empresa al pÃºblico?</label><select id="jobShowCompany"><option value="true">SÃ (Visible para todos)</option><option value="false">NO (Confidencial / Solo Admin)</option></select></div>
                
                <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ef6c00;">
                    <label style="color: #e65100;">ğŸ¢ Tipo de Servicio o Agencia (Interno)</label>
                    <input type="text" id="jobAgency" placeholder="Ej. Agencia Norte - Solo visible para Reclutador">
                </div>
                <div class="form-group"><label>TÃ­tulo *</label><input type="text" id="jobTitle" required></div>
                <div class="form-group"><label>Empresa (Nombre Real) *</label><input type="text" id="jobCompany" required placeholder="Escribe el nombre real aquÃ­"></div>
                
                <div class="form-group">
                    <label>UbicaciÃ³n Detallada *</label>
                    <div class="location-grid">
                        <input type="text" id="jobState" placeholder="Estado (Ej. CDMX)" required>
                        <input type="text" id="jobCity" placeholder="Municipio (Ej. CoyoacÃ¡n)" required>
                        <input type="text" id="jobZone" placeholder="Colonia/Zona (Ej. Centro)">
                    </div>
                </div>

                <div class="form-group"><label>Fecha de PublicaciÃ³n</label><input type="date" id="jobDate"></div>
                
                <div class="form-group"><label>Salario</label><input type="text" id="jobSalary" placeholder="$8,500/mes"></div>
                <div class="form-group"><label>DescripciÃ³n *</label><textarea id="jobDescription" required></textarea></div>
                <div class="form-group"><label>Jornada / Horario</label><input type="text" id="jobSchedule" placeholder="Ej. Lunes a Viernes 9 a 6"></div>
                
                <div class="form-group"><label>Etiquetas</label><input type="text" id="jobTags" placeholder="#Ventas, #Seguros"></div>
                <div class="form-group"><label>Requisitos</label><div class="list-input"><input type="text" id="reqInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('req')">+</button></div><ul class="item-list" id="reqList"></ul></div>
                <div class="form-group"><label>Beneficios</label><div class="list-input"><input type="text" id="benInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('ben')">+</button></div><ul class="item-list" id="benList"></ul></div>
                
                <div class="form-group">
                    <label>WhatsApp Contacto (NÃºmero Real)</label>
                    <div class="phone-group">
                        <select id="jobPhoneCode" class="phone-select">
                            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
                            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
                            <option value="+51">ğŸ‡µğŸ‡ª +51</option>
                            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
                        </select>
                        <input type="text" id="jobContact" placeholder="10 dÃ­gitos (Ej. 5512345678)" style="flex:1;">
                    </div>
                </div>

                <div class="form-actions"><button type="button" class="tool-btn" style="background:#666; width:100%" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary" style="width:100%">Guardar</button></div>
            </form>
        </div>
    </div>

    <div class="modal" id="metricsModal"><div class="modal-content"><button class="close-btn" onclick="closeMetricsModal()">Ã—</button><h2>ğŸ“Š Exportar MÃ©tricas</h2><p style="margin-bottom:10px; color:#666;">Selecciona los meses que deseas incluir en el reporte:</p><div id="metricsMonthList" style="margin: 15px 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background:#f9f9f9;"><p style="text-align:center; color:#999;">Cargando historial...</p></div><button class="btn-primary" style="width:100%" onclick="downloadSelectedMetrics()">ğŸ“¥ Descargar Excel Consolidado</button></div></div>
    <div class="modal" id="teamModal">
        <div class="modal-content">
            <div class="modal-header-pro">
                <h2>ğŸ‘¥ GestiÃ³n de Equipo</h2>
                <button class="close-btn" style="position:static;" onclick="closeTeamModal()">Ã—</button>
            </div>
            
            <div class="modern-form-box">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Nombre del Reclutador</label>
                        <input type="text" id="recName" placeholder="Ej. Juan PÃ©rez">
                    </div>
                    <div class="form-group">
                        <label>CÃ³digo Ãšnico (Link)</label>
                        <input type="text" id="recCode" placeholder="Ej. JUAN (Sin espacios)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>WhatsApp de Contacto</label>
                    <div class="phone-group">
                        <select id="recPhoneCode" class="phone-select">
                            <option value="+52">ğŸ‡²ğŸ‡½ +52</option>
                            <option value="+54">ğŸ‡¦ğŸ‡· +54</option>
                            <option value="+591">ğŸ‡§ğŸ‡´ +591</option>
                            <option value="+55">ğŸ‡§ğŸ‡· +55</option>
                            <option value="+56">ğŸ‡¨ğŸ‡± +56</option>
                            <option value="+57">ğŸ‡¨ğŸ‡´ +57</option>
                            <option value="+506">ğŸ‡¨ğŸ‡· +506</option>
                            <option value="+53">ğŸ‡¨ğŸ‡º +53</option>
                            <option value="+593">ğŸ‡ªğŸ‡¨ +593</option>
                            <option value="+503">ğŸ‡¸ğŸ‡» +503</option>
                            <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+502">ğŸ‡¬ğŸ‡¹ +502</option>
                            <option value="+504">ğŸ‡­ğŸ‡³ +504</option>
                            <option value="+505">ğŸ‡³ğŸ‡® +505</option>
                            <option value="+507">ğŸ‡µğŸ‡¦ +507</option>
                            <option value="+595">ğŸ‡µğŸ‡¾ +595</option>
                            <option value="+51">ğŸ‡µğŸ‡ª +51</option>
                            <option value="+1">ğŸ‡©ğŸ‡´ +1</option>
                            <option value="+598">ğŸ‡ºğŸ‡¾ +598</option>
                            <option value="+58">ğŸ‡»ğŸ‡ª +58</option>
                        </select>
                        <input type="text" id="recPhone" placeholder="10 dÃ­gitos" style="flex:1;">
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-primary" style="flex:1; display:flex; justify-content:center; align-items:center; gap:8px;" id="btnSaveRecruiter" onclick="saveRecruiter()">
                        ğŸ’¾ Guardar Reclutador
                    </button>
                    <button class="tool-btn" style="background:#666; display:none;" id="btnCancelRecruiter" onclick="resetRecruiterForm()">Cancelar</button>
                </div>
            </div>

            <h3 style="font-size:16px; margin-bottom:10px; color:#555;">ğŸ“‚ Directorio Activo</h3>
            <div class="table-container-pro">
                <div style="overflow-x: auto;">
                    <table class="recruiters-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>CÃ³digo</th>
                                <th style="text-align:center;">Link</th>
                                <th style="text-align:right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="recruitersList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="settingsModal"><div class="modal-content"><button class="close-btn" onclick="closeSettingsModal()">Ã—</button><h2>âš™ï¸ Ajustes del Sistema</h2><div class="form-group"><label>ğŸ“ TelÃ©fono Oficina Central (Respaldo)</label><div style="display:flex; gap:10px;"><input type="text" id="settingsPhoneInput" placeholder="Ej. 5512345678" style="flex:1;"><button class="btn-primary" id="btnSaveCentral" onclick="saveCentralConfig()">Guardar</button></div><p style="font-size:12px; color:#666; margin-top:5px;">Este nÃºmero se usa si la vacante no tiene contacto o estÃ¡ mal escrito.</p></div><div class="danger-section"><h3 style="color:#d32f2f; margin-bottom:10px;">âš ï¸ Zona de Peligro (Admin)</h3><p style="font-size:13px; color:#666; margin-bottom:10px;">Acciones irreversibles protegidas por contraseÃ±a.</p><button class="danger-btn" onclick="performSafeAction('resetMetrics')">ğŸ—‘ï¸ Resetear MÃ©tricas (Vistas)</button><button class="danger-btn" onclick="performSafeAction('deleteJobs')">ğŸ”¥ Borrar TODAS las Vacantes</button></div></div></div>
    <div class="modal" id="privacyModal"><div class="modal-content"><button class="close-btn" onclick="closePrivacyModal()">Ã—</button><h2>ğŸ”’ Aviso de Privacidad</h2><div style="text-align: left; color: #444; line-height: 1.6; font-size: 14px; max-height: 70vh; overflow-y: auto;"><p style="font-size: 12px; color: #666; margin-bottom: 15px;"><strong>Ãšltima actualizaciÃ³n: Enero 2026</strong></p><p style="margin-bottom: 15px;">En cumplimiento con la Ley Federal de ProtecciÃ³n de Datos Personales en PosesiÃ³n de los Particulares, <strong>TuChamba Express</strong> informa:</p><p style="margin-bottom:5px;"><strong>1. Responsable de los datos:</strong></p><p style="margin-bottom:15px;">TuChamba Express actÃºa como enlace entre candidatos y empresas reclutadoras.</p><p style="margin-bottom:5px;"><strong>2. Datos recopilados:</strong></p><p style="margin-bottom:15px;">Podemos recopilar datos de contacto (como nÃºmero telefÃ³nico) con el Ãºnico fin de facilitar la comunicaciÃ³n para procesos de reclutamiento.</p><p style="margin-bottom:5px;"><strong>3. Uso de la informaciÃ³n:</strong></p><p style="margin-bottom:5px;">Los datos proporcionados serÃ¡n utilizados exclusivamente para:</p><ul style="margin-left: 20px; margin-bottom: 15px;"><li>Contactar al candidato respecto a la vacante de interÃ©s.</li><li>Agendar entrevistas laborales.</li><li>Procesos internos de selecciÃ³n.</li></ul><p style="margin-bottom:5px;"><strong>4. Compartir datos:</strong></p><p style="margin-bottom:15px;">Su informaciÃ³n de contacto serÃ¡ compartida Ãºnicamente con la empresa o reclutador responsable de la vacante a la que usted decida postularse voluntariamente.</p><p style="margin-bottom:5px;"><strong>5. Examen MÃ©dico:</strong></p><p style="margin-bottom:0;">Al utilizar esta plataforma, usted reconoce que algunas empresas contratantes pueden requerir, como parte de su proceso de selecciÃ³n y conforme a la ley, la realizaciÃ³n de exÃ¡menes mÃ©dicos y/o pruebas de detecciÃ³n de sustancias.</p></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB1k1lnQjQXiGYJRT9E9-KYzGSBBmrQGFI",
          authDomain: "vacancy-page-v2.firebaseapp.com",
          databaseURL: "https://vacancy-page-v2-default-rtdb.firebaseio.com",
          projectId: "vacancy-page-v2",
          storageBucket: "vacancy-page-v2.firebasestorage.app",
          messagingSenderId: "242419485392",
          appId: "1:242419485392:web:c486a767a1810ada876cd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isAdmin = false;
        let recruitersLoaded = false; // <--- NUEVA BANDERA DE CONTROL
        let isRecruiterMode = false; 
        let currentViewMode = 'grid'; 

        let currentUserEmail = ""; 
        let currentEditId = null;
        let jobs = {};
        let jobStats = {}; 
        let recruiters = {}; 
        let clickLogs = {};
        
        let activeRecruiter = null; 
        let centralPhone = ''; 
        let editingRecruiterId = null; 

        let tempReqs = [];
        let tempBens = [];
        
        let currentPage = 1;
        const itemsPerPage = 15;
        let currentFilteredJobs = []; 

        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) sessionStorage.setItem('recruiterCode', refCode.toLowerCase());

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('cityFilter').value = '';
        });

        window.onpageshow = function(event) {
            if (event.persisted) {
                document.getElementById('searchInput').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('cityFilter').value = '';
            }
        };

        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                if(document.getElementById('viewModal').classList.contains('active')) closeViewModal();
                else if(document.getElementById('formModal').classList.contains('active')) closeFormModal();
                else if(document.getElementById('metricsModal').classList.contains('active')) closeMetricsModal();
                else if(document.getElementById('teamModal').classList.contains('active')) closeTeamModal();
                else if(document.getElementById('settingsModal').classList.contains('active')) closeSettingsModal();
                else if(document.getElementById('privacyModal').classList.contains('active')) closePrivacyModal();
                
                document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
            }
        });

        onAuthStateChanged(auth, (user) => {
            const urlJobId = urlParams.get('id'); 
            if (user) { 
                isAdmin = true; 
                currentUserEmail = user.email; 
                setAdminMode(true); 
            } else {
                isAdmin = false;
                currentUserEmail = "";
                if (sessionStorage.getItem('isGuest') === 'true' || urlJobId) { 
                    setAdminMode(false); 
                } 
                else { showLogin(); }
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
        }

        window.openMetricsModal = function() {
            document.getElementById('metricsModal').classList.add('active');
            populateMetricsList(); 
        }
        window.closeMetricsModal = function() { document.getElementById('metricsModal').classList.remove('active'); }

        window.openTeamModal = function() { document.getElementById('teamModal').classList.add('active'); resetRecruiterForm(); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

        window.openSettingsModal = function() { document.getElementById('settingsModal').classList.add('active'); if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone; }
        window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.remove('active'); }

        window.openPrivacyModal = function() { document.getElementById('privacyModal').classList.add('active'); }
        window.closePrivacyModal = function() { document.getElementById('privacyModal').classList.remove('active'); }

        window.performSafeAction = function(action) {
            if (!isAdmin || !currentUserEmail) {
                alert("Acceso denegado. Debes ser administrador.");
                return;
            }
            if(confirm("âš ï¸ Â¿ESTÃS SEGURO? Esta acciÃ³n es irreversible.")) {
                if (action === 'resetMetrics') {
                    Promise.all([
                        remove(ref(db, 'siteStats')),
                        remove(ref(db, 'jobStats')),
                        remove(ref(db, 'clickLogs'))
                    ]).then(() => {
                        window.showToast("âœ… MÃ©tricas reseteadas a 0");
                    }).catch(error => {
                        alert("âŒ Error al borrar: " + error.message + " (Revisa los permisos)");
                    });
                }
                if (action === 'deleteJobs') deleteAllJobs();
            }
        }

        window.showToast = function(message) {
            const x = document.getElementById("toast");
            if(x) {
                x.textContent = message;
                x.className = "show";
                setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
            }
        }

        function deleteAllJobs() {
            remove(ref(db, 'jobs')).then(() => {
                window.showToast("ğŸ”¥ Todas las vacantes eliminadas");
            });
        }

        window.toggleMobileFilters = function() {
            const container = document.getElementById('filterContainer');
            container.classList.toggle('active');
        }

        window.toggleAdminLogin = function() { const f = document.getElementById('adminForm'); f.style.display = (f.style.display==='none'||f.style.display==='') ? 'block' : 'none'; }
        
        window.login = async function() {
            // 1. LIMPIEZA AGRESIVA: Quitamos espacios al inicio, final y EN MEDIO
            let inputVal = document.getElementById('adminEmail').value.trim();
            const passVal = document.getElementById('adminPassword').value.trim();
            const btn = document.getElementById('btnLogin');

            if (!inputVal || !passVal) return alert("Por favor llena todos los campos");

            const originalText = btn.innerHTML;
            btn.innerHTML = "ğŸ”„ Verificando...";
            btn.disabled = true;

            if (inputVal.includes('@')) {
                // --- Login Admin (Email) ---
                try { 
                    await setPersistence(auth, browserSessionPersistence); 
                    await signInWithEmailAndPassword(auth, inputVal, passVal); 
                    sessionStorage.removeItem('isGuest'); 
                    localStorage.setItem('iamsuperadmin', 'true'); 
                    isRecruiterMode = false;
                } catch (error) { 
                    alert("Error de Admin: " + error.message);
                    btn.innerHTML = originalText; btn.disabled = false;
                }
            } else {
                // --- Login Reclutador ---
                
                // Quitamos espacios internos (ej. convierte "RL 00002" en "RL00002")
                inputVal = inputVal.replace(/\s/g, '').toUpperCase();

                if (!recruitersLoaded) {
                    btn.innerHTML = originalText; btn.disabled = false;
                    return alert("â³ Conectando con el servidor... Intenta de nuevo en 2 segundos.");
                }

                if (passVal !== 'Express*2026') {
                    btn.innerHTML = originalText; btn.disabled = false;
                    return alert("âŒ ContraseÃ±a incorrecta.");
                }

                // Buscar cÃ³digo
                const foundRec = Object.values(recruiters).find(r => r.code === inputVal);
                
                if (foundRec) {
                    sessionStorage.removeItem('isGuest');
                    isAdmin = true; isRecruiterMode = true; activeRecruiter = foundRec;
                    sessionStorage.setItem('recruiterCode', foundRec.code.toLowerCase());
                    
                    setAdminMode(true);
                    toggleViewMode('table');
                    window.showToast(`âœ… Bienvenido: ${foundRec.name}`);
                    
                    // Reset final por si salen despuÃ©s
                    btn.innerHTML = 'Entrar al Panel'; btn.disabled = false;
                } else {
                    btn.innerHTML = originalText; btn.disabled = false;
                    alert(`âŒ El cÃ³digo '${inputVal}' no existe en el sistema.\n\nVerifica con el Administrador que tu cÃ³digo estÃ© dado de alta en la secciÃ³n 'Equipo'.`);
                }
            }
        }
        
        window.enterAsGuest = function() { 
            sessionStorage.setItem('isGuest', 'true'); 
            isAdmin = false; 
            isRecruiterMode = false;
            
            document.getElementById('searchInput').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('cityFilter').value = '';

            setAdminMode(false); 
        }

        window.logout = function() { 
            // Limpieza de modo Sticky
            document.body.classList.remove('admin-mode');

            if (isRecruiterMode) {
                isAdmin = false;
                isRecruiterMode = false;
                sessionStorage.removeItem('recruiterCode');
                location.reload(); 
            } else {
                signOut(auth).then(() => { 
                    sessionStorage.removeItem('isGuest'); 
                    isAdmin = false; 
                    
                    document.getElementById('searchInput').value = '';
                    document.getElementById('stateFilter').value = '';
                    document.getElementById('cityFilter').value = '';

                    showLogin(); 
                }); 
            }
        }

        function showLogin() { 
            document.getElementById('loginScreen').style.display = 'block'; 
            document.getElementById('mainApp').style.display = 'none'; 
            document.getElementById('adminForm').style.display = 'none'; 
            
            // --- CORRECCIÃ“N: Reseteamos el botÃ³n por si se quedÃ³ trabado ---
            const btn = document.getElementById('btnLogin');
            if(btn) { 
                btn.innerHTML = 'Entrar al Panel'; 
                btn.disabled = false; 
            }
        }
        function setAdminMode(enableAdmin) {
            document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block';
            
            const isRefMode = !!refCode;
            
            // Limpieza de clases (Reset)
            document.body.classList.remove('admin-mode', 'recruiter-view');

            if (enableAdmin && (!isRefMode || isRecruiterMode)) {
                
                document.body.classList.add('admin-mode');

                if (isRecruiterMode) {
                    // ACTIVAMOS LA VISTA RECLUTADOR (Oculta botones)
                    document.body.classList.add('recruiter-view');
                    document.getElementById('modeIndicator').innerHTML = '<span class="admin-mode-indicator" style="background:#e3f2fd; color:#0d47a1; border-color:#90caf9;">Modo Reclutador</span>';
                    document.getElementById('viewToggleBtn').style.display = 'none'; 
                } else {
                    document.getElementById('modeIndicator').innerHTML = '<span class="admin-mode-indicator">Super Admin</span>';
                    document.getElementById('viewToggleBtn').style.display = 'inline-flex'; 
                }
                document.getElementById('adminControls').style.display = 'block';
            } else {
                document.getElementById('modeIndicator').innerHTML = '';
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('viewToggleBtn').style.display = 'none';
            }
            loadData();
        }

        window.toggleViewMode = function(forceMode) {
            if (forceMode) {
                currentViewMode = forceMode;
            } else {
                currentViewMode = currentViewMode === 'grid' ? 'table' : 'grid';
            }

            const grid = document.getElementById('jobGrid');
            const table = document.getElementById('jobTableContainer');
            const btn = document.getElementById('viewToggleBtn');
            const searchBar = document.getElementById('userStickyTools'); // <--- EL ELEMENTO A OCULTAR

            if (currentViewMode === 'table') {
                // MODO GESTIÃ“N (Tabla)
                grid.style.display = 'none';
                table.style.display = 'block';
                
                // Ocultamos la barra porque no la necesitamos aquÃ­
                if(searchBar) searchBar.style.display = 'none'; 
                
                btn.innerHTML = 'ğŸ–¼ï¸ Vista Usuario';
                renderJobsTable();
            } else {
                // MODO USUARIO (Fichas)
                grid.style.display = 'grid';
                table.style.display = 'none';
                
                // La mostramos de nuevo porque aquÃ­ es vital
                if(searchBar) searchBar.style.display = 'block';

                btn.innerHTML = 'ğŸ‘ï¸ Vista GestiÃ³n';
                filterJobs(); 
            }
        }

        function parseJobDate(dateString) {
            if (!dateString) return 0;
            let jobDate;
            if (dateString.includes('/')) { 
                const parts = dateString.split('/');
                if (parts.length === 3) jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
            } else if (dateString.includes('-')) { 
                const parts = dateString.split('-');
                if (parts.length === 3) jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
            }
            return jobDate && !isNaN(jobDate.getTime()) ? jobDate.getTime() : 0;
        }

        function loadData() {
            onValue(ref(db, 'jobs'), (s) => { 
                jobs = s.val() || {}; 
                document.getElementById('skeletonLoader').style.display = 'none'; 
                
                if (isRecruiterMode) {
                    toggleViewMode('table');
                } else {
                    document.getElementById('jobGrid').style.display = 'grid';
                    document.getElementById('jobTableContainer').style.display = 'none';
                }

                populateFilters(jobs); 
                if (currentViewMode === 'grid') renderJobs(); 
                else renderJobsTable();
                
                const urlJobId = urlParams.get('id');
                if (urlJobId && jobs[urlJobId]) {
                    const job = jobs[urlJobId];
                    if (job.status !== 'No Vigente' || isAdmin) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        if(!isAdmin) sessionStorage.setItem('isGuest', 'true');
                        window.openViewModal(urlJobId);
                    } else {
                        window.showToast("âš ï¸ Esta vacante ya no estÃ¡ disponible.");
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            });
            onValue(ref(db, 'jobStats'), (s) => { jobStats = s.val() || {}; });
            onValue(ref(db, 'clickLogs'), (s) => { clickLogs = s.val() || {}; });
            
            onValue(ref(db, 'recruiters'), (s) => { 
                recruiters = s.val() || {}; 
                recruitersLoaded = true; // <--- Â¡AQUÃ AVISAMOS QUE YA CARGÃ“!
                checkActiveRecruiter(); 
                if(isAdmin) renderRecruitersTable(); 
            });
            
            onValue(ref(db, 'settings/centralPhone'), (s) => { 
                centralPhone = s.val() || '';
                if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone;
                updateBanner();
            });
        }

        function populateFilters(jobsData) {
            const allJobsArr = Object.values(jobsData);
            const stateSelect = document.getElementById('stateFilter');

            const uniqueStates = [...new Set(allJobsArr.map(j => j.state).filter(Boolean))].sort();
            
            const currState = stateSelect.value;

            let stateHtml = '<option value="">ğŸ“ Estado</option>';
            uniqueStates.forEach(s => {
                stateHtml += `<option value="${s}">${s}</option>`;
            });
            stateSelect.innerHTML = stateHtml;
            stateSelect.value = currState;

            updateCityOptions();
        }

        window.updateCityOptions = function() {
            const stateSelect = document.getElementById('stateFilter');
            const citySelect = document.getElementById('cityFilter');
            const selectedState = stateSelect.value;

            const allJobsArr = Object.values(jobs);

            let availableCities = new Set();
            allJobsArr.forEach(j => {
                if (!selectedState || j.state === selectedState) {
                    if (j.city) availableCities.add(j.city);
                }
            });

            const sortedCities = [...availableCities].sort();

            citySelect.innerHTML = '<option value="">ğŸ™ï¸ Municipio</option>';
            sortedCities.forEach(c => {
                citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            citySelect.value = "";
        }

        window.handleStateChange = function() {
            updateCityOptions(); 
            filterJobs();        
        }

        function checkActiveRecruiter() {
            const savedCode = sessionStorage.getItem('recruiterCode');
            activeRecruiter = null; 
            if (savedCode && recruiters) {
                const foundKey = Object.keys(recruiters).find(key => recruiters[key].code.toLowerCase() === savedCode);
                if (foundKey) { 
                    activeRecruiter = recruiters[foundKey]; 
                }
            }
            updateBanner();
        }

        function updateBanner() {
            const bannerName = document.getElementById('recruiterNameDisplay');
            if(activeRecruiter) {
                bannerName.textContent = activeRecruiter.name;
            } else {
                bannerName.textContent = "Oficina Central";
            }
        }

        window.contactCentralOffice = function() {
            let phoneToContact = '';
            if(activeRecruiter) {
                phoneToContact = activeRecruiter.phone;
            } else {
                phoneToContact = centralPhone;
            }

            if(phoneToContact) {
                const cleanPhone = phoneToContact.replace(/\D/g, '');
                window.open(`https://wa.me/${cleanPhone}?text=Hola,%20necesito%20ayuda%20general`, '_blank');
            } else {
                alert("No hay un nÃºmero de contacto general configurado.");
            }
        }

        window.saveCentralConfig = function() {
            const val = document.getElementById('settingsPhoneInput').value.trim();
            const btn = document.getElementById('btnSaveCentral');
            const originalText = btn.textContent;
            
            btn.textContent = "Guardando...";
            set(ref(db, 'settings/centralPhone'), val)
                .then(() => {
                    window.showToast('âœ… TelÃ©fono de Oficina Central actualizado.');
                    btn.style.backgroundColor = '#2ecc71'; 
                    btn.textContent = 'âœ… Â¡Guardado!';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                })
                .catch((error) => {
                    window.showToast('âŒ Error al guardar: ' + error.message);
                    btn.style.backgroundColor = '#e74c3c'; btn.textContent = 'Error';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                });
        }

        window.openTeamModal = function() { document.getElementById('teamModal').classList.add('active'); resetRecruiterForm(); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

        window.saveRecruiter = function() {
            const name = document.getElementById('recName').value.trim();
            const rawPhone = document.getElementById('recPhone').value.trim();
            const phoneCode = document.getElementById('recPhoneCode').value;
            const code = document.getElementById('recCode').value.toUpperCase().replace(/\s/g, '');
            
            if(!name || !rawPhone || !code) return alert('Por favor, llena todos los campos.');
            
            let cleanPhone = rawPhone.replace(/\D/g, '');
            const codeDigits = phoneCode.replace('+', '');
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            
            const finalPhone = phoneCode + cleanPhone;

            const duplicateCheck = Object.entries(recruiters).find(([key, r]) => { return r.code === code && key !== editingRecruiterId; });
            if (duplicateCheck) { return alert(`âš ï¸ ERROR: El cÃ³digo '${code}' ya estÃ¡ siendo usado por ${duplicateCheck[1].name}. Usa otro.`); }
            
            const idToSave = editingRecruiterId || 'rec-' + Date.now();
            set(ref(db, 'recruiters/' + idToSave), { name, phone: finalPhone, code }).then(() => { window.showToast(editingRecruiterId ? 'âœ… Reclutador actualizado' : 'âœ… Reclutador agregado'); resetRecruiterForm(); });
        }

        window.editRecruiter = function(id) {
            const r = recruiters[id]; if(!r) return;
            document.getElementById('recName').value = r.name; 
            
            let phoneVal = r.phone;
            if(phoneVal.startsWith('+52')) { document.getElementById('recPhoneCode').value = '+52'; phoneVal = phoneVal.replace('+52',''); }
            else if(phoneVal.startsWith('+1')) { document.getElementById('recPhoneCode').value = '+1'; phoneVal = phoneVal.replace('+1',''); }
            document.getElementById('recPhone').value = phoneVal; 

            document.getElementById('recCode').value = r.code;
            editingRecruiterId = id; const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Guardar Cambios"; btn.style.backgroundColor = "#f57c00"; 
            document.getElementById('btnCancelRecruiter').style.display = 'block';
        }

        window.resetRecruiterForm = function() {
            document.getElementById('recName').value = ''; document.getElementById('recPhone').value = ''; document.getElementById('recCode').value = ''; editingRecruiterId = null;
            const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Agregar"; btn.style.backgroundColor = "#0a66c2"; 
            document.getElementById('btnCancelRecruiter').style.display = 'none';
        }

        window.deleteRecruiter = function(id) { if(confirm('Â¿Seguro que quieres eliminar a este reclutador?')) { remove(ref(db, 'recruiters/' + id)); if(editingRecruiterId === id) resetRecruiterForm(); } }
        
        window.copyLink = function(code) { 
            const link = `${window.location.origin}/?ref=${code}`; 
            navigator.clipboard.writeText(link).then(() => window.showToast('Link copiado')); 
        }

        window.copyJobLink = function(jobId) {
             const refCode = sessionStorage.getItem('recruiterCode');
             const url = `${window.location.origin}/?id=${jobId}${refCode ? '&ref='+refCode : ''}`;
             navigator.clipboard.writeText(url).then(() => window.showToast('ğŸ”— Link de vacante copiado'));
        }
        
        function renderRecruitersTable() {
            const list = document.getElementById('recruitersList');
            if(Object.keys(recruiters).length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay reclutadores</td></tr>'; return; }
            list.innerHTML = Object.keys(recruiters).map(key => { 
                const r = recruiters[key]; 
                return `<tr><td>${r.name}</td><td><b>${r.code}</b></td><td><button class="copy-btn" onclick="copyLink('${r.code}')">Copiar</button></td><td><button onclick="editRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">âœï¸</button><button onclick="deleteRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">ğŸ—‘ï¸</button></td></tr>`; 
            }).join('');
        }

        function populateMetricsList() {
            const list = document.getElementById('metricsMonthList');
            if(!jobStats) { list.innerHTML = 'No hay datos'; return; }
            
            const months = new Set();
            Object.values(clickLogs).forEach(log => {
                if(log && log.timestamp && typeof log.timestamp === 'string') {
                    try { months.add(log.timestamp.substring(0, 7)); } catch(e){}
                }
            });
            Object.values(jobStats).forEach(stat => {
                if(stat && stat.monthlyViews) {
                    Object.keys(stat.monthlyViews).forEach(m => months.add(m));
                }
            });

            if(months.size === 0) months.add(currentMonthKey);

            const sortedMonths = Array.from(months).sort().reverse();
            
            list.innerHTML = sortedMonths.map(m => 
                `<label style="display:block; padding:5px; border-bottom:1px solid #eee;">
                    <input type="checkbox" value="${m}" checked> ${m}
                </label>`
            ).join('');
        }

        window.downloadSelectedMetrics = function() {
            const checkboxes = document.querySelectorAll('#metricsMonthList input:checked');
            const selectedMonths = Array.from(checkboxes).map(cb => cb.value);
            
            if(selectedMonths.length === 0) return alert("Selecciona al menos un mes");

            window.showToast("ğŸ“Š Generando reporte detallado...");

            const dataRows = [];
            
            Object.keys(jobs).forEach(jobId => {
                const j = jobs[jobId];
                const s = jobStats[jobId] || {};
                
                let totalViews = 0;
                let totalClicks = 0;

                selectedMonths.forEach(m => {
                    if(s.monthlyViews && s.monthlyViews[m]) {
                        totalViews += s.monthlyViews[m];
                    }
                });
                
                const clicksInMonths = Object.values(clickLogs).filter(l => 
                    l && l.jobId === jobId && 
                    l.timestamp && typeof l.timestamp === 'string' &&
                    selectedMonths.includes(l.timestamp.substring(0,7))
                ).length;

                dataRows.push({
                    'ID': jobId,
                    'TÃ­tulo': j.title,
                    'Empresa': j.company,
                    'Vistas (Meses selecc.)': totalViews,
                    'Clics WhatsApp (Meses selecc.)': clicksInMonths,
                    'Estatus': j.status
                });
            });

            const recruiterMap = {};
            let totalRecruiterClicks = 0;
            Object.values(clickLogs).forEach(l => {
                if(l && l.timestamp && typeof l.timestamp === 'string' && selectedMonths.includes(l.timestamp.substring(0,7))) {
                    const recName = l.recruiter || 'OrgÃ¡nico';
                    if(!recruiterMap[recName]) recruiterMap[recName] = 0;
                    recruiterMap[recName]++;
                    totalRecruiterClicks++;
                }
            });
            let recruiterRows = Object.keys(recruiterMap).map(name => ({
                'Reclutador': name,
                'Clics Generados': recruiterMap[name],
                '% del Total': totalRecruiterClicks > 0 ? ((recruiterMap[name] / totalRecruiterClicks) * 100).toFixed(2) + '%' : '0%'
            }));
            if (recruiterRows.length === 0) recruiterRows = [{'Reclutador': 'Sin datos', 'Clics': 0}];

            const detailMap = {}; 

            Object.keys(jobs).forEach(jobId => {
                const j = jobs[jobId];
                const s = jobStats[jobId] || {};
                
                if (s.viewsByRecruiter) {
                    Object.keys(s.viewsByRecruiter).forEach(recCode => {
                        let recName = 'OrgÃ¡nico';
                        if (recCode !== 'ORGANICO') {
                            const foundRec = Object.values(recruiters).find(r => r.code === recCode);
                            recName = foundRec ? foundRec.name : recCode;
                        }

                        const key = `${jobId}_${recName}`;
                        if (!detailMap[key]) detailMap[key] = { jobId: jobId, title: j.title, recruiter: recName, views: 0, clicks: 0 };
                        
                        detailMap[key].views = s.viewsByRecruiter[recCode];
                    });
                }
            });

            Object.values(clickLogs).forEach(l => {
                if(l && l.jobId && l.timestamp && typeof l.timestamp === 'string' && selectedMonths.includes(l.timestamp.substring(0,7))) {
                    const j = jobs[l.jobId];
                    const jobTitle = j ? j.title : 'Vacante Borrada';
                    const recName = l.recruiter || 'OrgÃ¡nico';
                    
                    const key = `${l.jobId}_${recName}`;
                    if (!detailMap[key]) detailMap[key] = { jobId: l.jobId, title: jobTitle, recruiter: recName, views: 0, clicks: 0 };
                    
                    detailMap[key].clicks++;
                }
            });

            let detailRows = Object.values(detailMap).map(d => ({
                'ID Vacante': d.jobId,
                'Vacante': d.title,
                'Reclutador': d.recruiter,
                'Vistas Totales (HistÃ³rico)': d.views, 
                'Clics (Meses selecc.)': d.clicks,
                'Conversion %': d.views > 0 ? ((d.clicks / d.views) * 100).toFixed(1) + '%' : '0%'
            }));

            if (detailRows.length === 0) detailRows = [{'Mensaje': 'AÃºn no hay interacciÃ³n detallada registrada'}];

            const wb = XLSX.utils.book_new();
            
            const ws1 = XLSX.utils.json_to_sheet(dataRows);
            XLSX.utils.book_append_sheet(wb, ws1, "DesempeÃ±o Vacantes");

            const ws2 = XLSX.utils.json_to_sheet(recruiterRows);
            XLSX.utils.book_append_sheet(wb, ws2, "Rendimiento Equipo");

            const summaryRows = [
                { 'MÃ©trica': 'Periodo Analizado', 'Valor': selectedMonths.join(', ') },
                { 'MÃ©trica': 'Total Vistas', 'Valor': dataRows.reduce((a,b)=>a+b['Vistas (Meses selecc.)'],0) },
                { 'MÃ©trica': 'Total Clics (Leads)', 'Valor': dataRows.reduce((a,b)=>a+b['Clics WhatsApp (Meses selecc.)'],0) }
            ];
            const ws3 = XLSX.utils.json_to_sheet(summaryRows);
            XLSX.utils.book_append_sheet(wb, ws3, "Resumen Global");

            const ws4 = XLSX.utils.json_to_sheet(detailRows);
            XLSX.utils.book_append_sheet(wb, ws4, "Detalle Rec-Vacante");

            XLSX.writeFile(wb, `Reporte_TuChamba_${selectedMonths.join('_')}.xlsx`);
        }

        window.handleWhatsAppClick = function(btn, jobId, recruiterName, link) {
            const clickedKey = `clic_${jobId}_${new Date().toISOString().split('T')[0]}`; 
            const alreadyClicked = localStorage.getItem(clickedKey);

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ğŸ”„ Abriendo...';

            if (!alreadyClicked) {
                console.log("âœ… Nuevo interesado detectado");
                localStorage.setItem(clickedKey, 'true');
                window.registerClick(jobId, recruiterName);
            } else {
                console.log("âš ï¸ Clic repetido (Ignorado)");
            }

            setTimeout(() => { window.open(link, '_blank'); }, 300); 
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000);
        }

        window.registerClick = function(jobId, recruiterName) {
            runTransaction(ref(db, `jobStats/${jobId}/whatsappClicks`), (c) => (c || 0) + 1);
            push(ref(db, 'clickLogs'), { jobId, recruiter: recruiterName || 'OrgÃ¡nico', timestamp: new Date().toISOString(), date_readable: new Date().toLocaleString() });
        }

        window.generateFlyer = function(jobId) {
            const j = jobs[jobId];
            if (!j) return;

            window.showToast("ğŸ¨ Creando Flyer...");

            document.getElementById('flyerTitle').innerText = j.title;
            document.getElementById('flyerSalary').innerText = j.salary || 'Sueldo Competitivo';
            
            const benefitsList = document.getElementById('flyerBenefitsList');
            benefitsList.innerHTML = '';
            if(j.benefits && j.benefits.length > 0) {
                j.benefits.slice(0, 4).forEach(ben => {
                    const li = document.createElement('li');
                    li.innerText = 'âœ… ' + ben;
                    benefitsList.appendChild(li);
                });
            } else {
                 benefitsList.innerHTML = '<li>âœ… Prestaciones de Ley</li><li>âœ… ContrataciÃ³n Inmediata</li><li>âœ… Excelente Ambiente</li>';
            }

            const qrContainer = document.getElementById('flyerQr');
            qrContainer.innerHTML = ''; 
            
            const refCode = sessionStorage.getItem('recruiterCode');
            const jobLink = `${window.location.origin}/?id=${jobId}${refCode ? '&ref='+refCode : ''}`;

            new QRCode(qrContainer, {
                text: jobLink,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const flyerNode = document.getElementById('flyerTemplate');
                
                html2canvas(flyerNode, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: false, 
                    backgroundColor: null 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Flyer_${j.title.replace(/\s+/g, '_')}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    window.showToast("âœ… Â¡Flyer descargado!");
                }).catch(err => {
                    console.error(err);
                    alert("Error al generar imagen: " + err.message);
                });
            }, 500); 
        }

        const visitsRef = ref(db, 'siteStats/visits');
        const monthlyRef = ref(db, `siteStats/monthly/${currentMonthKey}`);
        
        const isMyDevice = localStorage.getItem('iamsuperadmin');
        const alreadyVisited = localStorage.getItem('visited_v2');

        if (!alreadyVisited && !isMyDevice) { 
            runTransaction(visitsRef, (c) => (c || 0) + 1); 
            runTransaction(monthlyRef, (c) => (c || 0) + 1); 
            localStorage.setItem('visited_v2', 'true'); 
        }
        
        onValue(visitsRef, (s) => { if(document.getElementById('totalVisits')) document.getElementById('totalVisits').innerText = s.val() || 0; });
        onValue(monthlyRef, (s) => { if(document.getElementById('monthlyVisits')) document.getElementById('monthlyVisits').innerText = s.val() || 0; });

        window.saveJob = function(e) {
            e.preventDefault();
            
            const phoneCode = document.getElementById('jobPhoneCode').value;
            const rawPhone = document.getElementById('jobContact').value.trim();
            
            let cleanPhone = rawPhone.replace(/\D/g, '');
            const codeDigits = phoneCode.replace('+', '');
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            const finalPhone = cleanPhone ? (phoneCode + cleanPhone) : '';

            const isFeaturedVal = document.getElementById('jobIsFeatured').value === 'true';

            const jobData = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                showCompany: document.getElementById('jobShowCompany').value === 'true', 
                state: document.getElementById('jobState').value,
                city: document.getElementById('jobCity').value,
                zone: document.getElementById('jobZone').value,
                location: `${document.getElementById('jobCity').value}, ${document.getElementById('jobState').value}`,
                
                fecha: document.getElementById('jobDate').value, 
                
                salary: document.getElementById('jobSalary').value,
                description: document.getElementById('jobDescription').value,
                schedule: document.getElementById('jobSchedule').value, 
                tags: document.getElementById('jobTags').value,
                contact: finalPhone, 
                status: document.getElementById('jobStatus').value,
                agency: document.getElementById('jobAgency').value,
                requirements: tempReqs,
                benefits: tempBens,
                isFeatured: isFeaturedVal 
            };
            const id = currentEditId || 'job-' + Date.now();
            set(ref(db, 'jobs/' + id), jobData).then(() => {
                window.showToast("âœ… Vacante guardada");
                window.closeFormModal();
            });
        }

        window.deleteJob = function(id) { if(confirm('Â¿Borrar vacante?')) remove(ref(db, 'jobs/' + id)); }

        function normalizeText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : ""; }

        function formatDateFriendly(dateString) {
            return dateString || '';
        }

        function isNewJob(dateString) {
            if (!dateString) return false;
            let jobDate;
            
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } 
            else if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }
            }

            if (!jobDate || isNaN(jobDate.getTime())) return false;

            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const diffTime = Math.abs(today - jobDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays <= 3;
        }

        // --- VARIABLES DE ORDENAMIENTO ---
        let currentSortCol = '';   // QuÃ© columna estamos ordenando
        let currentSortAsc = true; // true = A-Z, false = Z-A

        // FunciÃ³n para cambiar el orden al dar clic
        window.handleSort = function(colName) {
            if (currentSortCol === colName) {
                currentSortAsc = !currentSortAsc; // Si es la misma, invierte el orden
            } else {
                currentSortCol = colName;
                currentSortAsc = true; // Si es nueva, empieza A-Z
            }
            renderJobsTable(); // Redibuja la tabla
        }

        function renderJobsTable() {
            let keys = Object.keys(jobs);

            // LÃ“GICA DE ORDENAMIENTO
            if (currentSortCol) {
                keys.sort((a, b) => {
                    let valA = '', valB = '';
                    const jA = jobs[a];
                    const jB = jobs[b];

                    // Definir quÃ© valor comparar segÃºn la columna
                    switch(currentSortCol) {
                        case 'company': valA = jA.company; valB = jB.company; break;
                        case 'title': valA = jA.title; valB = jB.title; break;
                        case 'status': valA = jA.status; valB = jB.status; break;
                        case 'location': valA = jA.city + jA.state; valB = jB.city + jB.state; break;
                        case 'salary': valA = jA.salary; valB = jB.salary; break;
                        default: return 0;
                    }

                    // Limpiar textos para comparar bien (minÃºsculas y sin acentos)
                    valA = valA ? valA.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
                    valB = valB ? valB.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

                    if (valA < valB) return currentSortAsc ? -1 : 1;
                    if (valA > valB) return currentSortAsc ? 1 : -1;
                    return 0;
                });
            } else {
                // Orden por defecto (Fecha/ID descendente)
                keys.sort((a,b) => b.localeCompare(a));
            }

            const tableBody = document.getElementById('jobTableBody');
            let html = '';
            let count = 1;

            keys.forEach(id => {
                const j = jobs[id];
                const loc = `${j.city}, ${j.state}`;
                const salary = j.salary || 'N/A';
                
                // Estatus en una lÃ­nea
                const statusBadge = j.status === 'No Vigente' 
                    ? '<span style="white-space: nowrap; background:#ffebee; color:#c62828; padding:5px 10px; border-radius:15px; font-weight:bold; font-size:12px;">ğŸ”´ No Vigente</span>' 
                    : '<span style="white-space: nowrap; background:#e8f5e9; color:#2e7d32; padding:5px 10px; border-radius:15px; font-weight:bold; font-size:12px;">ğŸŸ¢ Vigente</span>';

                html += `
                    <tr>
                        <td>${count}</td>
                        <td style="font-weight:bold; color:#0a66c2;">${j.company}</td>
                        <td>${j.title}</td>
                        <td>${loc}</td>
                        <td style="color:#d32f2f; font-weight:bold;">${salary}</td>
                        <td>${statusBadge}</td>
                        <td>
                             <button class="action-icon-btn" title="Descargar Flyer" onclick="window.generateFlyer('${id}')">ğŸ–¼ï¸</button>
                             <button class="action-icon-btn" title="Copiar Link" onclick="window.copyJobLink('${id}')">ğŸ”—</button>
                             ${isAdmin && !isRecruiterMode ? `<button class="action-icon-btn" title="Editar" onclick="window.editJob('${id}')">âœï¸</button>` : ''}
                        </td>
                    </tr>
                `;
                count++;
            });
            tableBody.innerHTML = html;
        }

        function renderJobs() {
            let keys = Object.keys(jobs);
            
            keys.sort((a, b) => {
                const jobA = jobs[a]; const jobB = jobs[b];
                const statusA = jobA.status === 'No Vigente' ? 1 : 0;
                const statusB = jobB.status === 'No Vigente' ? 1 : 0;
                if (statusA !== statusB) return statusA - statusB;
                
                const featA = jobA.isFeatured ? 1 : 0;
                const featB = jobB.isFeatured ? 1 : 0;
                if (featA !== featB) return featB - featA; 

                const dateA = parseJobDate(jobA.fecha);
                const dateB = parseJobDate(jobB.fecha);
                
                if (dateA !== dateB) {
                    return dateB - dateA; 
                }
                return b.localeCompare(a); 
            });

            currentFilteredJobs = keys; 
            currentPage = 1; 
            applyFilterAndRender();
        }

        window.clearSearch = function() {
            document.getElementById('searchInput').value = '';
            filterJobs();
            document.getElementById('searchInput').focus();
        }

        function applyFilterAndRender() {
            if (currentViewMode === 'table') return; 

            const stateVal = document.getElementById('stateFilter').value;
            const cityVal = document.getElementById('cityFilter').value;
            const searchInput = document.getElementById('searchInput');
            const searchText = normalizeText(searchInput.value);
            
            const clearBtn = document.getElementById('clearSearchBtn');
            clearBtn.style.display = searchText.length > 0 ? 'flex' : 'none';

            const matchedKeys = currentFilteredJobs.filter(id => {
                const j = jobs[id];
                if (!isAdmin && j.status === 'No Vigente') return false;

                const matchState = stateVal === '' || j.state === stateVal;
                const matchCity = cityVal === '' || j.city === cityVal;
                
                let matchSearch = true;
                if(searchText) {
                    const fullText = normalizeText(`${j.title} ${j.company} ${j.tags} ${j.description}`);
                    matchSearch = fullText.includes(searchText);
                }

                return matchState && matchCity && matchSearch;
            });

            document.getElementById('jobCounter').textContent = `${matchedKeys.length} vacantes encontradas`;
            
            if (matchedKeys.length === 0) {
                document.getElementById('jobGrid').innerHTML = '';
                document.getElementById('paginationContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            const totalPages = Math.ceil(matchedKeys.length / itemsPerPage);
            if(currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const visibleKeys = matchedKeys.slice(startIndex, endIndex);

            const grid = document.getElementById('jobGrid');
            grid.innerHTML = visibleKeys.map(id => {
                const j = jobs[id];
                const tags = j.tags ? j.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                const isVigente = j.status !== 'No Vigente';
                
                let statusBadge = '<span class="badge-closed">Cerrada</span>';
                if(isVigente) statusBadge = '<span class="badge-vigente">ğŸŸ¢ Vigente</span>';

                const showAdminButtons = isAdmin && !refCode;
                const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
                const finalCompanyName = (isAdmin && !refCode) || showNamePublicly ? j.company : "Empresa Confidencial";
                
                const verifiedHtml = showNamePublicly ? '<span class="verified-badge" title="Empresa Verificada">âœ“</span>' : '';

                let displayLocation = j.location;
                if (j.city && j.state) displayLocation = `${j.city}, ${j.state}`;

                const niceDate = formatDateFriendly(j.fecha);
                const dateHtml = niceDate ? `<span class="card-header-date">ğŸ“… PublicaciÃ³n: ${niceDate}</span>` : '';
                const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">ğŸ”¥ Nueva</span>' : '';

                const featuredBadge = j.isFeatured ? '<div class="badge-featured">â­ DESTACADA</div>' : '';

                return `
                    <div class="job-card" onclick="window.openViewModal('${id}')">
                        ${featuredBadge}
                        ${showAdminButtons ? `<button class="more-btn" onclick="event.stopPropagation(); window.toggleMenu('${id}')">â‹®</button>
                        <div class="admin-actions" id="menu-${id}">
                            <button class="admin-action" onclick="event.stopPropagation(); window.editJob('${id}')">âœï¸ Editar</button>
                            <button class="admin-action" onclick="event.stopPropagation(); window.generateFlyer('${id}')">ğŸ–¼ï¸ Descargar Flyer</button>
                            <button class="admin-action delete" onclick="event.stopPropagation(); window.deleteJob('${id}')">ğŸ—‘ï¸ Eliminar</button>
                        </div>` : ''}
                        
                        <div class="card-header-top">
                            <div>
                                ${statusBadge}
                                ${newBadge}
                            </div>
                        </div>
                        ${dateHtml}
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px; margin-top: 10px;">
                            <div class="company-logo">${j.company.charAt(0)}</div>
                            <div>
                                <div class="job-title">${j.title}</div>
                                <div class="company-name">${finalCompanyName} ${verifiedHtml}</div>
                            </div>
                        </div>
                        
                        <div class="location">ğŸ“ ${displayLocation}</div>
                        <div class="salary-text">ğŸ’° ${j.salary || 'A convenir'}</div>
                        
                        ${tags.length > 0 ? `<div class="tags">${tags.slice(0,3).map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            }).join('');

            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            const container = document.getElementById('paginationContainer');
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';
            
            let html = '';
            
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span style="color:#999;">...</span>`;
                }
            }

            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente &raquo;</button>`;
            
            html += `<div class="page-info">PÃ¡gina ${currentPage} de ${totalPages}</div>`;
            
            container.innerHTML = html;
        }

        // FunciÃ³n para cambiar pÃ¡gina: TÃ‰CNICA "DESAPARECER EL ANCLA" âš“ğŸš«
        window.changePage = function(newPage) {
            // 1. Quitar foco del clic
            if (document.activeElement) document.activeElement.blur();
            
            currentPage = newPage;
            
            if (currentViewMode === 'table') {
                // Renderizamos los datos nuevos
                renderJobsTable(); 
                
                // --- TRUCO MAESTRO ---
                // Forzamos que los botones de abajo DESAPAREZCAN un instante.
                // Al no haber "piso" abajo, el navegador no puede anclarse y subirÃ¡ sÃ­ o sÃ­.
                const pagContainer = document.getElementById('paginationContainer');
                if(pagContainer) pagContainer.style.display = 'none';

                // Ordenamos subir (ahora sÃ­ nos obedecerÃ¡)
                window.scrollTo(0, 0);
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
                
                // Hacemos reaparecer los botones un parpadeo despuÃ©s
                setTimeout(() => {
                    if(pagContainer) {
                        // RenderJobsTable calcula si debe ser flex o none, aquÃ­ lo forzamos a flex si hay pÃ¡ginas
                        pagContainer.style.display = 'flex'; 
                    }
                }, 100);

            } else {
                // MODO USUARIO (Fichas) - Este ya funcionaba, no le movemos
                applyFilterAndRender(); 
                const topHeader = document.querySelector('.header');
                if(topHeader) {
                     setTimeout(() => {
                        topHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }, 100); 
                }
            }
        }

        window.filterJobs = function() {
            currentPage = 1; 
            applyFilterAndRender();
        }

        window.loadMoreJobs = function() {
            displayLimit += 20;
            applyFilterAndRender();
        }

        window.toggleMenu = function(id) { 
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active')); 
            document.getElementById(`menu-${id}`).classList.toggle('active'); 
        }

        window.openViewModal = function(id) {
            const j = jobs[id];
            const isRefMode = !!refCode;

            if (!isAdmin || isRefMode) {
                runTransaction(ref(db, `jobStats/${id}/totalViews`), (c) => (c || 0) + 1);
                runTransaction(ref(db, `jobStats/${id}/monthlyViews/${currentMonthKey}`), (c) => (c || 0) + 1);
                
                const recCodeSafe = activeRecruiter ? activeRecruiter.code : 'ORGANICO';
                runTransaction(ref(db, `jobStats/${id}/viewsByRecruiter/${recCodeSafe}`), (c) => (c || 0) + 1);
            }
            
            document.title = `Trabajo en ${j.city || 'MÃ©xico'} - ${j.title} | TuChamba`;

            const stats = jobStats[id] || {};
            const totalViews = stats.totalViews || 0;
            const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
            const companyDisplay = (isAdmin && !isRefMode) || showNamePublicly ? j.company : "Empresa Confidencial";
            
            let contactHtml = '';
            let targetPhone = '';
            let isReferral = false;

            let excelContact = j.contact ? j.contact.replace(/\D/g, '') : '';
            let isExcelContactValid = excelContact.length >= 10;

            if (activeRecruiter) { 
                targetPhone = activeRecruiter.phone; 
                isReferral = true; 
            } 
            else if (isExcelContactValid) { 
                targetPhone = excelContact; 
            } 
            else if (centralPhone) { 
                targetPhone = centralPhone.replace(/\D/g, ''); 
            }

            if (targetPhone) {
                let msg = `Hola, vi la vacante ${j.title} (CÃ³d: ${id})`;
                if(isReferral) msg += ` (Referido por ${activeRecruiter.name})`;
                const waLink = `https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`;
                const recNameSafe = activeRecruiter ? activeRecruiter.name : 'OrgÃ¡nico';
                
                contactHtml = `<div class="sticky-footer">
                                    <p style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ‘‡ Respuesta Inmediata ğŸ‘‡</p>
                                    <button onclick="window.handleWhatsAppClick(this, '${id}', '${recNameSafe}', '${waLink}')" class="whatsapp-btn-large">
                                        ğŸ“… Â¡Haz Clic para Agendar Entrevista! ğŸ“²
                                    </button>
                               </div>`;
            }

            let adminInfoHtml = '';
            if (isAdmin && !isRefMode) {
                adminInfoHtml = `<div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom: 15px;">
                        <div class="view-count-badge">ğŸ‘ï¸ ${totalViews} Vistas</div>
                        <div class="agency-badge">${j.agency || 'Sin asignar'}</div>
                    </div>`;
            }

            let locationDetail = j.location;
            if (j.state && j.city) locationDetail = `${j.city}, ${j.state} ${j.zone ? '('+j.zone+')' : ''}`;
            
            const isVigente = j.status !== 'No Vigente';
            const badgeHtml = isVigente ? '<span class="badge-vigente">ğŸŸ¢ Vigente</span>' : '<span class="badge-closed">Cerrada</span>';
            const niceDate = formatDateFriendly(j.fecha);
            const dateHtml = niceDate ? `<span class="card-header-date">ğŸ“… PublicaciÃ³n: ${niceDate}</span>` : '';
            const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">ğŸ”¥ Nueva</span>' : '';

            const shareUrl = `${window.location.origin}/?id=${id}${refCode ? '&ref='+refCode : ''}`;
            
            document.getElementById('viewModalBody').innerHTML = `
                ${adminInfoHtml}
                
                <div style="margin-bottom:10px;">
                    ${badgeHtml} ${newBadge}
                </div>
                ${dateHtml}

                <h2 style="font-size: 26px; margin-top: 15px; margin-bottom: 10px; color:#222; line-height:1.2;">
                    ${j.title}
                </h2>
                
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                    <div style="font-size: 18px; color: #0a66c2; font-weight:600;">${companyDisplay}</div>
                    <button class="modal-share-btn" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => window.showToast('ğŸ”— Link copiado'))">ğŸ”— Compartir</button>
                </div>

                <div class="job-details" style="background:#f8f9fa; padding:15px; border-radius:12px;">
                    <div class="detail-item">
                        <div style="font-weight:bold; color:#555;">ğŸ“ Zona:</div>
                        <div>${locationDetail}</div>
                    </div>
                    <div class="detail-item">
                        <div style="font-weight:bold; color:#d32f2f;">ğŸ’° Sueldo:</div>
                        <div class="salary-text" style="margin-top:0;">${j.salary || 'A convenir'}</div>
                    </div>
                    <div class="detail-item">
                        <div style="font-weight:bold; color:#555;">ğŸ•’ Jornada:</div>
                        <div>${j.schedule || 'Horario a definir'}</div>
                    </div>
                </div>

                <div class="section-title">DescripciÃ³n del Puesto</div>
                <p style="color: #444; line-height: 1.45; font-size:15px; margin-bottom:20px;">${j.description}</p>
                
                ${(j.requirements||[]).length ? `<div class="section-title">Requisitos</div><ul class="item-list">${j.requirements.map(r=>`<li>${r}</li>`).join('')}</ul>` : ''}
                
                ${(j.benefits||[]).length ? `<div class="section-title">Ofrecemos</div><ul class="item-list">${j.benefits.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
                
                ${contactHtml}
            `;
            document.getElementById('viewModal').classList.add('active');
        }

        window.closeViewModal = function() { 
            document.title = "TuChamba Express | Vacantes Urgentes en Nuevo LeÃ³n, CDMX y EdoMex 2026";
            document.getElementById('viewModal').classList.remove('active'); 
        }
        window.closeFormModal = function() { document.getElementById('formModal').classList.remove('active'); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }
        
        window.openJobForm = function() {
            currentEditId = null; document.getElementById('formTitle').textContent = 'Nueva Vacante'; document.getElementById('jobForm').reset();
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('jobDate').value = todayISO; 
            
            tempReqs = []; tempBens = []; updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('jobShowCompany').value = 'true';
            document.getElementById('formModal').classList.add('active');
        }

        window.editJob = function(id) {
            currentEditId = id; const j = jobs[id];
            document.getElementById('formTitle').textContent = 'Editar Vacante';
            document.getElementById('jobTitle').value = j.title; document.getElementById('jobCompany').value = j.company;
            document.getElementById('jobShowCompany').value = (j.showCompany === false || j.showCompany === 'false') ? 'false' : 'true';
            document.getElementById('jobState').value = j.state || '';
            document.getElementById('jobCity').value = j.city || '';
            document.getElementById('jobZone').value = j.zone || '';
            
            document.getElementById('jobDate').value = j.fecha || ''; 

            if(!j.city && j.location) document.getElementById('jobCity').value = j.location;
            document.getElementById('jobSalary').value = j.salary||'';
            document.getElementById('jobDescription').value = j.description; document.getElementById('jobStatus').value = j.status||'Vigente';
            document.getElementById('jobAgency').value = j.agency||'';
            
            let contactVal = j.contact || '';
            let codeVal = '+52';
            if(contactVal.startsWith('+52')) { codeVal = '+52'; contactVal = contactVal.replace('+52',''); }
            else if(contactVal.startsWith('+1')) { codeVal = '+1'; contactVal = contactVal.replace('+1',''); }
            document.getElementById('jobPhoneCode').value = codeVal;
            document.getElementById('jobContact').value = contactVal;

            document.getElementById('jobSchedule').value = j.schedule||''; 
            tempReqs = j.requirements||[]; tempBens = j.benefits||[];
            updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('formModal').classList.add('active');
        }

        window.addItem = function(type) {
            const val = document.getElementById(type+'Input').value.trim();
            if(val) { (type==='req'?tempReqs:tempBens).push(val); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); document.getElementById(type+'Input').value=''; }
        }
        window.removeItem = function(type, i) { (type==='req'?tempReqs:tempBens).splice(i,1); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); }
        function updateList(id, arr, type) { document.getElementById(id).innerHTML = arr.map((item,i)=>`<li>${item}<button onclick="removeItem('${type}',${i})" style="color:red;border:none;background:none;cursor:pointer">Ã—</button></li>`).join(''); }

        window.exportToExcel = function() {
            if(!Object.keys(jobs).length) return alert('Sin datos');
            const data = Object.keys(jobs).map(id => {
                const j = jobs[id];
                return { 
                    'ID': id, 'TÃ­tulo': j.title, 'Empresa': j.company, 
                    'Mostrar Empresa Publicamente': (j.showCompany === true || j.showCompany === 'true') ? 'SI' : 'NO',
                    'Estado': j.state, 'Municipio': j.city, 'Zona': j.zone, 
                    'Fecha': j.fecha, 
                    'Salario': j.salary, 'DescripciÃ³n': j.description, 
                    'Jornada': j.schedule, 
                    'Etiquetas': j.tags,
                    'Requisitos': (j.requirements||[]).join(' | '), 
                    'Beneficios': (j.benefits||[]).join(' | '),
                    'Contacto': j.contact, 'Estatus': j.status, 'Tipo de Servicio o Agencia': j.agency,
                    'IMPULSAR': j.isFeatured ? 'SI' : 'NO' 
                };
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Vacantes"); XLSX.writeFile(wb, "Respaldo_Completo.xlsx");
        }

        window.downloadTemplate = function() {
            const data = [{
                'ID': 'ej-1', 
                'FECHA': '15/01/2026', 
                'TÃTULO': 'Ejemplo', 
                'EMPRESA': 'Empresa', 
                'MOSTRAR EMPRESA PUBLICAMENTE': 'SI',
                'ESTADO': 'CDMX', 
                'MUNICIPIO': 'CoyoacÃ¡n', 
                'ZONA': 'Centro',
                'SALARIO': '10000', 
                'DESCRIPCIÃ“N': 'Desc...', 
                'JORNADA': 'Lunes a Viernes', 
                'ETIQUETAS': '#Ventas', 
                'REQUISITOS': 'Req 1 | Req 2', 
                'BENEFICIOS': 'Ben 1 | Ben 2', 
                'CONTACTO': '5512345678', 
                'ESTATUS': 'Vigente', 
                'TIPO DE SERVICIO O AGENCIA': 'Agencia Interna',
                'IMPULSAR': 'SI'
            }];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla'); XLSX.writeFile(wb, 'plantilla.xlsx');
        }

        window.shareApp = async function() {
             const refCode = sessionStorage.getItem('recruiterCode');
             const encodedRef = refCode ? encodeURIComponent(refCode) : '';
             const url = encodedRef ? `${window.location.origin}/?ref=${encodedRef}` : window.location.href;
             
             const data = { 
                 title: 'TuChamba', 
                 text: 'Â¡Checa esta vacante! ContrataciÃ³n rÃ¡pida en CDMX, NL y EdoMex. Detalles aquÃ­:', 
                 url: url 
             };
             if(navigator.share) await navigator.share(data); else window.open(`https://wa.me/?text=${encodeURIComponent(data.text+' '+data.url)}`);
        }
        
        window.importFromExcel = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    if(!json.length) { alert('Archivo vacÃ­o'); return; }
                    let count = 0;
                    
                    const normalizeKey = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

                    const findKey = (row, keyName) => {
                        return Object.keys(row).find(k => normalizeKey(k) === normalizeKey(keyName));
                    };

                    json.forEach((row, i) => {
                         const titleKey = findKey(row, 'tÃ­tulo');
                         const companyKey = findKey(row, 'empresa');
                         
                         const title = titleKey ? row[titleKey] : null;
                         const company = companyKey ? row[companyKey] : null;
                         
                         if(!title || !company) return;
                         
                         const id = row['ID'] || 'job-'+Date.now()+'-'+i;
                         const state = row[findKey(row, 'estado')] || ''; 
                         const city = row[findKey(row, 'municipio')] || ''; 
                         const zone = row[findKey(row, 'zona')] || '';
                         const legacyLoc = row['UbicaciÃ³n'] || ''; 

                         const showCompKey = findKey(row, 'mostrar empresa publicamente');
                         let showCompanyRaw = 'SI';
                         if (showCompKey && row[showCompKey]) {
                             showCompanyRaw = String(row[showCompKey]).trim().toUpperCase();
                         }

                         const featuredKey = findKey(row, 'impulsar') || findKey(row, 'destacar') || findKey(row, 'top');
                         let isFeaturedRaw = 'NO';
                         if(featuredKey && row[featuredKey]) {
                             isFeaturedRaw = String(row[featuredKey]).trim().toUpperCase();
                         }

                         let contactRaw = row[findKey(row, 'contacto')] || '';
                         contactRaw = String(contactRaw).replace(/\D/g, ''); 
                         
                         if(contactRaw.length === 10) {
                             contactRaw = '+52' + contactRaw;
                         } else if (contactRaw.length > 10 && !contactRaw.startsWith('+')) {
                             contactRaw = '+' + contactRaw;
                         }

                         const jobData = {
                             title: title, 
                             company: company, 
                             showCompany: showCompanyRaw === 'SI', 
                             state: state, city: city, zone: zone,
                             location: (city && state) ? `${city}, ${state}` : legacyLoc, 
                             
                             fecha: row[findKey(row, 'fecha')] || '', 
                             
                             salary: row[findKey(row, 'salario')] || '', 
                             description: row[findKey(row, 'descripciÃ³n')] || '',
                             schedule: row[findKey(row, 'jornada')] || 'Horario a definir',
                             tags: row[findKey(row, 'etiquetas')] || '',
                             requirements: (row[findKey(row, 'requisitos')]) ? String(row[findKey(row, 'requisitos')]).split(' | ') : [],
                             benefits: (row[findKey(row, 'beneficios')]) ? String(row[findKey(row, 'beneficios')]).split(/\s*\|\s*/) : [],
                             contact: contactRaw, 
                             status: row[findKey(row, 'estatus')] || 'Vigente',
                             agency: row[findKey(row, 'tipo de servicio o agencia')] || '',
                             
                             isFeatured: isFeaturedRaw === 'SI' 
                         };
                         set(ref(db, 'jobs/' + id), jobData);
                         count++;
                    });
                    window.showToast(`âœ… ${count} vacantes cargadas`);
                } catch(err) { alert('Error: ' + err.message); }
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
