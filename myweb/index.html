    <!DOCTYPE html>
    <html lang="es">
    <head>
    <meta charset="UTF-8">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N2SW9MJGYG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N2SW9MJGYG');
    </script>

    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com https://images.unsplash.com;
    
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://html2canvas.hertzen.com https://*.gstatic.com https://cdn.sheetjs.com https://*.googleapis.com https://*.firebaseio.com https://www.googletagmanager.com https://www.google-analytics.com;
    
    connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://*.gstatic.com https://www.google-analytics.com https://analytics.google.com;
    
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    
    font-src 'self' https://fonts.gstatic.com data:;
    
    img-src 'self' data: https: https://www.google-analytics.com;
    
    worker-src 'self' blob:;">

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
        <title>TuChamba Express | Vacantes Urgentes en Nuevo Le√≥n, CDMX y EdoMex 2026</title>
        
        <link rel="icon" href="favicon.png" type="image/png">

        <meta name="description" content="Bolsa de trabajo urgente en Nuevo Le√≥n, CDMX, EdoMex, Quer√©taro, Jalisco, Tamaulipas e Hidalgo. Vacantes 2026 sin experiencia, contrataci√≥n inmediata y trato directo por WhatsApp.">

        <meta name="keywords" content="bolsa de trabajo nuevo leon, vacantes cdmx, empleos estado de mexico, trabajo queretaro, vacantes jalisco, chamba tamaulipas, empleos hidalgo, contrataci√≥n inmediata, trabajo sin experiencia, tuchamba express">

         <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "EmploymentAgency",
      "name": "TuChamba Express",
      "url": "https://tuchamba-express.vercel.app/",
      "logo": "https://tuchamba-express.vercel.app/favicon.png",
      "description": "Plataforma de vinculaci√≥n laboral r√°pida en M√©xico. Vacantes operativas y administrativas con contrataci√≥n inmediata.",
      "areaServed": [
        { "@type": "AdministrativeArea", "name": "Nuevo Le√≥n" },
        { "@type": "AdministrativeArea", "name": "Estado de M√©xico" },
        { "@type": "City", "name": "Ciudad de M√©xico" },
        { "@type": "AdministrativeArea", "name": "Quer√©taro" },
        { "@type": "AdministrativeArea", "name": "Jalisco" },
        { "@type": "AdministrativeArea", "name": "Tamaulipas" },
        { "@type": "AdministrativeArea", "name": "Hidalgo" }
      ],
      "sameAs": [
        "https://www.facebook.com/tuchambaexpress" 
      ]
    }
    </script>
        <meta property="og:title" content="¬øBuscas chamba urgente? Vacantes en Nuevo Le√≥n, CDMX y EdoMex üöÄ">
        <meta property="og:description" content="Sin correos ni registros. Clic y directo al WhatsApp del reclutador. ¬°Entra ya!">
        <meta property="og:image" content="https://tuchamba-express.vercel.app/banner_1.png">
        <meta property="og:url" content="https://tuchamba-express.vercel.app/">
        <meta property="og:type" content="website">

        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            
        body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 15px;
                padding-top: 10px;
                min-height: 100vh;
                background-color: #f0f2f5; 
                overflow-anchor: none;  /* <--- ESTA ES LA L√çNEA M√ÅGICA */
            }
            body {
        transition: all 0.3s ease; /* Suaviza cambios de estilo */
    }
    body.loading {
        opacity: 0; /* Esconde temporalmente durante carga */
    }

            /* Fondo Global Fijo */
            #globalBackground {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -10;
                background-image: 
                    linear-gradient(to bottom, rgba(10, 30, 60, 0.75), rgba(10, 30, 60, 0.85)),
                    url('https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=1080&q=60&auto=format');
                background-size: cover;
                background-position: center;
            }

            #toast {
                visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
                text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2147483647 !important;
                left: 50%; bottom: 30px; font-size: 15px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                opacity: 0; transition: opacity 0.5s, bottom 0.5s;
            }
            #toast.show { visibility: visible !important; opacity: 1 !important; bottom: 50px !important; }

            .footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: #ccc; font-size: 12px; line-height: 1.6; }
            
            .footer-link { color: #fff; text-decoration: underline; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
            
            .powered-by { margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 10px; font-family: monospace; letter-spacing: 1.5px; text-transform: uppercase; }
            .powered-by strong { color: rgba(255,255,255,0.7); font-weight: 900; }

            @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
            .skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 1000px 100%; display: inline-block; position: relative; animation: shimmer 2s infinite linear forwards; border-radius: 4px; }
            .skeleton-card { background: white; border-radius: 16px; padding: 25px; height: 200px; display: flex; flex-direction: column; gap: 15px; }
            .sk-title { width: 70%; height: 24px; } .sk-text { width: 90%; height: 16px; } .sk-tag { width: 30%; height: 20px; border-radius: 20px; }

            .welcome-container { max-width: 480px; margin: 60px auto; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.2); border-top: 5px solid #ffc107; padding: 40px 25px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); text-align: center; }
            .welcome-title { font-size: 28px; color: #ffffff; margin-bottom: 10px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
            .welcome-subtitle { color: #f0f0f0; margin-bottom: 30px; font-size: 16px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5); line-height: 1.5; }
            .btn-big-guest { background: #0a66c2; color: white; border: none; padding: 16px; width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
            .btn-big-guest:hover { background: #004182; transform: translateY(-2px); }
            .admin-toggle-link { display: block; margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 13px; text-decoration: underline; cursor: pointer; }
            /* --- CORRECCI√ìN LOGIN MODERNO (V18.1) --- */
            .admin-login-form { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); text-align: left; animation: fadeIn 0.5s; }
            .admin-login-form label { display: block; color: white; margin-bottom: 8px; font-weight: bold; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
            .admin-login-form input { 
                width: 100%; 
                padding: 12px 15px; 
                margin-bottom: 15px; 
                border-radius: 10px; 
                border: none; 
                font-size: 16px; 
                background: rgba(255,255,255,0.95) !important; 
                color: #333; 
                outline: none;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            .admin-login-form input:focus { transform: scale(1.02); transition: 0.2s; }

            /* =========================================================
            BLOQUE 1 FINAL-FINAL: BARRA FLACA Y OJO CENTRADO
            ========================================================= */

            /* 1. El Contenedor */
            .password-wrapper {
                position: relative; 
                width: 100%;
                margin-bottom: 15px;
            }

            /* 2. El Input: BAJAMOS LA ALTURA A 44px (Igual que el de arriba) */
            .password-wrapper input {
                width: 100% !important;
                height: 44px !important; /* <--- AQU√ç ESTABA EL DETALLE (Antes 50px) */
                
                padding: 0 50px 0 15px !important; 
                margin: 0 !important;
                box-sizing: border-box !important;
                line-height: normal !important;
            }

            /* 3. El √Årea del Icono: SE MANTIENE EL CENTRADO QUE S√ç SIRVI√ì */
            .password-toggle-icon {
                position: absolute;
                right: 5px;
                
                /* Truco de centrado autom√°tico */
                top: 0;
                bottom: 0;
                margin: auto;
                
                width: 44px; /* Ajustamos el √°rea al mismo alto que el input */
                height: 44px; 
                
                display: flex;
                align-items: center; 
                justify-content: center;
                
                cursor: pointer;
                z-index: 20;
            }

            /* 4. La Imagen */
            .password-toggle-icon img {
                width: 22px !important; 
                height: 22px !important;
                display: block;
                object-fit: contain;
                opacity: 0.6;
                transition: opacity 0.2s;
            }
            
            .password-toggle-icon:hover img { opacity: 1; }

            /* 2. El Contenedor del Icono (El que centra) */
            .password-toggle-icon {
                position: absolute;
                right: 10px; /* Pegado a la derecha */
                
                /* --- LA FORMULA DEL CENTRADO PERFECTO --- */
                top: 50%;    
                transform: translateY(-50%); 
                /* --------------------------------------- */
                
                width: 40px; /* √Årea grande para dar clic f√°cil */
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 20;
            }

            /* 3. La Imagen (PNG) */
            .password-toggle-icon img {
                width: 22px !important; /* Tama√±o del ojito */
                height: 22px !important;
                object-fit: contain;
                display: block;
                opacity: 0.7; /* Un poco transparente para que se vea elegante */
            }
            
            /* Cuando pasas el mouse, se oscurece */
            .password-toggle-icon:hover img {
                opacity: 1;
            }

            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

            .container { max-width: 1250px; margin: 0 auto; }

            .header { 
                background: white; 
                padding: 12px 15px; 
                border-radius: 12px; 
                margin-bottom: 15px; 
                display: flex; justify-content: space-between; align-items: center; 
                flex-wrap: wrap; gap: 10px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                z-index: 1100; 
            }
            
            /* Sticky solo para Admin en el Header */
            body.admin-mode .header { position: sticky; top: 0; }

            .header h1 { font-size: 20px; color: #333; font-weight: 800; margin: 0; line-height: 1.2; }
            .header-buttons { display: flex; gap: 8px; align-items: center; }

            #recruiterBanner { background: #e3f2fd !important; color: #0d47a1 !important; padding: 10px 15px; border-radius: 8px; margin-top: 30px; margin-bottom: 10px; font-size: 13px; display: flex !important; align-items: center; justify-content: center; gap: 10px; border: 1px solid #bbdefb; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
            #recruiterBanner:hover { background: #bbdefb !important; }

            /* --- V18.2 MEJORA DE DISE√ëO DE B√öSQUEDA (Estilo App Moderna) --- */
            #userStickyTools {
                position: sticky;
                top: 10px; 
                z-index: 990; 
                margin-bottom: 15px;
                
                /* Nuevo Look Flotante */
                background: white;
                border-radius: 16px;
                padding: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1); /* Sombra suave */
                border: 1px solid rgba(255,255,255,0.2);
            }
            
            /* --- FIX V18.2: Descongelar b√∫squeda en modo Admin/Reclutador --- */
            body.admin-mode #userStickyTools {
                position: static !important; /* Deja de ser sticky */
                margin-top: 10px;
                box-shadow: none; /* Se integra m√°s plano en modo trabajo */
                background: rgba(255,255,255,0.9);
            }

            .search-container { width: 100%; position: relative; margin-bottom: 8px; }
            
            /* Input m√°s moderno */
            .search-input {
                width: 100%;
                padding: 12px 40px 12px 15px;
                border-radius: 10px;
                border: 1px solid #eee;
                font-size: 15px;
                outline: none;
                background: #f9f9f9; /* Gris muy tenue */
                transition: all 0.2s;
            }
            .search-input:focus { border-color: #0a66c2; background: #fff; box-shadow: 0 0 0 2px rgba(10,102,194,0.1); }
            
            .search-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #ddd; color: #666; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }

            .filter-container { 
                display: flex; gap: 8px; align-items: center; 
                padding: 0; /* Quitamos padding extra */
                background: transparent; 
                box-shadow: none; /* Quitamos sombra vieja */
            }
            
            .filter-icon-box { display: flex; align-items: center; justify-content: center; background: #f0f2f5; padding: 0; border-radius: 10px; border: 1px solid #eee; height: 42px; width: 42px; flex-shrink: 0; }
            .filter-select { 
                flex: 1; min-width: 0; padding: 0 12px; 
                border: 1px solid #eee; border-radius: 10px; 
                font-size: 14px; background: #f9f9f9; outline: none; height: 42px; 
                cursor: pointer;
            }
            .filter-select:focus { background: white; border-color: #0a66c2; }

            #mobileFilterToggle { display: none; } 

            .btn-primary, .admin-btn { background: #0a66c2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; font-size: 14px; }
            .add-job-btn { background: #10a37f; padding: 12px 24px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
            
            .tool-btn { background: #2c3e50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
            .metrics-btn { background: #7b1fa2; } .team-btn { background: #e65100; } .settings-btn { background: #607d8b; }
            .danger-section { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 25px; }
            .danger-btn { background: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

            .pagination-container { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 30px; margin-bottom: 40px; flex-wrap: wrap; }
            .page-btn { background: white; border: 1px solid #ddd; color: #0a66c2; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
            .page-btn:hover { background: #f0f2f5; border-color: #0a66c2; }
            .page-btn.active { background: #0a66c2; color: white; border-color: #0a66c2; }
            .page-btn:disabled { background: #f9f9f9; color: #ccc; cursor: not-allowed; border-color: #eee; }
            .page-info { width: 100%; text-align: center; font-size: 13px; color: #666; margin-top: 10px; }

            .sticky-footer { 
                position: sticky; 
                bottom: 0; 
                background: white; 
                /* AJUSTE: Padding m√°s controlado */
                padding: 10px 15px 15px; 
                /* AJUSTE: Margen negativo solo lateral para pegar a los bordes */
                margin: 15px -20px -20px; 
                border-top: 1px solid #eee; 
                text-align: center; 
                box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
                z-index: 100; 
            }
            @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.05); } 30% { transform: scale(1); } 100% { transform: scale(1); } }
            
            /* BOT√ìN WHATSAPP SLIM FIT (V25.8) - Estilizado para PC y Celular */
            .whatsapp-btn-large { 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                width: 100%; 
                background-color: #25D366; 
                color: white; 
                text-decoration: none; 
                
                /* ESTILO BASE (PC): M√°s delgado y elegante */
                padding: 10px 15px;      /* Reduje el relleno vertical */
                font-size: 16px;         /* Letra legible pero no gigante */
                border-radius: 12px;     
                letter-spacing: 0.5px; 
                font-weight: 800;      
                box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); 
                border: none; 
                cursor: pointer; 
                animation: heartbeat 2.5s infinite; 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }

            /* --- AJUSTE M√ìVIL (Para que no se vea gordo en el cel) --- */
            @media (max-width: 768px) {
                .whatsapp-btn-large {
                    /* En celular mantenemos la letra casi igual pero ajustamos espacios */
                    font-size: 15px !important; 
                    
                    /* Padding lateral m√≠nimo para que quepa el texto largo */
                    padding: 12px 5px !important; 
                    
                    /* Juntamos un pel√≠n las letras para asegurar que quepa "EMPIEZA YA" */
                    letter-spacing: -0.3px !important; 
                }
            }
            
            .whatsapp-btn-large:active { transform: scale(0.98); animation: none; }
            .whatsapp-btn-large:disabled { background-color: #9ccc65; cursor: not-allowed; transform: none; opacity: 0.7; animation: none; }

            .share-btn { background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
            
            #adminControls {
                z-index: 1001;
                background: rgba(240, 242, 245, 0.95);
                backdrop-filter: blur(5px);
                padding-top: 10px; padding-bottom: 10px; margin-top: 0 !important; margin-bottom: 0px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            }
            /* CORRECCI√ìN: Botones Admin Sticky (Te siguen al bajar) */
            body.admin-mode #adminControls { 
                position: sticky; 
                top: 60px; /* Ajuste para quedar debajo de la barra blanca */
                z-index: 900; /* Menor que el header (1100) pero visible */
            }

            .admin-controls-wrapper { display: flex; gap: 10px; margin-bottom: 0px; flex-wrap: wrap; }
            .metrics-card { background: white; color: #333; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; font-size: 14px; }
            .metric-val { color: #0a66c2; font-weight: 800; margin-left: 4px; margin-right: 12px; }
            .admin-mode-indicator { background: #ffe0b2; color: #e65100; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #ffcc80; }

            .job-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; margin-top: 10px; }
            .job-card { background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; border: 1px solid #f0f0f0; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
            .job-card:hover { transform: translateY(-4px); }
            .badge-featured { position: absolute; top: 15px; right: 40px; background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%); color: white; padding: 5px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; box-shadow: 0 4px 8px rgba(98, 0, 234, 0.3); z-index: 4; display: flex; align-items: center; gap: 5px; border: none; letter-spacing: 0.5px; }
            .verified-badge { display: inline-flex; align-items: center; justify-content: center; background-color: #1da1f2; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; margin-left: 6px; vertical-align: middle; }
            .card-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; margin-right: 35px; }
            /* =========================================================
            CORRECCI√ìN FINAL: FECHA SUAVE Y LEGIBLE (V22.10) ‚òÅÔ∏è
            (Equilibrio: Se lee bien, pero no roba atenci√≥n)
            ========================================================= */
            .card-header-date { 
                /* 1. Estructura */
                display: inline-flex !important;
                align-items: center !important;
                padding: 3px 8px !important;
                border-radius: 4px !important;
                margin-bottom: 10px !important;
                gap: 5px !important;

                /* 2. Colores Suaves (El ajuste que pediste) */
                background-color: #f5f5f5 !important; /* Gris clarito elegante */
                color: #444 !important;               /* Gris oscuro legible (no negro) */
                border: 1px solid #e0e0e0 !important; /* Borde muy sutil */
                
                /* 3. Texto */
                font-size: 0.75rem !important; 
                font-weight: 600 !important;          /* Seminegrita (no tan gruesa) */
            }
            .badge-vigente { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
            .badge-closed { background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }
            .badge-new { background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; margin-left: 5px; border: 1px solid #ffcc80; }
            .job-title { font-size: 1.2rem; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; line-height: 1.3; }
            .company-name { font-size: 0.9rem; color: #0a66c2; font-weight: 600; display: flex; align-items: center; }
            .location { font-size: 0.9rem; color: #555; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
            .salary-text { color: #d32f2f; font-weight: 800; font-size: 1.3rem; margin-top: 5px; }
            .company-logo { width: 48px; height: 48px; background: linear-gradient(135deg, #0a66c2 0%, #004182 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; flex-shrink: 0; }
            .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; }
            .tag { background: #f3f2ef; color: #444; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
            .more-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 24px; color: #333; cursor: pointer; width: 30px; height: 30px; z-index: 5; font-weight: 900; }
            .admin-actions { display: none; position: absolute; top: 45px; right: 15px; background: white; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 20; }
            .admin-actions.active { display: block; }
            .admin-action { padding: 10px 20px; width: 100%; text-align: left; border: none; background: none; cursor: pointer; }
            .admin-action:hover { background: #f9f9f9; }

            /* CORRECCI√ìN: Modal siempre hasta el frente (Nivel 3000) */
            .modal { 
                display: none; 
                position: fixed; 
                top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.6); 
                z-index: 3000 !important; /* ¬°FUERZA BRUTA! Para que nada lo tape */
                padding: 20px; 
                backdrop-filter: blur(4px); 
            }
            .modal.active { display: flex; align-items: center; justify-content: center; }
            .modal-content { background: white; border-radius: 16px; max-width: 650px; width: 100%; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; overflow-x: hidden; padding-bottom: 0; }
            .close-btn { position: absolute; top: 20px; right: 20px; background: #f0f2f5; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #666; z-index: 10; }
            .job-details { display: grid; gap: 15px; margin-bottom: 25px; margin-top: 15px; }
            .detail-item { font-size: 15px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 10px; line-height: 1.4; word-break: break-word; }
            .modal-share-btn { background: #455a64; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; flex-shrink: 0; white-space: nowrap; }
            .view-count-badge { background: #e3f2fd; color: #0277bd; font-size: 12px; padding: 6px 14px; border-radius: 50px; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; border: 1px solid #bbdefb; }
            .agency-badge { background: #fff3e0; color: #ef6c00; font-size: 12px; padding: 6px 14px; border-radius: 50px; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; border: 1px solid #ffe0b2; }
            .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 12px; margin-top: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 5px; display: block; }
            .item-list li { background: #f9f9f9; padding: 10px 14px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 15px; }
            .recruiters-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .recruiters-table th, .recruiters-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
            .recruiters-table th { background: #f9fafb; color: #666; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
            .recruiters-table tr:hover { background-color: #f9f9f9; }
            .job-counter { color: white; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-bottom: 15px; margin-top: 10px; display: block; font-size: 16px; }

            /* =========================================================
            BLOQUE 2 FINAL V16: LA PURGA (SIN TRANSFORM + ULTRA FUERTE) üõ°Ô∏è
            ========================================================= */

            /* 1. Contador "Slim" Transparente */
            .detailed-counter {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 5px !important;
                margin-top: 10px !important;
                margin-bottom: 10px !important;
                display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
                font-size: 13px; color: white !important; font-weight: 700;
                text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            }
            
            .counter-tag { display: inline-flex; align-items: center; gap: 5px; }
            .tag-total { color: #fff; } 
            .tag-active { color: #69f0ae; }
            .tag-inactive { color: #ff8a80; }

            /* 2. CONTENEDOR (LIMPIO DE ERRORES) */
            .job-table-container {
                width: 100%; 
                overflow-x: auto !important; /* Scroll obligatorio */
                background: white;
                border-radius: 12px; 
                box-shadow: 0 4px 15px rgba(0,0,0,0.05);
                margin-bottom: 50px; 
                border: 1px solid #e0e0e0;
                -webkit-overflow-scrolling: touch; 
                
                /* --- LA CURA: PROHIBIDO USAR TRANSFORM AQU√ç --- */
                transform: none !important; 
                position: static !important; /* Dejamos que fluya natural */
            }

            .management-table {
                width: 100%; 
                border-collapse: separate !important; /* VITAL para sticky */
                border-spacing: 0;
                min-width: 900px; 
            }

            /* --- 3. ENCABEZADOS (BARRA AZUL) --- */
            /* Usamos selectores fuertes (body ...) para ganar prioridad */
            body .management-table th {
                background: #0a66c2; 
                color: white; 
                padding: 10px 8px; 
                text-align: left; font-size: 13px; font-weight: 700; 
                text-transform: uppercase; white-space: nowrap;
                
                /* Sticky Vertical (Arriba) */
                position: sticky; 
                top: 0; 
                z-index: 20; 
                border-bottom: none; 
            }

            /* --- 4. LA ESQUINA MAESTRA (#) - DOBLE ANCLAJE --- */
            /* Specificity Hack: body.recruiter-view gana a todo lo dem√°s */
            body .management-table th:first-child,
            body.recruiter-view .management-table th:first-child {
                position: -webkit-sticky !important;
                position: sticky !important;
                left: 0 !important;
                top: 0 !important;
                z-index: 100 !important; /* SIEMPRE ARRIBA DE TODO */
                
                background-color: #0a66c2 !important; 
                width: 35px !important; 
                min-width: 35px !important;
                text-align: center !important;
                padding: 10px 0 !important;
                
                /* La sombra interna gris (indestructible) */
                box-shadow: inset -1px 0 0 rgba(255,255,255,0.3) !important;
                border-top-left-radius: 11px;
            }
            
            .management-table th:last-child { border-top-right-radius: 11px; }

            /* --- 5. CELDAS DEL CUERPO --- */
            .management-table td {
                padding: 8px 8px; 
                border-bottom: 1px solid #f0f0f0; 
                color: #333; font-size: 13px; vertical-align: middle;
                white-space: nowrap; 
                background-color: white; 
            }

            /* --- 6. COLUMNA LATERAL (1, 2, 3...) - ANCLAJE IZQUIERDO --- */
            body .management-table td:first-child,
            body.recruiter-view .management-table td:first-child {
                position: -webkit-sticky !important;
                position: sticky !important;
                left: 0 !important;
                z-index: 50 !important; /* Encima de las celdas normales */
                
                font-weight: bold;
                color: #0a66c2;
                width: 35px !important;
                min-width: 35px !important;
                text-align: center !important;
                padding: 8px 0 !important;
                
                /* Sombra interna GRIS para la divisi√≥n */
                box-shadow: inset -2px 0 0 #e0e0e0 !important;
                
                background-color: white !important; /* Fondo s√≥lido */
            }

            /* Texto Grande */
            .management-table td:nth-child(3), 
            .management-table td:nth-child(4) { 
                font-size: 15px !important; font-weight: 600; 
            }
            .management-table td:last-child { text-align: right; width: 1%; }
            .actions-flex { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }

            /* --- COLORES CEBRA (Sincronizados a la fuerza) --- */
            .management-table tr:nth-child(even) td { background-color: #f8f9fa; }
            .management-table tr:nth-child(even) td:first-child { background-color: #f8f9fa !important; }

            .management-table tr:hover td { background-color: #e3f2fd; }
            .management-table tr:hover td:first-child { background-color: #e3f2fd !important; }

            /* Botones Acci√≥n */
            .action-icon-btn {
                background: white; border: 1px solid #ddd; cursor: pointer;
                font-size: 15px; width: 28px; height: 28px; border-radius: 6px;
                display: inline-flex; align-items: center; justify-content: center;
                transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .action-icon-btn:hover { transform: translateY(-2px); border-color: #0a66c2; background: #f0f7ff; }

            /* 7. Select del Filtro */
            .header-select {
                background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
                color: white; padding: 2px 4px; border-radius: 4px;
                font-size: 11px; font-weight: bold; width: 100%; max-width: 180px;
                outline: none; cursor: pointer;
            }
            .header-select option { color: #333; background: white; }

            /* 8. AJUSTE PC */
            @media (min-width: 1024px) {
                .job-table-container { overflow-x: visible; }
                .management-table { min-width: 100%; width: 100%; table-layout: auto; }
                .management-table td { white-space: normal; word-wrap: break-word; max-width: 250px; }
                .management-table td:nth-child(6), .management-table td:last-child { white-space: nowrap; width: 1%; }
                .header-select { max-width: 100%; }
            }

            
            
            #flyerTemplate { width: 1080px; min-height: 1080px; height: auto; position: fixed; top: 0; left: -9999px; z-index: -1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: 'Arial Black', 'Arial', sans-serif; text-align: center; padding: 80px 60px; box-sizing: border-box; background: #0a192d; }
            .flyer-badge-top { background-color: #FF9800; color: white; font-size: 55px; padding: 15px 80px; border-radius: 10px; text-transform: uppercase; letter-spacing: 4px; font-weight: 900; margin-bottom: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); border: 4px solid #FFF; transform: skew(-10deg); z-index: 2; position: relative; }
            .flyer-title { font-size: 90px; font-weight: 900; line-height: 1.1; margin-bottom: 20px; text-shadow: 0 5px 20px rgba(0,0,0,0.9); max-width: 95%; text-transform: uppercase; color: #FFFFFF; z-index: 2; position: relative; }
            .flyer-company { font-size: 35px; color: #BBDEFB; font-family: 'Segoe UI', sans-serif; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; z-index: 2; position: relative; }
            .flyer-salary { font-size: 100px; color: #C6FF00; font-weight: 900; margin-bottom: 50px; text-shadow: 0 5px 20px rgba(0,0,0,0.9); z-index: 2; position: relative; }
            .flyer-benefits-container { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 30px; padding: 40px; width: 90%; margin-bottom: 60px; backdrop-filter: blur(10px); z-index: 2; position: relative; }
            .flyer-benefits-title { font-size: 40px; color: #FFD740; margin-bottom: 30px; text-transform: uppercase; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 15px; display: inline-block; }
            .flyer-benefits-list { list-style: none; padding: 0; margin: 0; font-size: 55px; font-family: 'Segoe UI', sans-serif; font-weight: 600; color: white; text-align: left; display: inline-block; }
            .flyer-benefits-list li { margin-bottom: 15px; }
            .flyer-cta-box { background: white; color: #D50000; padding: 40px 60px; border-radius: 20px; font-size: 42px; font-weight: 900; box-shadow: 0 15px 50px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; gap: 20px; border-bottom: 15px solid #b71c1c; width: 100%; text-transform: uppercase; z-index: 2; position: relative; }
            #flyerQr { margin-left: 20px; border: 2px solid #ddd; padding: 5px; border-radius: 10px; background: white; }
            #flyerQr img { display: block; }
            /* --- ESTILOS MODERNOS PARA MODALES (V18.3) --- */
            .modal-header-pro {
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
            }
            .modal-header-pro h2 { margin: 0; font-size: 1.4rem; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
            
            .modern-form-box {
                background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            }
            
            /* Grid para ahorrar espacio (2 columnas) */
            .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            
            /* Tabla Pro */
            .table-container-pro {
                border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 10px;
            }
            .recruiters-table { width: 100%; border-collapse: collapse; }
            .recruiters-table thead { background: #f1f3f5; }
            .recruiters-table th { color: #495057; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; padding: 12px 15px; letter-spacing: 0.5px; }
            .recruiters-table td { padding: 12px 15px; border-bottom: 1px solid #f1f3f5; color: #333; font-size: 0.9rem; vertical-align: middle; }
            .recruiters-table tr:hover { background: #fffde7; }
            @media (max-width: 768px) {
        .recruiters-table th {
            font-size: 0.75rem; /* Letra m√°s chica para encabezados (era 0.8rem) */
            padding: 8px 10px; /* Reduce padding para ahorrar espacio */
        }
        .recruiters-table td {
            font-size: 0.85rem; /* Letra principal m√°s chica (era 0.9rem) */
            padding: 8px 10px; /* Reduce padding */
        }
        .recruiters-table td:first-child {
            text-align: justify; /* Justifica los nombres para que se distribuyan mejor */
            word-break: break-word; /* Rompe palabras largas si es necesario */
        }
        .recruiters-table td:nth-child(2) {
            font-size: 0.75rem; /* C√≥digo m√°s chico */
        }
        .table-container-pro {
            overflow-x: auto; /* Permite scroll horizontal si a√∫n no cabe */
        }
    }

            /* Botones de acci√≥n peque√±os */
            .btn-icon-small { border: none; background: transparent; cursor: pointer; font-size: 16px; padding: 5px; border-radius: 4px; transition: background 0.2s; }
            .btn-icon-small:hover { background: #eee; }
            .copy-badge { background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; border: none; }
            .copy-badge:hover { background: #bbdefb; }

            /* Zona de Peligro Bonita */
            .danger-zone-pro {
                background: #fff5f5; border: 1px solid #ffc9c9; border-radius: 12px; padding: 20px;
                position: relative; overflow: hidden; margin-top: 10px;
            }
            @media (max-width: 768px) {
            .danger-zone-pro .danger-btn {
            margin-top: 15px; /* Separa m√°s los botones en celular */
            padding: 12px; /* Un poquito m√°s alto para que se vea mejor */
            }
            .danger-zone-pro {
            padding: 15px; /* Reduce padding general para que quepa mejor */
            }
            }
            .danger-zone-pro::before { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #ff6b6b; }
            .danger-title { color: #c92a2a; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 1rem; }
            
            @media (max-width: 600px) { .form-grid-2 { grid-template-columns: 1fr; } }
            /* --- ESTILOS V18.6 (Separaci√≥n Total: App vs Login) --- */

            /* GRUPO 1: DENTRO DE LA APP (Compactos y Modernos) */
            /* Excluimos expl√≠citamente el #adminForm para que no lo toque */
            :not(#adminForm) > .form-group input, 
            :not(#adminForm) > .form-group textarea, 
            :not(#adminForm) > .form-group select { 
                width: 100% !important; 
                padding: 8px 12px !important; /* Compactos */
                background-color: #f0f2f5 !important; /* Gris App */
                border: 1px solid transparent !important; 
                border-radius: 8px !important;
                font-size: 14px !important; 
                color: #1c1e21 !important;
                font-weight: 500 !important;
                transition: all 0.2s ease !important;
                box-shadow: none !important;
                min-height: 38px !important;
            }
            
            /* Efecto Focus App */
            :not(#adminForm) > .form-group input:focus, 
            :not(#adminForm) > .form-group select:focus {
                background-color: #ffffff !important;
                border: 1px solid #0a66c2 !important;
                box-shadow: 0 2px 6px rgba(10, 102, 194, 0.15) !important;
            }

            /* Etiquetas App (Gris oscuro) */
            :not(#adminForm) > .form-group label {
                display: block !important;
                margin-bottom: 4px !important;
                color: #444 !important;
                font-size: 11px !important;
                font-weight: 700 !important;
                text-transform: uppercase !important;
            }

            /* GRUPO 2: LOGIN (Rescatando el estilo original) */
            #adminForm .form-group input {
                background-color: #ffffff !important; /* BLANCO PURO */
                color: #000000 !important; /* Texto NEGRO */
                border: none !important;
                padding: 12px 15px !important; /* Grandes y c√≥modos */
                border-radius: 10px !important;
                font-size: 16px !important;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
                margin-bottom: 15px !important;
            }

            /* Etiquetas del Login (BLANCAS para que se vean en el fondo oscuro) */
            #adminForm .form-group label {
                color: #ffffff !important; 
                font-size: 14px !important;
                font-weight: bold !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important;
                margin-bottom: 8px !important;
                text-transform: none !important; /* Normal, no may√∫sculas */
            }

            /* Ajustes t√©cnicos globales */
            .phone-group input { border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; }
            .phone-select { border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; background-color: #e4e6eb !important; border-right: 1px solid #ccc !important; padding: 5px !important; }

            /* Efecto al dar clic (Se ilumina) */
            .form-group input:focus, 
            .form-group textarea:focus, 
            .form-group select:focus { 
                background-color: #ffffff !important;
                border: 1px solid #0a66c2 !important; /* Borde azul al escribir */
                box-shadow: 0 4px 15px rgba(10, 102, 194, 0.15) !important;
                outline: none !important;
            }

            /* Etiquetas (T√≠tulos de los campos) */
            .form-group label {
                display: block !important;
                margin-bottom: 8px !important;
                margin-left: 5px !important;
                font-weight: 700 !important;
                color: #444 !important;
                font-size: 12px !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
            }
            
            /* Ajuste especial para el grupo de tel√©fono (que no se rompa) */
            .phone-group input {
                border-top-left-radius: 0 !important;
                border-bottom-left-radius: 0 !important;
            }
            .phone-select {
                border-top-right-radius: 0 !important;
                border-bottom-right-radius: 0 !important;
                background-color: #e4e6eb !important;
                border-right: 1px solid #ccc !important;
            }
            /* --- ESTILO BARRA DE B√öSQUEDA DE ALTO CONTRASTE (V18.7) --- */
            
            /* 1. La barra contenedora (Fondo Gris) */
            #userStickyTools, body.admin-mode #userStickyTools {
                background-color: #e4e6eb !important; /* Gris s√≥lido para el fondo */
                border: 1px solid rgba(0,0,0,0.05) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important; /* Sombra suave para que flote */
            }

            /* 2. Los campos de b√∫squeda y filtros (Blancos Brillantes) */
            .search-input, 
            .filter-select, 
            .filter-icon-box {
                background-color: #ffffff !important; /* BLANCO PURO */
                border: 1px solid transparent !important; /* Sin bordes grises */
                box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important; /* Peque√±a sombra 3D */
                color: #333 !important;
            }

            /* 3. Efecto al hacer clic en ellos (Resplandor Azul) */
            .search-input:focus, 
            .filter-select:focus {
                background-color: #ffffff !important;
                box-shadow: 0 0 0 3px rgba(10, 102, 194, 0.2) !important; /* Anillo azul suave */
                border-color: #0a66c2 !important;
            }

            /* Ajuste para el icono del embudo */
            .filter-icon-box svg {
                stroke: #555 !important;
            }
            /* --- FICHAS COMPACTAS (Optimizaci√≥n de Espacio V18.8) --- */
            
            /* 1. Reducir el "aire" general de la tarjeta */
            .job-card {
                padding: 14px !important; /* Antes era 20px */
                border-radius: 12px !important;
            }

            /* 2. Pegar m√°s los elementos internos */
            .card-header-top { margin-bottom: 4px !important; } /* Menos espacio arriba */
            .card-header-date { margin-bottom: 8px !important; font-size: 0.7rem !important; }
            
            /* El bloque del Logo y T√≠tulo */
            .job-card > div[style*="display: flex"] {
                margin-top: 5px !important; /* Pegarlo a la fecha */
                margin-bottom: 8px !important; /* Pegarlo a la ubicaci√≥n */
                gap: 10px !important; /* Acercar logo al texto */
            }
            
            /* Ajustar m√°rgenes de textos clave */
            .job-title { margin-bottom: 0px !important; line-height: 1.2 !important; }
            .company-name { margin-bottom: 2px !important; }
            .location { margin-top: 4px !important; }
            .salary-text { margin-top: 4px !important; }

            /* Las etiquetas de abajo (Tags) */
            .tags { margin-top: 10px !important; gap: 5px !important; }
            .tag { padding: 3px 8px !important; font-size: 11px !important; }

            /* Hacer los botones de "Destacado" y "Vigente" m√°s delgados */
            .badge-featured, .badge-vigente, .badge-closed, .badge-new {
                padding: 3px 8px !important;
                top: 12px !important; /* Subirlos un poquito */
            }
            .more-btn { top: 10px !important; right: 10px !important; } /* Ajustar bot√≥n de men√∫ */
            /* --- CORRECCI√ìN FINAL LADAS (V18.9) --- */
            .phone-group {
                display: flex !important; /* Obliga a ponerse en fila */
                align-items: stretch !important;
                width: 100% !important;
                gap: 0 !important; /* Pegaditos */
            }
            
            .phone-select {
                width: auto !important; /* Que solo ocupe lo necesario */
                flex: 0 0 auto !important; /* No permitir que se estire */
                min-width: 100px !important; /* Ancho fijo ideal para "üá≤üáΩ +52" */
                padding: 8px 5px !important;
                text-align: center !important;
                border-right: 1px solid #ccc !important;
                background-color: #e4e6eb !important;
                border-top-right-radius: 0 !important;
                border-bottom-right-radius: 0 !important;
                cursor: pointer !important;
            }

            .phone-group input {
                flex: 1 !important; /* El input toma TODO el espacio sobrante */
                border-top-left-radius: 0 !important;
                border-bottom-left-radius: 0 !important;
                border-left: none !important;
            }
            /* --- CORRECCI√ìN FINAL MAESTRA LADAS (V18.11) --- */
            
            /* 1. Forzamos al contenedor a ser flexible horizontalmente */
            .form-group .phone-group {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                width: 100% !important;
            }

            /* 2. AL SELECTOR DE PA√çS: Lo obligamos a ser peque√±o */
            .form-group .phone-group select.phone-select {
                width: 110px !important; /* Ancho fijo peque√±o */
                min-width: 110px !important;
                max-width: 110px !important;
                flex: 0 0 110px !important; /* No te estires ni te encojas */
                
                border-top-right-radius: 0 !important;
                border-bottom-right-radius: 0 !important;
                border-right: 1px solid #ccc !important;
                margin: 0 !important;
            }

            /* 3. AL CAMPO DE N√öMERO: Le decimos que ocupe TODO el resto */
            .form-group .phone-group input {
                width: auto !important; 
                flex-grow: 1 !important; /* Crece para llenar el hueco */
                min-width: 0 !important;
                
                border-top-left-radius: 0 !important;
                border-bottom-left-radius: 0 !important;
                margin: 0 !important;
            }

        /* --- CORRECCI√ìN FINAL V32: PANEL RECLUTADOR LIMPIO (2x2) --- */
            @media (max-width: 768px) {

                /* 1. ENCABEZADO (Limpio en una l√≠nea) */
                .header {
                    display: flex !important; flex-wrap: nowrap !important; align-items: center !important;
                    padding: 8px 10px !important; gap: 5px !important; height: 50px !important;
                }
                .header h1 { font-size: 15px !important; margin: 0 !important; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
                .header-buttons { flex-shrink: 0; gap: 5px !important; }
                .header-buttons button, .header-buttons span { padding: 4px 8px !important; font-size: 11px !important; height: 30px !important; }
                #viewToggleBtn { display: none !important; }

                /* 2. PANEL CONTENEDOR (Redondo y Flotante) */
                body.recruiter-view #adminControls {
                    position: static !important;
                    padding: 10px !important;
                    background: #f4f6f8 !important;
                    border-radius: 16px !important; /* <--- ESQUINAS REDONDAS */
                    margin: 10px !important; 
                    box-shadow: 0 4px 10px rgba(0,0,0,0.05) !important;
                }
                
                body.recruiter-view .admin-controls-wrapper {
                    display: grid !important;
                    grid-template-columns: 1fr 1fr !important; /* 2 Columnas exactas */
                    gap: 10px !important;
                    margin: 0 !important;
                }

                /* 3. ¬°REGLA DE ORO! OCULTAR TODO LO DE ADMIN */
                /* Esto borra Cargar, Nueva, Equipo y Ajustes de un jal√≥n */
                body.recruiter-view .admin-only, 
                body.recruiter-view input[type="file"] { 
                    display: none !important; 
                }

                /* 4. ESTILOS Y ORDEN DE LOS 4 SOBREVIVIENTES */
                
                /* Posici√≥n 1: Tarjeta Vistas */
                body.recruiter-view .metrics-card {
                    order: 1 !important;
                    width: 100% !important; height: 45px !important;
                    font-size: 12px !important; padding: 0 !important; margin: 0 !important;
                    background: white !important; border: 1px solid #ddd !important;
                    border-left: 5px solid #0a66c2 !important;
                    border-radius: 10px !important;
                    display: flex !important; align-items: center !important; justify-content: center !important;
                }
                body.recruiter-view .metrics-card span { display: inline !important; }

                /* Posici√≥n 2: Bot√≥n M√©tricas (Morado) */
                body.recruiter-view .metrics-btn {
                    order: 2 !important;
                    width: 100% !important; height: 45px !important;
                    background: #7b1fa2 !important; color: white !important;
                    font-size: 13px !important; border-radius: 10px !important;
                    padding: 0 !important; margin: 0 !important;
                    display: flex !important; align-items: center !important; justify-content: center !important;
                }

                /* Posici√≥n 3: Bot√≥n Respaldo (Centrado) */
                body.recruiter-view button[onclick*="exportToExcel"] {
                    order: 3 !important;
                    height: 45px !important; width: 100% !important; 
                    font-size: 13px !important; padding: 0 !important;
                    border-radius: 10px !important;
                    display: flex !important; align-items: center !important; justify-content: center !important;
                }

                /* Posici√≥n 4: Bot√≥n Plantilla (Centrado) */
                body.recruiter-view button[onclick*="downloadTemplate"] {
                    order: 4 !important;
                    height: 45px !important; width: 100% !important;
                    font-size: 13px !important; padding: 0 !important;
                    border-radius: 10px !important;
                    display: flex !important; align-items: center !important; justify-content: center !important;
                }

                /* 5. TABLA STICKY */
                body.recruiter-view .management-table th {
                    position: sticky !important; top: 0 !important; z-index: 1000 !important;
                    padding: 10px 5px !important;
                }
                .job-table-container { margin-top: 5px !important; border: none !important; }
            }

            /* =========================================================
            BLOQUE FINAL: PC RECLUTADOR (ULTRA SLIM V3)
            ========================================================= */
            @media (min-width: 769px) {
                
                /* 1. EL PANEL (Barra fina y flotante) */
                body.recruiter-view #adminControls {
                    position: static !important;
                    margin: 10px auto 15px auto !important; /* Margen muy pegadito */
                    width: 85% !important; 
                    max-width: 950px;
                    
                    background: #ffffff !important;
                    border: 1px solid #e0e0e0 !important;
                    border-radius: 50px !important; /* <--- ESTILO P√çLDORA (M√°s redondo) */
                    box-shadow: 0 4px 10px rgba(0,0,0,0.05) !important;
                    
                    /* AQU√ç EST√Å LA MAGIA DE LA ALTURA */
                    padding: 5px 20px !important; 
                    z-index: 100 !important;
                    min-height: 45px !important; /* Altura m√≠nima controlada */
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }

                /* 2. OCULTAR LO QUE SOBRA */
                body.recruiter-view .admin-only,
                body.recruiter-view .settings-btn,
                body.recruiter-view .team-btn,
                body.recruiter-view .add-job-btn,
                body.recruiter-view button[onclick*="excelFile"],
                body.recruiter-view #viewToggleBtn { 
                    display: none !important;
                }

                /* 3. ALINEACI√ìN INTERNA */
                body.recruiter-view .admin-controls-wrapper {
                    display: flex !important;
                    justify-content: center !important;
                    align-items: center !important;
                    gap: 12px !important; /* Menos espacio entre botones */
                    flex-wrap: nowrap !important;
                    margin: 0 !important;
                    width: 100% !important;
                }

                /* 4. BOTONES ULTRA SLIM (Altura 32px) */
                
                /* Tarjeta de Vistas */
                body.recruiter-view .metrics-card {
                    background: #f8f9fa !important;
                    border: 1px solid #ddd !important;
                    border-left: 3px solid #0a66c2 !important; /* Borde m√°s fino */
                    height: 32px !important; /* <--- ALTURA BAJA */
                    border-radius: 20px !important; /* P√≠ldora */
                    padding: 0 15px !important;
                    box-shadow: none !important;
                    font-size: 12px !important; /* Letra ajustada */
                }

                /* Botones de Acci√≥n */
                body.recruiter-view button {
                    height: 32px !important; /* <--- ALTURA BAJA */
                    padding: 0 18px !important;
                    border-radius: 20px !important; /* P√≠ldora */
                    font-size: 12px !important;
                    display: flex !important; 
                    align-items: center !important; 
                    justify-content: center !important;
                    transition: transform 0.2s !important;
                    margin: 0 !important;
                }
                body.recruiter-view button:hover {
                    transform: translateY(-1px);
                }
                
                /* Colores */
                body.recruiter-view .metrics-btn { background: #7b1fa2 !important; }
                body.recruiter-view button[onclick*="exportToExcel"] { background: #2c3e50 !important; }
                body.recruiter-view button[onclick*="downloadTemplate"] { background: #455a64 !important; }
                body.recruiter-view #seoSitemapBtn {
                    display: none !important;
                }
            }

            /* =========================================================
            BLOQUE EXTRA: HEADER SLIM PARA PC (A DIETA)
            ========================================================= */
            @media (min-width: 769px) {
                
                /* 1. La Barra del Encabezado */
                .header {
                    padding: 5px 20px !important;  /* Relleno m√≠nimo */
                    min-height: 50px !important;   /* Altura fija compacta */
                    height: 50px !important;
                    
                    display: flex !important;
                    align-items: center !important;
                    
                    /* Redondeado suave */
                    border-radius: 16px !important; 
                    margin-bottom: 20px !important;
                }

                /* 2. El T√≠tulo (Un poco m√°s chico para que quepa) */
                .header h1 {
                    font-size: 18px !important; 
                }

                /* 3. Los Botones (Compartir, Salir, Indicador) */
                .header-buttons {
                    gap: 10px !important;
                }

                .header-buttons button, 
                .header-buttons span {
                    height: 32px !important;       /* Altura 32px (Igual que los de abajo) */
                    font-size: 12px !important;    /* Letra compacta */
                    padding: 0 15px !important;    /* Menos ancho */
                    border-radius: 20px !important; /* Estilo P√≠ldora */
                    
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                
            /* Ajuste espec√≠fico para el indicador de modo (CENTRADO PERFECTO) */
                .admin-mode-indicator {
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important; /* <--- La clave del centrado horizontal */
                    text-align: center !important;
                    
                    height: 32px !important;
                    padding: 0 15px !important; /* Solo relleno lateral, nada arriba/abajo */
                    line-height: 1 !important;  /* Mata el espaciado de l√≠nea extra */
                    
                    /* Aseguramos que no herede m√°rgenes raros */
                    margin-top: 0 !important;
                    margin-bottom: 0 !important;
                }
            }


            
            /* =========================================================
            CORRECCI√ìN URGENTE: CANDADO BOT√ìN VISTA (SOLO ADMIN)
            ========================================================= */
            
            /* 1. Por defecto: OCULTO PARA TODOS (Invitados y Reclutadores) */
            #viewToggleBtn {
                display: none !important;
            }

            /* 2. La √∫nica excepci√≥n: SUPER ADMIN (body tiene .admin-mode pero NO .recruiter-view) */
            body.admin-mode:not(.recruiter-view) #viewToggleBtn {
                display: flex !important; /* Solo aqu√≠ aparece */
            }

            /* --- BLOQUE 1: MEJORAS VISUALES V20.2 --- */

            /* =========================================================
            BOT√ìN COMPARTIR: ESTILO "ORANGE CREAM" (V20.3) üçä
            (Fondo Pastel + Borde Oscuro Intenso)
            ========================================================= */
            #mainShareBtn {
                /* 1. Fondo Naranja Pastel (Suave y limpio) */
                background: #ffe0b2 !important; 
                
                /* 2. Texto y Borde: Naranja Quemado (Tir√°ndole a Negro/Ladrillo) */
                color: #bf360c !important; 
                border: 1px solid #bf360c !important; 
                
                /* 3. Tipograf√≠a Gruesa para que se lea perfecto sobre el pastel */
                font-weight: 800 !important; 
                font-size: 13px !important;
                letter-spacing: 0.5px !important;
                
                /* 4. Forma P√≠ldora */
                border-radius: 50px !important;
                padding: 0 20px !important;
                height: 34px !important;
                
                /* 5. Sin sombras raras (Flat Design) */
                box-shadow: none !important;
                text-shadow: none !important;
                
                /* 6. Alineaci√≥n */
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            }

            /* Efecto Hover: Se invierten los colores o se oscurece un poco */
            #mainShareBtn:hover {
                background: #ffcc80 !important; /* Un poco m√°s intenso al pasar el mouse */
                transform: translateY(-1px) !important;
            }

            /* Efecto sutil al pasar el mouse (se pone negro total) */
            #mainShareBtn:hover {
                background: #000000 !important;
                transform: scale(1.02) !important;
            }

            /* Ajuste M√≥vil */
            @media (max-width: 768px) {
                #mainShareBtn {
                    height: 32px !important;
                    font-size: 12px !important;
                    padding: 0 16px !important;
                }
            }

            /* Efecto al pasar el mouse */
            #mainShareBtn:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6) !important;
                filter: brightness(1.1);
            }

            /* Efecto al dar clic */
            #mainShareBtn:active {
                transform: scale(0.95) !important;
            }

            /* AJUSTE PARA M√ìVIL (Para que no robe mucho espacio) */
            @media (max-width: 768px) {
                #mainShareBtn {
                    height: 32px !important;
                    padding: 0 15px !important;
                    font-size: 12px !important;
                }
            }

            /* Efecto al pasar el mouse (se ilumina un poco) */
            body .header-buttons .share-btn:hover {
                background: #00e676 !important; 
                transform: translateY(-1px) !important;
            }

            /* TAREA 11: Homologar Encabezados de Tabla (PC y Celular iguales) */
            .management-table th {
                font-size: 13px !important; /* Tama√±o est√°ndar para todos */
                vertical-align: middle !important;
                padding: 10px 5px !important;
                text-transform: uppercase !important;
            }
            
            /* Ajuste espec√≠fico para que en celular no se hagan microsc√≥picas */
            @media (max-width: 768px) {
                .management-table th {
                    font-size: 12px !important; /* M√≠nimo legible */
                    white-space: nowrap !important;
                }
            }

            /* =================================================================
            CORRECCI√ìN FINAL M√ìVIL: HOMOLOGACI√ìN TOTAL (V20.3) üìè
            (Incluye: Compartir, Salir y el Rebelde "Copiar Link")
            ================================================================= */
            @media (max-width: 768px) {
                
                /* 1. CONTENEDOR: Forzar una sola l√≠nea centrada */
                .header-buttons {
                    display: flex !important;
                    flex-wrap: nowrap !important;   /* Prohibido bajar de l√≠nea */
                    align-items: center !important; /* Alineaci√≥n vertical perfecta */
                    gap: 5px !important;            /* Espacio m√≠nimo vital */
                }

                /* 2. LA DIETA PAREJA: Todos los botones al mismo tama√±o */
                /* AGREGAMOS AQU√ç: .copy-link-btn y #btnRecruiterLink */
                .header-buttons button, 
                .header-buttons a,
                #mainShareBtn,
                .copy-link-btn {
                    height: 30px !important;        /* Altura compacta para todos */
                    line-height: 1 !important;      /* Centrado de texto vertical */
                    padding: 0 10px !important;     /* Relleno lateral igual */
                    font-size: 11px !important;     /* Letra chica uniforme */
                    white-space: nowrap !important; /* Texto en una l√≠nea */
                    
                    /* Centrado del contenido interno (√≠conos + texto) */
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    
                    margin: 0 !important; /* Sin m√°rgenes extra√±os */
                }

                /* 3. Ajuste Espec√≠fico para el Bot√≥n Azul (Copiar Link) en Celular */
                .copy-link-btn {
                    border-radius: 50px !important; /* Mantener √≥valo */
                    background-color: #e3f2fd !important; /* Asegurar fondo azul */
                    width: auto !important; /* Que se ajuste al texto */
                }

                /* 4. Ajuste Espec√≠fico para el Bot√≥n Naranja (Compartir) */
                #mainShareBtn {
                    border-width: 1px !important;
                }
            }

            /* =========================================================
            CORRECCI√ìN: ALINEACI√ìN VERTICAL PERFECTA (V20.4) üìê
            (Esto centra el bot√≥n de "Copiar Link" con los dem√°s)
            ========================================================= */
            
            /* 1. El contenedor invisible ahora se comporta bien */
            #modeIndicator {
                display: flex !important;       /* Lo volvemos flexible */
                align-items: center !important; /* Lo centramos verticalmente */
                height: 100% !important;        /* Que ocupe la misma altura */
                margin: 0 !important;           /* Sin m√°rgenes raros */
            }

            /* 2. Aseguramos que el bot√≥n azul no flote raro */
            #modeIndicator .copy-link-btn {
                margin: 0 !important;
                display: inline-flex !important;
                align-items: center !important;
                vertical-align: middle !important;
            }

            /* =========================================================
            TAREA 11: HOMOLOGACI√ìN BARRA AZUL (V22.5) üìè
            (Misma letra, tama√±o y fuente en PC y Celular)
            ========================================================= */
            .management-table th {
                font-size: 13px !important;      /* Tama√±o est√°ndar fijo para todos */
                font-weight: 800 !important;     /* Negrita fuerte */
                text-transform: uppercase !important; 
                letter-spacing: 0.5px !important; 
                vertical-align: middle !important;
                padding: 12px 8px !important;
                
                /* Aseguramos que los bordes redondeados se respeten si existen */
                border-bottom: none !important;
            }

            /* REGLA DE ORO: En celular NO permitimos que se haga chiquita */
            @media (max-width: 768px) {
                .management-table th {
                    font-size: 13px !important; /* Forzamos el mismo tama√±o que en PC */
                    padding: 10px 5px !important;
                }
            }

            /* =========================================================
            TAREA 14: CORRECCI√ìN DE COLUMNA FIJA "#" (MODO RECLUTADOR) üß±
            (Hacemos que el # sea el rey y nadie pase por encima de √©l)
            ========================================================= */
            
            /* 1. Elevamos el nivel de la primera columna (#) */
            body.recruiter-view .management-table th:first-child,
            body.recruiter-view .management-table td:first-child {
                position: sticky !important;
                left: 0 !important;
                z-index: 50 !important; /* ¬°NIVEL DIOS! (Muy alto) */
                
                /* Le ponemos fondo s√≥lido para que no se trasluzca lo que pasa por abajo */
                background-color: #f8f9fa !important; 
                border-right: 2px solid #e0e0e0 !important; /* Borde fuerte para separar */
            }

            /* 2. Aseguramos que el encabezado del # tenga el color correcto */
            body.recruiter-view .management-table th:first-child {
                background-color: #2c3e50 !important; /* El gris oscuro del header */
                color: white !important;
                z-index: 60 !important; /* El encabezado debe ser a√∫n m√°s alto que las celdas */
            }

            /* 3. Los dem√°s encabezados deben estar ABAJO del # */
            body.recruiter-view .management-table th:not(:first-child) {
                z-index: 10 !important; /* Nivel bajo */
            }

            /* =========================================================
            RESTAURACI√ìN PC: BOT√ìN "COPIAR LINK" PREMIUM üíé
            (Solo aplica en pantallas grandes, no toca el cel)
            ========================================================= */
            @media (min-width: 769px) {
                .copy-link-btn {
                    background-color: #e3f2fd !important; /* Azulito Original */
                    color: #0d47a1 !important;            /* Letra Azul Fuerte */
                    border: 1px solid #90caf9 !important; 
                    
                    height: 36px !important;        /* Altura C√≥moda PC */
                    padding: 0 20px !important;     /* M√°s aire a los lados */
                    border-radius: 50px !important; /* √ìvalo perfecto */
                    font-size: 13px !important;     /* Letra tama√±o normal */
                    font-weight: 700 !important;
                    
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important;
                    margin: 0 !important;
                    cursor: pointer !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 6px !important; /* Espacio entre icono y texto */
                }

                /* Efecto Hover PC */
                .copy-link-btn:hover {
                    background-color: #bbdefb !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
                }
            }

            /* =========================================================
            RETOQUES FINALES NOCTURNOS (V20.5) üåô
            (M√°s contraste en tabla y fichas para mejor lectura)
            ========================================================= */

            /* 1. EFECTO CEBRA M√ÅS MARCADO (TABLA) */
            /* Cambiamos el gris p√°lido por un "Gris Azulado" m√°s notorio */
            .management-table tr:nth-child(even) td {
                background-color: #eceff1 !important; 
            }
            
            /* ¬°OJO! Esto obliga a la columna fija (#) a oscurecerse tambi√©n */
            body .management-table tr:nth-child(even) td:first-child,
            body.recruiter-view .management-table tr:nth-child(even) td:first-child {
                background-color: #eceff1 !important;
            }

            /* 2. RECUADROS EN MODAL DE VACANTE (Zona, Sueldo, etc.) */
            /* Antes era #f8f9fa (casi blanco), ahora es #eef0f2 (Gris s√≥lido) */
            .job-details {
                background-color: #eef0f2 !important; 
                border: 1px solid #e0e0e0 !important; /* Un bordecito fino ayuda */
            }

            /* 3. LISTAS DE REQUISITOS Y BENEFICIOS */
            /* Tambi√©n las oscurecemos para que resalten */
            .item-list li {
                background-color: #eef0f2 !important;
                border: 1px solid #e0e0e0 !important;
                color: #222 !important; /* Letra un poco m√°s negra */
            }
            
            /* =========================================================
            CORRECCI√ìN: EFECTO HOVER EN TABLA (V20.6) üñ±Ô∏è
            (Para que se ilumine al pasar el mouse, aunque tenga fondo oscuro)
            ========================================================= */
            
            /* Cuando el mouse pasa por CUALQUIER fila de la tabla */
            .management-table tr:hover td {
                background-color: #fff9c4 !important; /* Un amarillo p√°lido bonito para resaltar */
                color: #000 !important; /* Letras negras para contraste total */
                cursor: pointer;
            }

            /* Correcci√≥n espec√≠fica para que la columna "#" tambi√©n se ilumine */
            body.recruiter-view .management-table tr:hover td:first-child {
                background-color: #fff9c4 !important;
                border-right: 2px solid #fbc02d !important; /* Borde dorado al resaltar */
            }

            /* =========================================================
            ESTILO FINAL: BOT√ìN "CYAN FRESH" (V21.0) üßº
            (Color Turquesa Vibrante + Fix Anti-Pegajoso M√≥vil)
            ========================================================= */

            /* 1. ESTADO BASE (El color bonito de tu imagen) */
            #mainShareBtn {
                background-color: #00E5FF !important; /* Turquesa Brillante */
                /* Un degradado sutil para que se vea 3D como la imagen */
                background: linear-gradient(180deg, #26c6da 0%, #00bcd4 100%) !important;
                
                color: white !important;
                border: none !important;
                border-radius: 50px !important; /* Redondito */
                
                /* Tama√±o PC */
                padding: 0 20px !important;
                height: 34px !important;
                font-weight: 800 !important;
                font-size: 13px !important;
                text-shadow: 0 1px 1px rgba(0,0,0,0.2) !important; /* Sombra letra */
                
                /* Sombra suave del bot√≥n */
                box-shadow: 0 4px 6px rgba(0, 188, 212, 0.3) !important;
                
                /* Alineaci√≥n */
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 !important;
                cursor: pointer !important;
                transition: transform 0.1s, background 0.2s !important;
                outline: none !important; /* Quita el cuadro azul de selecci√≥n */
            }

            /* 2. TRUCO M√ìVIL: Si se queda "seleccionado" (:focus), NO CAMBIA */
            /* Esto evita que se quede oscuro cuando quitas el dedo */
            #mainShareBtn:hover,
            #mainShareBtn:focus {
                background: linear-gradient(180deg, #26c6da 0%, #00bcd4 100%) !important;
                transform: none !important;
                box-shadow: 0 4px 6px rgba(0, 188, 212, 0.3) !important;
            }

            /* 3. EL CLIC (Solo mientras presionas el dedo) */
            #mainShareBtn:active {
                background: #0097a7 !important; /* Turquesa Oscuro S√≥lido */
                box-shadow: none !important;    /* Quitamos sombra para que se hunda */
                transform: scale(0.96) !important; /* Efecto rebote */
            }

            /* 4. HOVER SOLO EN PC (Donde hay mouse real) */
            @media (hover: hover) {
                #mainShareBtn:hover {
                    /* Se pone un poquito m√°s brillante */
                    background: linear-gradient(180deg, #4dd0e1 0%, #26c6da 100%) !important;
                    transform: translateY(-2px) !important;
                    box-shadow: 0 6px 12px rgba(0, 188, 212, 0.4) !important;
                }
                #mainShareBtn:active {
                    background: #00838f !important;
                    transform: scale(0.95) !important;
                    box-shadow: none !important;
                }
            }

            /* 5. REGLA DE ORO M√ìVIL (Alineaci√≥n perfecta) */
            @media (max-width: 768px) {
                #mainShareBtn {
                    height: 30px !important;        /* Misma altura que los otros */
                    font-size: 11px !important;
                    padding: 0 15px !important;
                    box-shadow: 0 2px 4px rgba(0, 188, 212, 0.3) !important;
                }
            }

            /* =========================================================
            VISTA ADMIN V22.4 (FINAL PULIDO) ‚ú®
            (Correcciones: Sin Lupa PC, Fondo Blanco M√≥vil, B√∫squeda Limpia)
            ========================================================= */

            /* --- 1. ESTILO PC (TODO EN UNA L√çNEA) --- */
            @media (min-width: 769px) {
                
                /* OCULTAR LA LUPA EN PC (Correcci√≥n 1) */
                #adminSearchToggle { display: none !important; }

                body.admin-mode #adminControls {
                    border-radius: 50px !important;
                    margin: 10px auto 15px auto !important;
                    max-width: 98% !important;
                    padding: 5px 15px !important;
                    border: 1px solid #e0e0e0 !important;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.05) !important;
                    display: flex;
                    justify-content: center;
                    background: white !important; /* Aseguramos fondo blanco en PC */
                }

                body.admin-mode .admin-controls-wrapper {
                    display: flex !important;
                    flex-wrap: nowrap !important;
                    align-items: center !important;
                    gap: 5px !important;
                    width: 100%;
                    justify-content: center;
                }

                /* Botones compactos */
                body.admin-mode .tool-btn, 
                body.admin-mode .add-job-btn {
                    padding: 8px 12px !important;
                    font-size: 13px !important;
                    white-space: nowrap !important;
                    height: 38px !important;
                    display: flex; align-items: center; justify-content: center;
                }

                /* M√©tricas PC (Le quitamos el "body.admin-mode" para que aplique a TODOS) */
                .metrics-card.desktop-only {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 15px !important;
                    padding: 5px 15px !important;
                    background: #f8f9fa !important;
                    border: 1px solid #ddd !important;
                    border-radius: 50px !important;
                    height: 38px !important;
                    align-items: center;
                    
                    /* AGREGAMOS ESTAS 2 L√çNEAS PARA EL TAMA√ëO */
                    font-size: 15px !important; 
                    font-weight: 800 !important;
                }
                #mobileMetricsPanel { display: none !important; }
            }

            /* --- 2. ESTILO M√ìVIL (ESTRATEGIA 2-3-3 CON FONDO) --- */
            @media (max-width: 768px) {
                
                /* --- CORRECCI√ìN PANEL B√öSQUEDA (LIMPIEZA) --- */
                /* Ocultar barra por defecto */
                body.admin-mode #userStickyTools { display: none; }
                
                /* Cuando se activa con la Lupa: */
                body.admin-mode #userStickyTools.active { 
                    display: block !important; 
                    animation: fadeIn 0.3s;
                    margin-top: 10px !important;
                    margin-bottom: 10px !important;
                }

                /* OCULTAR BOT√ìN "FILTROS DE B√öSQUEDA" EN ADMIN (Correcci√≥n 2) */
                body.admin-mode #mobileFilterToggle { display: none !important; }

                /* FORZAR QUE LOS FILTROS SE VEAN SIEMPRE (Ya que quitamos el bot√≥n) */
                body.admin-mode #filterContainer {
                    display: flex !important;
                    height: auto !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    margin-top: 8px !important; /* Espacio con el input */
                }
                
                /* Mostrar Lupa en Header */
                body.admin-mode #adminSearchToggle { display: inline-flex !important; font-size: 16px !important; width: 32px !important; height: 32px !important; align-items: center; justify-content: center; border-radius: 50%; border: none; }

                /* PANEL DE M√âTRICAS (La tira delgada) */
                body.admin-mode #mobileMetricsPanel {
                    display: block !important;
                    background: white;
                    margin: 5px 10px 0 10px;
                    border-radius: 10px;
                    border: 1px solid #e0e0e0;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
                    padding: 6px;
                    text-align: center;
                }
                .metrics-strip {
                    display: flex; justify-content: center; align-items: center; gap: 15px;
                    font-size: 13px; color: #333;
                }
                .metrics-strip b { color: #0a66c2; font-weight: 900; font-size: 14px; }
                
                .metrics-card.desktop-only { display: none !important; }

                /* --- CORRECCI√ìN 3: CONTENEDOR BLANCO DE VUELTA --- */
                body.admin-mode #adminControls {
                    background: white !important; /* ¬°Fondo Blanco Regresa! ‚¨ú */
                    border: 1px solid #e0e0e0 !important; /* Bordecito sutil */
                    border-radius: 16px !important; /* Esquinas redondeadas */
                    box-shadow: 0 4px 10px rgba(0,0,0,0.05) !important; /* Sombrita */
                    
                    padding: 10px 8px !important; /* Relleno interno */
                    margin: 10px 5px !important; /* Margen externo */
                    position: static !important;
                }

                /* EL GRID 2-3-3 */
                body.admin-mode .admin-controls-wrapper {
                    display: grid !important;
                    grid-template-columns: repeat(6, 1fr) !important; 
                    gap: 8px !important; /* Un poco m√°s de aire ahora que hay fondo */
                }

                /* Estilo Base Botones M√≥vil */
                body.admin-mode button {
                    margin: 0 !important;
                    padding: 0 5px !important;
                    height: 40px !important;
                    font-size: 11px !important;
                    border-radius: 8px !important;
                    display: flex !important;
                    align-items: center; justify-content: center; gap: 4px;
                }

                /* POSICIONES - 3 botones en primera fila (Vista + Sitemap + Nueva) */
                #viewToggleBtn      { order: 1; grid-column: span 2 !important; background: #004d40 !important; }
                #seoSitemapBtn      { order: 2; grid-column: span 2 !important; background: #FF9800 !important; color: white !important; }
                .add-job-btn        { order: 3; grid-column: span 2 !important; }

                button[onclick*="exportToExcel"] { grid-column: span 2 !important; }
                .metrics-btn                     { grid-column: span 2 !important; }
                .team-btn                        { grid-column: span 2 !important; }
                .settings-btn                    { grid-column: span 2 !important; }
                button[onclick*="excelFile"]     { grid-column: span 2 !important; }
                button[onclick*="downloadTemplate"] { grid-column: span 2 !important; }
            }

            /* =========================================================
            CORRECCIONES POST-PRODUCCI√ìN (V22.1) üöë
            (Arreglo de Reclutador M√≥vil y Lupa Fantasma)
            ========================================================= */

            /* 1. MATAR LA LUPA EN MODO USUARIO/INVITADO üïµÔ∏è‚Äç‚ôÇÔ∏èüö´ */
            /* Aseguramos que la lupa SOLO se vea si tienes la clase .admin-mode */
            #adminSearchToggle { display: none !important; }
            
            /* Solo si eres Admin Y est√°s en celular, aparece la lupa */
            @media (max-width: 768px) {
                body.admin-mode #adminSearchToggle {
                    display: inline-flex !important;
                }
            }

            /* 2. REPARACI√ìN MODO RECLUTADOR M√ìVIL (GRID 2x2) üì± */
            @media (max-width: 768px) {
                /* Forzamos al contenedor a usar 2 columnas simples */
                body.recruiter-view .admin-controls-wrapper {
                    grid-template-columns: 1fr 1fr !important; /* 2 Columnas iguales */
                    gap: 10px !important;
                    display: grid !important;
                }

                /* Reseteamos los botones para que no se estiren raro (quitamos el span 3 o span 2 del admin) */
                body.recruiter-view .admin-controls-wrapper button {
                    grid-column: auto !important; /* Que ocupen solo 1 espacio */
                    width: 100% !important;
                    margin: 0 !important;
                }
                
                /* Ajuste espec√≠fico para el bot√≥n "Vista" en Reclutador */
                body.recruiter-view #viewToggleBtn {
                    grid-column: auto !important; /* Le quitamos el "span 3" del admin */
                }
            }

            /* 3. HOMOLOGACI√ìN T√çTULOS TABLA (RECLUTADOR M√ìVIL) üìè */
            /* Forzamos que en el celular del reclutador se vea igual que en PC */
            @media (max-width: 768px) {
                body.recruiter-view .management-table th {
                    font-size: 13px !important;      /* Tama√±o grande legible */
                    font-weight: 800 !important;     /* Negrita fuerte */
                    text-transform: uppercase !important;
                    padding: 10px 5px !important;
                    letter-spacing: 0.5px !important;
                }
            }

            /* =========================================================
            CORRECCI√ìN FINAL: MATAR BOT√ìN M√ìVIL EN PC (V22.2) ‚ò†Ô∏è
            (Ese bot√≥n "Filtros de B√∫squeda" NO debe existir en escritorio)
            ========================================================= */
            @media (min-width: 769px) {
                #mobileFilterToggle { 
                    display: none !important; /* ¬°Adi√≥s para siempre en PC! */
                }
            }

            /* =========================================================
            CORRECCI√ìN FINAL: SIN BUSCADOR EN RECLUTADOR (V22.3) üö´
            (El reclutador no necesita buscar, solo gestionar)
            ========================================================= */
            body.recruiter-view #userStickyTools {
                display: none !important;
            }

            /* =========================================================
            CORRECCI√ìN FINAL: IGUALAR TAMA√ëOS PC (V22.5) üëî
            (Le ponemos el traje 'Grande' al Reclutador para que se vea igual al Admin)
            ========================================================= */
            @media (min-width: 769px) {
                /* Apuntamos a AMBOS modos expl√≠citamente para ganar la prioridad */
                body.admin-mode .metrics-card.desktop-only,
                body.recruiter-view .metrics-card.desktop-only {
                    /* 1. TAMA√ëO F√çSICO (Crecemos de 32px a 38px) */
                    height: 38px !important;      
                    padding: 5px 20px !important; 
                    border-radius: 50px !important;
                    
                    /* 2. TAMA√ëO DE LETRA (Crecemos de 12px a 15px) */
                    font-size: 12px !important;   
                    font-weight: 800 !important;

                    /* 3. EST√âTICA */
                    display: flex !important;
                    flex-direction: row !important;
                    align-items: center !important;
                    gap: 15px !important;
                    background: #f8f9fa !important;
                    border: 1px solid #ddd !important;
                    width: auto !important; /* Que no se estire a lo ancho */
                }
                
                /* Un toquecito extra al n√∫mero para que resalte */
                .metrics-card.desktop-only .m-number {
                    font-size: 13px !important;
                }
            }
    

            /* =========================================================
            CORRECCIONES MODO RECLUTADOR - M√ìVIL (PARCHE SEGURO) üì±
            ========================================================= */
            @media (max-width: 768px) {
                
                /* 1. OCULTAR LUPA (FILTROS) DEL PRIMER PANEL */
                /* Solo en modo reclutador */
                body.recruiter-view #adminSearchToggle,
                body.recruiter-mode #adminSearchToggle {
                    display: none !important;
                }

                /* 2. ELIMINAR EL PANEL DE "VISTAS" DUPLICADO (Tira suelta) */
                /* Quitamos la tira gris y dejamos solo el bot√≥n de "M√©tricas" */
                body.recruiter-view #mobileMetricsPanel,
                body.recruiter-mode #mobileMetricsPanel {
                    display: none !important;
                }

                /* 3. HOMOLOGAR T√çTULOS DE VACANTES (Para que se vean parejos) */
                body.recruiter-view .job-title,
                body.recruiter-mode .job-title {
                    font-size: 16px !important;    /* Tama√±o est√°ndar */
                    font-weight: 700 !important;   /* Negrita */
                    line-height: 1.3 !important;   /* Espaciado limpio */
                    margin-bottom: 5px !important;
                    min-height: auto !important;   /* Evita espacios raros */
                }
            }

        


            /* =========================================================
            CORRECCIONES RECLUTADOR M√ìVIL (V22.FINAL) üì±
            (Parche Seguro: Lupa, Vistas Duplicadas y T√≠tulos)
            ========================================================= */
            @media (max-width: 768px) {
                
                /* 1. OCULTAR LUPA (FILTROS) DEL PRIMER PANEL */
                /* Se oculta solo en la vista de reclutador */
                body.recruiter-view #adminSearchToggle {
                    display: none !important;
                }

                /* 2. ELIMINAR EL PANEL DE "VISTAS" DUPLICADO (El suelto) */
                /* Dejamos solo el que est√° integrado en los botones */
                body.recruiter-view #mobileMetricsPanel {
                    display: none !important;
                }

                /* 3. HOMOLOGAR T√çTULOS DE VACANTES */
                /* Forzamos un tama√±o id√©ntico para todos */
                body.recruiter-view .job-title {
                    font-size: 16px !important;  /* Tama√±o est√°ndar y legible */
                    line-height: 1.3 !important; /* Espaciado limpio */
                    font-weight: 700 !important; /* Negrita */
                    margin-bottom: 5px !important;
                    min-height: auto !important; /* Evita huecos extra√±os */
                }
                                body.recruiter-view #seoSitemapBtn {
                    display: none !important;
                }
            }

        

        </style>    
    </head>
    <body>

        <div id="globalBackground"></div>

       <div id="flyerTemplate">
            <div style="position: absolute; top:0; left:0; width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1542744173-8e7e53415bb0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1080&q=60') center center / cover no-repeat; opacity: 0.1; z-index: 0;"></div>
            <div style="position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(10, 25, 45, 0.05); z-index: 1;"></div>
            
            <div class="flyer-badge-top">¬°SE SOLICITA!</div>
            <div class="flyer-company">RECONOCIDA EMPRESA BUSCA:</div>
            
            <div id="flyerTitle" class="flyer-title">PUESTO VACANTE</div>
            
            <div id="flyerSalary" class="flyer-salary" style="margin-bottom: 5px;">$0,000</div>
            
            <div id="flyerLocation" style="
                font-size: 50px; 
                color: #FFFFFF !important; 
                font-family: sans-serif; 
                font-weight: 800; 
                margin-top: 5px; 
                margin-bottom: 40px; 
                text-transform: uppercase; 
                text-shadow: 0 4px 10px rgba(0,0,0,1); 
                z-index: 10; 
                position: relative; 
                display: block;">
                üìç UBICACI√ìN PENDIENTE
            </div>

            <div class="flyer-benefits-container">
                <div class="flyer-benefits-title">OFRECEMOS:</div>
                <ul id="flyerBenefitsList" class="flyer-benefits-list">
                    <li>‚úÖ Prestaciones de Ley</li>
                </ul>
            </div>
            
            <div class="flyer-cta-box">
                üîó DALE CLIC AL LINK DE LA PUBLICACI√ìN PARA CONOCER DETALLES Y AGENDAR ENTREVISTA
                <div id="flyerQr"></div>
            </div>
        </div>

        <div id="loginScreen" class="welcome-container">
            <div style="font-size: 50px; margin-bottom: 10px;">üöÄ</div>
            <h1 class="welcome-title">TuChamba Express</h1>
            <p class="welcome-subtitle">
                Tu nueva chamba a un mensaje de distancia.<br>
                Sin registros complicados.
            </p>
            <button class="btn-big-guest" onclick="enterAsGuest()">üîç Ver Vacantes Disponibles</button>
            <div class="admin-toggle-link" onclick="toggleAdminLogin()">¬øEres Reclutador? Ingresa aqu√≠</div>
            <form id="adminForm" class="admin-login-form" onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label style="color:white;">Usuario / Correo</label>
                    <input type="text" id="adminEmail" placeholder="Usuario o Correo" autocomplete="username" enterkeyhint="next" style="background:rgba(255,255,255,0.9);">
                </div>
                    <div class="form-group">
                    <label style="color:white;">Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="adminPassword" placeholder="******" autocomplete="current-password" enterkeyhint="go" style="background:rgba(255,255,255,0.9);">
                        
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility()">
                            <img id="ojoIcono" src="ver.png" alt="Ver Password">
                        </span>

                    </div>
                </div>
                <button type="submit" id="btnLogin" class="btn-primary" style="width: 100%;">Entrar al Panel</button>
            </form>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="container">
                
                <div class="header">
                    <h1>Portal de Vacantes</h1>
                    <div class="header-buttons">
                        <button id="adminSearchToggle" class="admin-only btn-icon-small" onclick="toggleAdminSearch()" style="display:none; background:#eee; color:#333;">üîç</button>
                        
                        <button id="mainShareBtn" class="share-btn" onclick="shareApp()">üì§ Compartir</button>
                        <span id="modeIndicator"></span>
                        <button class="admin-btn" style="background: #333;" onclick="logout()">Salir</button>
                    </div>
                </div>

                <div id="mobileMetricsPanel" style="display:none;">
                    <div class="metrics-strip">
                        <span>üåé Total: <b id="totalVisitsMobile">...</b></span>
                        <span style="opacity:0.3">|</span>
                        <span>üìÖ Mes: <b id="monthlyVisitsMobile">...</b></span>
                    </div>
                </div>

                <div id="adminControls" style="display: none;">
                    <div class="admin-controls-wrapper">
                        
                        <button id="viewToggleBtn" class="tool-btn" style="background:#00796b;" onclick="toggleViewMode()">üëÅÔ∏è Vista</button>
                        <button class="add-job-btn admin-only" onclick="openJobForm()">‚ûï Nueva</button>
                        
                        <div class="metrics-card desktop-only">
                            <div class="metric-row">üåé <span class="m-label">Total:</span> <span id="totalVisits" class="m-number">...</span></div>
                            <div class="metric-row">üìÖ <span class="m-label">Mes:</span> <span id="monthlyVisits" class="m-number">...</span></div>
                        </div>

                        <button class="tool-btn" onclick="exportToExcel()">üì¶ Respaldo</button> 
                        <button class="tool-btn metrics-btn" onclick="openMetricsModal()">üìä M√©tricas</button>
                        <button class="tool-btn team-btn admin-only" onclick="openTeamModal()">üë• Equipo</button>
                        <button class="tool-btn settings-btn admin-only" onclick="openSettingsModal()">‚öôÔ∏è Ajustes</button>
                        <button class="tool-btn admin-only" onclick="document.getElementById('excelFile').click()">üì§ Cargar</button>
                        <button class="tool-btn" onclick="downloadTemplate()">üìã Plantilla</button>
                        <button id="seoSitemapBtn" class="tool-btn" onclick="window.downloadSitemap()" style="background-color: #FF9800; color: white;">üó∫Ô∏è Sitemap SEO</button>
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importFromExcel(event)">
                    </div>
                </div>

                <div id="userStickyTools">
                    <button id="mobileFilterToggle" onclick="toggleMobileFilters()">
                        üîç Filtros de B√∫squeda <span>‚ñº</span>
                    </button>

                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar vacante, empresa, palabras clave..." onkeyup="filterJobs()" autocomplete="off">
                        <button id="clearSearchBtn" class="search-clear-btn" onclick="clearSearch()">‚úï</button>
                    </div>

                    <div class="filter-container" id="filterContainer">
                        <div class="filter-icon-box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                        </div>
                        <select id="stateFilter" class="filter-select" onchange="handleStateChange()" autocomplete="off">
                            <option value="">üìç Estado</option>
                        </select>
                        <select id="cityFilter" class="filter-select" onchange="filterJobs()" autocomplete="off">
                            <option value="">üèôÔ∏è Municipio</option>
                        </select>
                    </div>
                </div>

    <div id="universalCounter" class="detailed-counter" style="display:none;">
                    <span class="counter-tag tag-total" id="countTotal">Total: 0</span>
                    <span class="counter-tag tag-active" id="countActive">üü¢ 0 Vigentes</span>
                    <span class="counter-tag tag-inactive" id="countInactive">üî¥ 0 No Vigentes</span>
                </div>
                
                <div id="tableHint" style="font-size: 12px; color: #999; text-align: right; margin-bottom: 5px; display: none;">
                    Desliza la tabla ‚û°Ô∏è
                </div>

                <div id="skeletonLoader" class="job-grid">
                    <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
                    <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
                </div>

                <div class="job-grid" id="jobGrid" style="display: none;"></div>

                <div class="job-table-container" id="jobTableContainer" style="display: none;">
                    <table class="management-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                
                                <th>
                                    <select id="headerCompanyFilter" class="header-select" onchange="renderJobsTable()">
                                        <option value="">üè¢ EMPRESAS</option>
                                        </select>
                                </th>

                                <th onclick="window.handleSort('title')" style="cursor:pointer;">üíº Vacante ‚ÜïÔ∏è</th>
                                <th onclick="window.handleSort('location')" style="cursor:pointer;">üìç Ubicaci√≥n ‚ÜïÔ∏è</th>
                                <th onclick="window.handleSort('salary')" style="cursor:pointer;">üí∞ Salario ‚ÜïÔ∏è</th>
                                <th onclick="window.handleSort('status')" style="cursor:pointer; text-align:center;">Estado ‚ÜïÔ∏è</th>
                                <th style="text-align:right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="jobTableBody">
                            </tbody>
                    </table>
                </div>
                
                <div id="paginationContainer" class="pagination-container" style="display:none;"></div>
                
                <div id="recruiterBanner" onclick="contactCentralOffice()">
                    üë§ Asistido por: <span id="recruiterNameDisplay">Oficina Central</span> (Clic para contacto)
                </div>

                <div class="footer">
                    <p>TuChamba Express &copy; 2026. Todos los derechos reservados.<br>
                    Aviso: Algunas empresas pueden solicitar examen m√©dico y/o antidoping.</p>
                    <div style="margin-top:10px;">
                        <a class="footer-link" onclick="openPrivacyModal()">üîí Aviso de Privacidad</a>
                    </div>
                    <p class="powered-by">Powered by <strong>BitX</strong></p>
                </div>

                <div id="emptyState" class="welcome-container" style="display: none; padding: 30px; margin-top: 20px;">
                    <h3>No hay vacantes publicadas üò¢</h3><p>Intenta m√°s tarde o ajusta los filtros.</p>
                </div>
            </div>
        </div>

        <div id="toast"></div>

        <div class="modal" id="viewModal"><div class="modal-content"><button class="close-btn" onclick="closeViewModal()">√ó</button><div id="viewModalBody"></div></div></div>

        <div class="modal" id="formModal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeFormModal()">√ó</button>
                <h2 id="formTitle">Gestionar Vacante</h2>
                <form id="jobForm" onsubmit="saveJob(event)">
                    <div class="form-group"><label>Estatus</label><select id="jobStatus"><option value="Vigente">Vigente (Verde)</option><option value="No Vigente">No Vigente (Rojo)</option></select></div>
                    
                    <div class="form-group" style="background: #fff8e1; padding: 10px; border-radius: 8px; border: 1px dashed #ffd54f;">
                        <label style="color: #ff8f00;">‚≠ê ¬øImpulsar Vacante? (Destacada)</label>
                        <select id="jobIsFeatured">
                            <option value="false">NO (Normal)</option>
                            <option value="true">S√ç (Destacar)</option>
                        </select>
                    </div>

                    <div class="form-group"><label>¬øMostrar nombre de empresa al p√∫blico?</label><select id="jobShowCompany"><option value="true">S√ç (Visible para todos)</option><option value="false">NO (Confidencial / Solo Admin)</option></select></div>
                    
                    <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ef6c00;">
                        <label style="color: #e65100;">üè¢ Tipo de Servicio o Agencia (Interno)</label>
                        <input type="text" id="jobAgency" placeholder="Ej. Agencia Norte - Solo visible para Reclutador">
                    </div>
                    <div class="form-group"><label>T√≠tulo *</label><input type="text" id="jobTitle" required></div>
                    <div class="form-group"><label>Empresa (Nombre Real) *</label><input type="text" id="jobCompany" required placeholder="Escribe el nombre real aqu√≠"></div>
                    
                    <div class="form-group">
                        <label>Ubicaci√≥n Detallada *</label>
                        <div class="location-grid">
                            <input type="text" id="jobState" placeholder="Estado (Ej. CDMX)" required>
                            <input type="text" id="jobCity" placeholder="Municipio (Ej. Coyoac√°n)" required>
                            <input type="text" id="jobZone" placeholder="Colonia/Zona (Ej. Centro)">
                        </div>
                    </div>

                    <div class="form-group"><label>Fecha de Publicaci√≥n</label><input type="date" id="jobDate"></div>
                    
                    <div class="form-group"><label>Salario</label><input type="text" id="jobSalary" placeholder="$8,500/mes"></div>
                    <div class="form-group"><label>Descripci√≥n *</label><textarea id="jobDescription" required></textarea></div>
                    <div class="form-group"><label>Jornada / Horario</label><input type="text" id="jobSchedule" placeholder="Ej. Lunes a Viernes 9 a 6"></div>
                    
                    <div class="form-group"><label>Etiquetas</label><input type="text" id="jobTags" placeholder="#Ventas, #Seguros"></div>
                    <div class="form-group"><label>Requisitos</label><div class="list-input"><input type="text" id="reqInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('req')">+</button></div><ul class="item-list" id="reqList"></ul></div>
                    <div class="form-group"><label>Beneficios</label><div class="list-input"><input type="text" id="benInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('ben')">+</button></div><ul class="item-list" id="benList"></ul></div>
                    
                    <div class="form-group">
                        <label>WhatsApp Contacto (N√∫mero Real)</label>
                        <div class="phone-group">
                            <select id="recPhoneCode" class="phone-select">
                                <option value="+52">üá≤üáΩ +52</option>
                                <option value="+54">üá¶üá∑ +54</option>
                                <option value="+591">üáßüá¥ +591</option>
                                <option value="+55">üáßüá∑ +55</option>
                                <option value="+56">üá®üá± +56</option>
                                <option value="+57">üá®üá¥ +57</option>
                                <option value="+506">üá®üá∑ +506</option>
                                <option value="+53">üá®üá∫ +53</option>
                                <option value="+593">üá™üá® +593</option>
                                <option value="+503">üá∏üáª +503</option>
                                <option value="+34">üá™üá∏ +34</option>
                                <option value="+1">üá∫üá∏ +1</option>
                                <option value="+502">üá¨üáπ +502</option>
                                <option value="+504">üá≠üá≥ +504</option>
                                <option value="+505">üá≥üáÆ +505</option>
                                <option value="+507">üáµüá¶ +507</option>
                                <option value="+595">üáµüáæ +595</option>
                                <option value="+51">üáµüá™ +51</option>
                                <option value="+1">üá©üá¥ +1</option>
                                <option value="+598">üá∫üáæ +598</option>
                                <option value="+58">üáªüá™ +58</option>
                            </select>
                            <input type="text" id="jobContact" placeholder="10 d√≠gitos (Ej. 5512345678)" style="flex:1;">
                        </div>
                    </div>

                    <div class="form-actions"><button type="button" class="tool-btn" style="background:#666; width:100%" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary" style="width:100%">Guardar</button></div>
                </form>
            </div>
        </div>

        <div class="modal" id="metricsModal"><div class="modal-content"><button class="close-btn" onclick="closeMetricsModal()">√ó</button><h2>üìä Exportar M√©tricas</h2><p style="margin-bottom:10px; color:#666;">Selecciona los meses que deseas incluir en el reporte:</p><div id="metricsMonthList" style="margin: 15px 0; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background:#f9f9f9;"><p style="text-align:center; color:#999;">Cargando historial...</p></div><button class="btn-primary" style="width:100%" onclick="downloadSelectedMetrics()">üì• Descargar Excel Consolidado</button></div></div>
        <div class="modal" id="teamModal">
            <div class="modal-content">
                <div class="modal-header-pro">
                    <h2>üë• Gesti√≥n de Equipo</h2>
                    <button class="close-btn" style="position:static;" onclick="closeTeamModal()">√ó</button>
                </div>
                
                <div class="modern-form-box">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label>Nombre del Reclutador</label>
                            <input type="text" id="recName" placeholder="Ej. Juan P√©rez">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo √önico (Link)</label>
                            <input type="text" id="recCode" placeholder="Ej. JUAN (Sin espacios)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>WhatsApp de Contacto</label>
                        <div class="phone-group">
                            <select id="recPhoneCode" class="phone-select">
                                <option value="+52">üá≤üáΩ +52</option>
                                <option value="+54">üá¶üá∑ +54</option>
                                <option value="+591">üáßüá¥ +591</option>
                                <option value="+55">üáßüá∑ +55</option>
                                <option value="+56">üá®üá± +56</option>
                                <option value="+57">üá®üá¥ +57</option>
                                <option value="+506">üá®üá∑ +506</option>
                                <option value="+53">üá®üá∫ +53</option>
                                <option value="+593">üá™üá® +593</option>
                                <option value="+503">üá∏üáª +503</option>
                                <option value="+34">üá™üá∏ +34</option>
                                <option value="+1">üá∫üá∏ +1</option>
                                <option value="+502">üá¨üáπ +502</option>
                                <option value="+504">üá≠üá≥ +504</option>
                                <option value="+505">üá≥üáÆ +505</option>
                                <option value="+507">üáµüá¶ +507</option>
                                <option value="+595">üáµüáæ +595</option>
                                <option value="+51">üáµüá™ +51</option>
                                <option value="+1">üá©üá¥ +1</option>
                                <option value="+598">üá∫üáæ +598</option>
                                <option value="+58">üáªüá™ +58</option>
                            </select>
                            <input type="text" id="recPhone" placeholder="10 d√≠gitos" style="flex:1;">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                            <button class="btn-primary" style="flex:1;" id="btnSaveRecruiter" onclick="saveRecruiter()">
                                üíæ Guardar
                            </button>
                            
                            <button class="tool-btn" style="background:#2e7d32; flex:1; justify-content:center;" onclick="downloadRecruitersDB()">
                                üì• Base
                            </button>

                        </div>
                </div>

                <h3 style="font-size:16px; margin-bottom:10px; color:#555;">üìÇ Directorio Activo</h3>
                <div class="table-container-pro">
                    <div style="overflow-x: auto;">
                        <table class="recruiters-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>C√≥digo</th>
                                    <th style="text-align:center;">Link</th>
                                    <th style="text-align:right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="recruitersList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal" id="settingsModal"><div class="modal-content"><button class="close-btn" onclick="closeSettingsModal()">√ó</button><h2>‚öôÔ∏è Ajustes del Sistema</h2><div class="form-group"><label>üìû Tel√©fono Oficina Central (Respaldo)</label><div style="display:flex; gap:10px;"><input type="text" id="settingsPhoneInput" placeholder="Ej. 5512345678" style="flex:1;"><button class="btn-primary" id="btnSaveCentral" onclick="saveCentralConfig()">Guardar</button></div><p style="font-size:12px; color:#666; margin-top:5px;">Este n√∫mero se usa si la vacante no tiene contacto o est√° mal escrito.</p></div><div class="danger-section"><h3 style="color:#d32f2f; margin-bottom:10px;">‚ö†Ô∏è Zona de Peligro (Admin)</h3><p style="font-size:13px; color:#666; margin-bottom:10px;">Acciones irreversibles protegidas por contrase√±a.</p><button class="danger-btn" onclick="performSafeAction('resetMetrics')">üóëÔ∏è Resetear M√©tricas (Vistas)</button><button class="danger-btn" onclick="performSafeAction('deleteJobs')">üî• Borrar TODAS las Vacantes</button></div></div></div>
        <div class="modal" id="privacyModal"><div class="modal-content"><button class="close-btn" onclick="closePrivacyModal()">√ó</button><h2>üîí Aviso de Privacidad</h2><div style="text-align: left; color: #444; line-height: 1.6; font-size: 14px; max-height: 70vh; overflow-y: auto;"><p style="font-size: 12px; color: #666; margin-bottom: 15px;"><strong>√öltima actualizaci√≥n: Enero 2026</strong></p><p style="margin-bottom: 15px;">En cumplimiento con la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares, <strong>TuChamba Express</strong> informa:</p><p style="margin-bottom:5px;"><strong>1. Responsable de los datos:</strong></p><p style="margin-bottom:15px;">TuChamba Express act√∫a como enlace entre candidatos y empresas reclutadoras.</p><p style="margin-bottom:5px;"><strong>2. Datos recopilados:</strong></p><p style="margin-bottom:15px;">Podemos recopilar datos de contacto (como n√∫mero telef√≥nico) con el √∫nico fin de facilitar la comunicaci√≥n para procesos de reclutamiento.</p><p style="margin-bottom:5px;"><strong>3. Uso de la informaci√≥n:</strong></p><p style="margin-bottom:5px;">Los datos proporcionados ser√°n utilizados exclusivamente para:</p><ul style="margin-left: 20px; margin-bottom: 15px;"><li>Contactar al candidato respecto a la vacante de inter√©s.</li><li>Agendar entrevistas laborales.</li><li>Procesos internos de selecci√≥n.</li></ul><p style="margin-bottom:5px;"><strong>4. Compartir datos:</strong></p><p style="margin-bottom:15px;">Su informaci√≥n de contacto ser√° compartida √∫nicamente con la empresa o reclutador responsable de la vacante a la que usted decida postularse voluntariamente.</p><p style="margin-bottom:5px;"><strong>5. Examen M√©dico:</strong></p><p style="margin-bottom:0;">Al utilizar esta plataforma, usted reconoce que algunas empresas contratantes pueden requerir, como parte de su proceso de selecci√≥n y conforme a la ley, la realizaci√≥n de ex√°menes m√©dicos y/o pruebas de detecci√≥n de sustancias.</p></div></div></div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            import { getDatabase, ref, set, onValue, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

            const firebaseConfig = {
            apiKey: "AIzaSyB1k1lnQjQXiGYJRT9E9-KYzGSBBmrQGFI",
            authDomain: "vacancy-page-v2.firebaseapp.com",
            databaseURL: "https://vacancy-page-v2-default-rtdb.firebaseio.com",
            projectId: "vacancy-page-v2",
            storageBucket: "vacancy-page-v2.firebasestorage.app",
            messagingSenderId: "242419485392",
            appId: "1:242419485392:web:c486a767a1810ada876cd5"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            let isAdmin = false;
            let recruitersLoaded = false; // <--- NUEVA BANDERA DE CONTROL
            let isRecruiterMode = false; 
            let currentViewMode = 'grid'; 

            let currentUserEmail = ""; 
            let currentEditId = null;
            let jobs = {};
            let jobStats = {}; 
            let recruiters = {}; 
            let clickLogs = {};
            
            let activeRecruiter = null; 
            let centralPhone = ''; 
            let editingRecruiterId = null; 

            let tempReqs = [];
            let tempBens = [];
            
            let currentPage = 1;
            const itemsPerPage = 15;
            let currentFilteredJobs = []; 

            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            
            // --- TAREA 13: L√ìGICA DE REFERIDOS BLINDADA (V26.2) ---
            const urlParams = new URLSearchParams(window.location.search);
            // 1. Detectamos si la URL trae un referido hoy
            let refEnUrl = urlParams.get('ref');
            // 2. Si hay referido en URL, lo guardamos para que mande los WhatsApps a ese reclutador
            if (refEnUrl) {
            localStorage.setItem('recruiterCode', refEnUrl.toUpperCase());
            }
            // 3. El c√≥digo "maestro" de la sesi√≥n es lo que est√° en memoria
            let refCode = localStorage.getItem('recruiterCode');
            function actualizarBotonLogin() {
                    const botonAdmin = document.querySelector('.admin-toggle-link');
                    if (!botonAdmin) return;

                    // L√ìGICA DE VISIBILIDAD:
                    // Solo ocultamos el bot√≥n si la URL trae un ?ref=... 
                    // Si la URL est√° limpia (Original), el bot√≥n APARECE para que puedas loguearte.
                    if (urlParams.has('ref')) {
                        botonAdmin.style.display = 'none';
                    } else {
                        botonAdmin.style.display = 'block';
                    }
            }

            // Ejecutamos la revisi√≥n
            actualizarBotonLogin();
            document.addEventListener("DOMContentLoaded", actualizarBotonLogin);
            window.addEventListener('load', actualizarBotonLogin);

            // Ejecutamos la revisi√≥n en tres momentos clave para que nunca falle:
            actualizarBotonLogin(); // 1. En cuanto carga el script.
            document.addEventListener("DOMContentLoaded", actualizarBotonLogin); // 2. Cuando el dise√±o est√° listo.
            window.addEventListener('load', actualizarBotonLogin); // 3. Por si las dudas, al final de todo.

            // 2. Validamos y guardamos (o renovamos)
            if (refCode) {
                refCode = refCode.toUpperCase(); // Siempre may√∫sculas
                localStorage.setItem('recruiterCode', refCode); // Usamos localStorage (Persistente)

                // 3. UX: Ocultar el bot√≥n de "Ingresa aqu√≠" para no distraer al candidato referido
                document.addEventListener("DOMContentLoaded", () => {
                    const adminLink = document.querySelector('.admin-toggle-link');
                    if(adminLink) adminLink.style.display = 'none';
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('cityFilter').value = '';
            });

            window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Limpieza extra + recarga limpia
                document.getElementById('searchInput').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('cityFilter').value = '';
                window.location.reload();
            }
            });

            // === FORZAR RECARGA FRESCA CUANDO LA P√ÅGINA VIENE DE BFCACHE ===
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    // Se restaur√≥ desde cach√© ‚Üí recargamos limpia
                    window.location.reload();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    if(document.getElementById('viewModal').classList.contains('active')) closeViewModal();
                    else if(document.getElementById('formModal').classList.contains('active')) closeFormModal();
                    else if(document.getElementById('metricsModal').classList.contains('active')) closeMetricsModal();
                    else if(document.getElementById('teamModal').classList.contains('active')) closeTeamModal();
                    else if(document.getElementById('settingsModal').classList.contains('active')) closeSettingsModal();
                    else if(document.getElementById('privacyModal').classList.contains('active')) closePrivacyModal();
                    
                    document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
                }
            });

            // ----------------------------------------------------
            // 4. AUTENTICACI√ìN BLINDADA (ROLES + RECLUTADORES) üõ°Ô∏è
            // ----------------------------------------------------
            onAuthStateChanged(auth, (user) => {
                const urlJobId = urlParams.get('id'); 
                const isRecruiterSession = sessionStorage.getItem('isRecruiterSession') === 'true';

                if (user) {
                    // --- USUARIO LOGUEADO: VERIFICAMOS ROL EN DB ---
                    // Usamos onValue para seguridad en tiempo real
                    const roleRef = ref(db, 'userRoles/' + user.uid);
                    
                    onValue(roleRef, (snapshot) => {
                        const roleData = snapshot.val();
                        
                        if (roleData && roleData.role === 'admin') {
                            // ‚úÖ ES ADMIN REAL
                            console.log("üëë Rol Admin verificado en DB");
                            isAdmin = true; 
                            currentUserEmail = user.email; 
                            
                            setAdminMode(true); 
                            localStorage.setItem('iamsuperadmin', 'true');
                            
                            // Evitamos spam de toasts
                            if(!document.body.classList.contains('admin-active-flag')) {
                                window.showToast("‚úÖ Modo Admin Activo");
                                document.body.classList.add('admin-active-flag');
                            }
                        } else {
                            // ‚õî TIENE LOGIN PERO NO ES ADMIN
                            console.warn("Acceso denegado: Rol insuficiente");
                            alert("Tu cuenta no tiene permisos de Administrador.");
                            signOut(auth); 
                            setAdminMode(false);
                        }
                    }, (error) => {
                        console.error("Error verificando rol:", error);
                        setAdminMode(false);
                    });

                } else {
                    // --- NO HAY USUARIO FIREBASE ---
                    isAdmin = false;
                    currentUserEmail = "";
                    localStorage.removeItem('iamsuperadmin');
                    document.body.classList.remove('admin-active-flag');

                    // A) RECLUTADOR POR C√ìDIGO (NO LO TOCAMOS)
                    if (isRecruiterSession) {
                        console.log("‚è≥ Reclutador activo...");
                        return; 
                    }

                    // B) INVITADO O LINK
                    if (sessionStorage.getItem('isGuest') === 'true' || urlJobId) { 
                        setAdminMode(false); 
                    } 
                    // C) NADIE -> LOGIN
                    else { 
                        showLogin(); 
                    }
                }
            });

            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('active');
                }
                document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
            }

            window.openMetricsModal = function() {
                document.getElementById('metricsModal').classList.add('active');
                populateMetricsList(); 
            }
            window.closeMetricsModal = function() { document.getElementById('metricsModal').classList.remove('active'); }

            window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

            window.openSettingsModal = function() { document.getElementById('settingsModal').classList.add('active'); if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone; }
            window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.remove('active'); }

            window.openPrivacyModal = function() { document.getElementById('privacyModal').classList.add('active'); }
            window.closePrivacyModal = function() { document.getElementById('privacyModal').classList.remove('active'); }

            // FUNCI√ìN ZONA DE PELIGRO (COMPATIBLE SIN CAMBIAR IMPORTS) üõ†Ô∏è
            window.performSafeAction = function(action) {
                // 1. Solo validamos isAdmin (quitamos el email para que no falle)
                if (!isAdmin) {
                    alert("‚õî Acceso denegado. No tienes permisos de Administrador.");
                    return;
                }

                if(confirm("‚ö†Ô∏è ¬øEST√ÅS REALMENTE SEGURO?\n\nEsta acci√≥n borrar√° los datos permanentemente.")) {
                    
                    // CASO A: RESETEAR M√âTRICAS
                    if (action === 'resetMetrics') {
                        // Como NO importamos 'update', usamos 'remove' 3 veces al mismo tiempo.
                        // Esto funciona con lo que ya tienes arriba.
                        Promise.all([
                            remove(ref(db, 'siteStats')),
                            remove(ref(db, 'jobStats')),
                            remove(ref(db, 'clickLogs'))
                        ]).then(() => {
                            window.showToast("‚úÖ M√©tricas reseteadas a 0");
                            // Ponemos visualmente en cero
                            if(document.getElementById('totalVisits')) document.getElementById('totalVisits').innerText = "0";
                            if(document.getElementById('monthlyVisits')) document.getElementById('monthlyVisits').innerText = "0";
                        }).catch(error => {
                            console.error(error);
                            alert("‚ùå Error al borrar: " + error.message);
                        });
                    }

                    // CASO B: BORRAR VACANTES
                    if (action === 'deleteJobs') {
                        remove(ref(db, 'jobs'))
                            .then(() => {
                                window.showToast("üî• Todas las vacantes eliminadas");
                                jobs = {};
                                renderJobs();
                            })
                            .catch(error => {
                                alert("‚ùå Error: " + error.message);
                            });
                    }
                }
            }

            window.showToast = function(message) {
                const x = document.getElementById("toast");
                if(x) {
                    x.textContent = message;
                    x.className = "show";
                    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
                }
            }

            function deleteAllJobs() {
                remove(ref(db, 'jobs')).then(() => {
                    window.showToast("üî• Todas las vacantes eliminadas");
                });
            }

            window.toggleMobileFilters = function() {
                const container = document.getElementById('filterContainer');
                container.classList.toggle('active');
            }

            window.toggleAdminLogin = function() { 
                const f = document.getElementById('adminForm'); 
                f.style.display = (f.style.display==='none'||f.style.display==='') ? 'block' : 'none'; 
            }
            
            // --- FUNCI√ìN DEL OJITO (VERSI√ìN IM√ÅGENES PNG) ---
            window.togglePasswordVisibility = function() {
                const input = document.getElementById('adminPassword');
                const imagen = document.getElementById('ojoIcono'); // Buscamos la imagen

                if (input.type === "password") {
                    input.type = "text"; // Muestra la contrase√±a
                    imagen.src = "ocultar.png"; // Cambia a la foto del ojo tachado
                } else {
                    input.type = "password"; // Oculta la contrase√±a
                    imagen.src = "ver.png"; // Cambia a la foto del ojo normal
                }
            }

            window.login = async function() {
                const emailField = document.getElementById('adminEmail');
                const passField = document.getElementById('adminPassword');
                const btn = document.getElementById('btnLogin');
                
                let inputVal = emailField.value.trim();
                const passVal = passField.value.trim();

                if (!inputVal || !passVal) return alert("Por favor llena todos los campos");

                // Evitamos doble clic
                if (btn.innerText.includes('Verificando')) return; 

                const originalText = btn.innerHTML;
                btn.innerHTML = "üîÑ Verificando...";
                btn.disabled = true;

                try {
                    // --- CAMINO 1: LOGIN ADMIN (Correo) ---
                    if (inputVal.includes('@')) {
                        await setPersistence(auth, browserSessionPersistence); 
                        await signInWithEmailAndPassword(auth, inputVal, passVal); 
                        sessionStorage.removeItem('isGuest'); 
                        localStorage.setItem('iamsuperadmin', 'true'); 
                        isRecruiterMode = false;
                        return; // Firebase se encarga del resto
                    } 

                    // --- CAMINO 2: LOGIN RECLUTADOR (C√≥digo) ---
                    
                    // 1. Sem√°foro: ¬øYa bajaron los datos?
                    if (!recruitersLoaded) {
                        throw new Error("‚è≥ Los datos siguen cargando. Espera 5 segundos e intenta de nuevo.");
                    }

                    inputVal = inputVal.replace(/\s/g, '').toUpperCase(); // Limpiar espacios

                    if (passVal !== 'Express*2026') {
                        throw new Error("‚ùå Contrase√±a incorrecta.");
                    }

                    const foundRec = Object.values(recruiters).find(r => r.code === inputVal);
                    
                    if (foundRec) {
                        sessionStorage.removeItem('isGuest');
                        // Guardamos sesi√≥n para sobrevivir al cierre de navegador
                        sessionStorage.setItem('recruiterCode', foundRec.code.toLowerCase());
                        sessionStorage.setItem('isRecruiterSession', 'true'); 
                        
                        // √âXITO: Recarga limpia
                        window.location.reload(); 
                    } else {
                        throw new Error(`‚ùå El c√≥digo '${inputVal}' no existe.`);
                    }

                } catch (error) {
                    // SI ALGO FALLA, DESBLOQUEAMOS EL BOT√ìN
                    console.error(error);
                    btn.innerHTML = originalText; 
                    btn.disabled = false;
                    
                    // Si el error es de carga, forzamos la carga de nuevo
                    if (error.message.includes('datos siguen cargando')) {
                        initRecruitersData(); 
                    }
                    
                    alert(error.message);
                }
            }
            
            window.enterAsGuest = function() { 
                sessionStorage.setItem('isGuest', 'true'); 
                isAdmin = false; 
                isRecruiterMode = false;
                // Limpiamos la b√∫squeda pero NO el c√≥digo de reclutador si es que existe
                document.getElementById('searchInput').value = '';
                // Ejecutamos la funci√≥n que acabamos de crear para que el bot√≥n se porte bien
                actualizarBotonLogin(); 
                setAdminMode(false); 
            }

        // FUNCI√ìN SALIR INTELIGENTE (V25.0 - SOLO PRESERVA REF SI ESTABA EN LA URL ORIGINAL)
        window.logout = function() {
            if (!confirm("¬øSalir de la aplicaci√≥n?")) return;

            // 1. SOLO tomamos el ?ref= que realmente tra√≠a la URL al entrar
            //    (Admin y Reclutador entran sin ?ref= ‚Üí siempre salen al link limpio)
            const urlParams = new URLSearchParams(window.location.search);
            const savedRef = urlParams.get('ref');

            // 2. Feedback visual
            document.body.style.opacity = "0.5";
            document.body.style.pointerEvents = "none";

            // 3. LIMPIEZA TOTAL
            localStorage.removeItem('iamsuperadmin');
            localStorage.removeItem('isGuest');
            localStorage.clear();
            sessionStorage.clear();

            // 4. DESTINO
            let targetUrl = window.location.origin;
            if (savedRef) {
                targetUrl += `/?ref=${savedRef}`;
            }

            // 5. SALIDA SEGURA
            try {
             if (typeof auth !== 'undefined' && auth && auth.currentUser) {
                    signOut(auth)
                        .then(() => { window.location.href = targetUrl; })
                        .catch(() => { window.location.href = targetUrl; });
                } else {
                    window.location.href = targetUrl;
                }
            } catch (e) {
                console.error("Forzando salida:", e);
                window.location.href = targetUrl;
            }
        };

            function showLogin() { 
                document.getElementById('loginScreen').style.display = 'block'; 
                document.getElementById('mainApp').style.display = 'none'; 
                document.getElementById('adminForm').style.display = 'none'; 
                
                // --- CORRECCI√ìN: Reseteamos el bot√≥n por si se qued√≥ trabado ---
                const btn = document.getElementById('btnLogin');
                if(btn) { 
                    btn.innerHTML = 'Entrar al Panel'; 
                    btn.disabled = false; 
                }
            }
            function setAdminMode(enableAdmin) {
                document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block';
                
                const isRefMode = !!refCode;
                
                // Limpieza de clases (Reset)
                document.body.classList.remove('admin-mode', 'recruiter-view');

                if (enableAdmin && (!isRefMode || isRecruiterMode)) {
                    
                    document.body.classList.add('admin-mode');

                    if (isRecruiterMode) {
                        // ACTIVAMOS LA VISTA RECLUTADOR
                        document.body.classList.add('recruiter-view');
                        
                        // --- VERSI√ìN SEGURA A PRUEBA DE FALLOS ---
                        // Usamos concatenaci√≥n simple (+) para evitar errores de sintaxis
                        var link = window.location.origin + "/?ref=" + (refCode || '');
                        
                        // Creamos el bot√≥n con HTML simple
                        var botonHtml = '<button class="copy-link-btn" onclick="copyRecruiterLink(\'' + link + '\')" title="Copiar mi link">üîó Copiar Link</button>';
                        
                        // Inyectamos el bot√≥n en el encabezado
                        var indicator = document.getElementById('modeIndicator');
                        if (indicator) {
                            indicator.innerHTML = botonHtml;
                        }
                        
                        // Ocultamos el bot√≥n de cambiar vista
                        var toggleBtn = document.getElementById('viewToggleBtn');
                        if (toggleBtn) {
                            toggleBtn.style.display = 'none';
                        }
                    
                    } else {
                        document.getElementById('modeIndicator').innerHTML = '<span class="admin-mode-indicator">Super Admin</span>';
                        document.getElementById('viewToggleBtn').style.display = 'inline-flex'; 
                    }
                    document.getElementById('adminControls').style.display = 'block';
                } else {
                    document.getElementById('modeIndicator').innerHTML = '';
                    document.getElementById('adminControls').style.display = 'none';
                    document.getElementById('viewToggleBtn').style.display = 'none';
                }
                loadData();
            }

            window.toggleViewMode = function(forceMode) {
                if (forceMode) {
                    currentViewMode = forceMode;
                } else {
                    currentViewMode = currentViewMode === 'grid' ? 'table' : 'grid';
                }

                const grid = document.getElementById('jobGrid');
                const table = document.getElementById('jobTableContainer');
                const btn = document.getElementById('viewToggleBtn');
                
                // --- CAMBIO IMPORTANTE: YA NO TOCAMOS LA BARRA DE B√öSQUEDA AQU√ç ---
                // const searchBar = document.getElementById('userStickyTools'); 

                if (currentViewMode === 'table') {
                    // MODO GESTI√ìN (Tabla)
                    grid.style.display = 'none';
                    table.style.display = 'block';
                    
                    // searchBar.style.display = 'none';  <--- ESTA L√çNEA LA BORRAMOS O COMENTAMOS
                    
                    if(btn) btn.innerHTML = 'üñºÔ∏è Vista Usuario'; // Icono de imagen para volver a las fichas
                    renderJobsTable();
                } else {
                    // MODO USUARIO (Fichas)
                    grid.style.display = 'grid';
                    table.style.display = 'none';
                    
                    // searchBar.style.display = 'block'; <--- ESTA TAMBI√âN LA BORRAMOS O COMENTAMOS

                    if(btn) btn.innerHTML = 'üëÅÔ∏è Vista Gesti√≥n'; // Ojo para ir a tabla
                    filterJobs(); 
                }
            }

            function parseJobDate(dateString) {
                if (!dateString) return 0;
                let jobDate;
                if (dateString.includes('/')) { 
                    const parts = dateString.split('/');
                    if (parts.length === 3) jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (dateString.includes('-')) { 
                    const parts = dateString.split('-');
                    if (parts.length === 3) jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }
                return jobDate && !isNaN(jobDate.getTime()) ? jobDate.getTime() : 0;
            }

            // 1. FUNCI√ìN GLOBAL: Carga reclutadores INDEPENDIENTEMENTE del login
            function initRecruitersData() {
                console.log("Iniciando carga de reclutadores...");
                onValue(ref(db, 'recruiters'), (s) => { 
                    recruiters = s.val() || {}; 
                    recruitersLoaded = true; // ¬°SEM√ÅFORO EN VERDE!
                    console.log("‚úÖ Reclutadores cargados");

                    // AUTO-LOGIN: Si recargaste el celular, aqu√≠ te recuperamos
                    // IMPORTANTE: Esto corre AUTOM√ÅTICAMENTE al abrir la p√°gina
                    if(sessionStorage.getItem('isRecruiterSession') === 'true' && !isAdmin) {
                        const savedCode = sessionStorage.getItem('recruiterCode');
                        if (savedCode) {
                            const foundRec = Object.values(recruiters).find(r => r.code.toLowerCase() === savedCode);
                            if(foundRec) {
                                isAdmin = true; 
                                isRecruiterMode = true; 
                                activeRecruiter = foundRec;
                                setAdminMode(true);
                                if(typeof toggleViewMode === 'function') toggleViewMode('table'); 
                                window.showToast(`üëã Sesi√≥n restaurada: ${foundRec.name}`);
                            }
                        }
                    }
                    
                    checkActiveRecruiter(); 
                    if(isAdmin) renderRecruitersTable(); 
                });
            }

            // ¬°EJECUTAR YA! (Esta l√≠nea es vital)
            initRecruitersData();

            // Ejecutamos esto INMEDIATAMENTE al arrancar
            initRecruitersData();


        // FUNCI√ìN CARGA DE DATOS (OPTIMIZADA V23.1 + FIX SCROLL) ‚ö°
        function loadData() {
            // 1. PRIORIDAD TOTAL: Cargar Vacantes primero
            onValue(ref(db, 'jobs'), (s) => { 
                jobs = s.val() || {}; 
                
                // Matamos el esqueleto de carga DE INMEDIATO
                const skel = document.getElementById('skeletonLoader');
                if(skel) skel.style.display = 'none'; 
                
                // üëáüëáüëá AQU√ç VA LA MAGIA (L√≠nea Nueva) üëáüëáüëá
                window.scrollTo(0, 0);
                // üëÜüëÜüëÜ ESTO HACE QUE EL CELULAR SUBA AL INICIO

                if (isRecruiterMode) {
                    toggleViewMode('table');
                } else {
                    document.getElementById('jobGrid').style.display = 'grid';
                    document.getElementById('jobTableContainer').style.display = 'none';
                }

                populateFilters(jobs); 
                if (currentViewMode === 'grid') renderJobs(); 
                else renderJobsTable();
                
                checkUrlForJob(); // Revisar si hay ?id=...
            });

            // ... (el resto de la funci√≥n loadData que sigue abajo con los setTimeout se queda igual) ...

                // 2. SEGUNDO PLANO: Cargar estad√≠sticas y configuraci√≥n (Sin bloquear la pantalla)
                // Esto corre "por detr√°s" mientras el usuario ya est√° viendo vacantes
                setTimeout(() => {
                    onValue(ref(db, 'jobStats'), (s) => { jobStats = s.val() || {}; });
                    onValue(ref(db, 'clickLogs'), (s) => { clickLogs = s.val() || {}; });
                    
                    onValue(ref(db, 'settings/centralPhone'), (s) => { 
                        centralPhone = s.val() || '';
                        if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone;
                        updateBanner();
                    });
                }, 500); // Peque√±o retraso intencional para liberar la red
            }
            
            // Funci√≥n auxiliar para limpiar el loadData principal
            function checkUrlForJob() {
                const urlJobId = urlParams.get('id');
                if (urlJobId && jobs[urlJobId]) {
                    const job = jobs[urlJobId];
                    if (job.status !== 'No Vigente' || isAdmin) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        if(!isAdmin) sessionStorage.setItem('isGuest', 'true');
                        window.openViewModal(urlJobId);
                    }
                }
            }

            function populateFilters(jobsData) {
                const allJobsArr = Object.values(jobsData);
                const stateSelect = document.getElementById('stateFilter');

                const uniqueStates = [...new Set(allJobsArr.map(j => j.state).filter(Boolean))].sort();
                
                const currState = stateSelect.value;

                let stateHtml = '<option value="">üìç Estado</option>';
                uniqueStates.forEach(s => {
                    stateHtml += `<option value="${s}">${s}</option>`;
                });
                stateSelect.innerHTML = stateHtml;
                stateSelect.value = currState;

                updateCityOptions();
            }

            window.updateCityOptions = function() {
                const stateSelect = document.getElementById('stateFilter');
                const citySelect = document.getElementById('cityFilter');
                const selectedState = stateSelect.value;

                const allJobsArr = Object.values(jobs);

                let availableCities = new Set();
                allJobsArr.forEach(j => {
                    if (!selectedState || j.state === selectedState) {
                        if (j.city) availableCities.add(j.city);
                    }
                });

                const sortedCities = [...availableCities].sort();

                citySelect.innerHTML = '<option value="">üèôÔ∏è Municipio</option>';
                sortedCities.forEach(c => {
                    citySelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
                
                citySelect.value = "";
            }

            window.handleStateChange = function() {
                updateCityOptions(); 
                filterJobs();        
            }

            function checkActiveRecruiter() {
                // CORRECCI√ìN V25.10: Usar localStorage (Persistente)
                const savedCode = localStorage.getItem('recruiterCode');
                
                activeRecruiter = null; 
                if (savedCode && recruiters) {
                    const foundKey = Object.keys(recruiters).find(key => 
                        recruiters[key].code.toLowerCase() === savedCode.toLowerCase()
                    );
                    if (foundKey) { 
                        activeRecruiter = recruiters[foundKey]; 
                    }
                }
                updateBanner();
            }

            function updateBanner() {
                const bannerName = document.getElementById('recruiterNameDisplay');
                if(activeRecruiter) {
                    bannerName.textContent = activeRecruiter.name;
                } else {
                    bannerName.textContent = "Oficina Central";
                }
            }

            window.contactCentralOffice = function() {
                let phoneToContact = '';
                if(activeRecruiter) {
                    phoneToContact = activeRecruiter.phone;
                } else {
                    phoneToContact = centralPhone;
                }

                if(phoneToContact) {
                    const cleanPhone = phoneToContact.replace(/\D/g, '');
                    window.open(`https://wa.me/${cleanPhone}?text=Hola,%20necesito%20ayuda%20general`, '_blank');
                } else {
                    alert("No hay un n√∫mero de contacto general configurado.");
                }
            }

            window.saveCentralConfig = function() {
                const val = document.getElementById('settingsPhoneInput').value.trim();
                const btn = document.getElementById('btnSaveCentral');
                const originalText = btn.textContent;
                
                btn.textContent = "Guardando...";
                set(ref(db, 'settings/centralPhone'), val)
                    .then(() => {
                        window.showToast('‚úÖ Tel√©fono de Oficina Central actualizado.');
                        btn.style.backgroundColor = '#2ecc71'; 
                        btn.textContent = '‚úÖ ¬°Guardado!';
                        setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                    })
                    .catch((error) => {
                        window.showToast('‚ùå Error al guardar: ' + error.message);
                        btn.style.backgroundColor = '#e74c3c'; btn.textContent = 'Error';
                        setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                    });
            }

            window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

            window.editRecruiter = function(id) {
                const r = recruiters[id]; if(!r) return;
                document.getElementById('recName').value = r.name; 
                
                let phoneVal = r.phone;
                if(phoneVal.startsWith('+52')) { document.getElementById('recPhoneCode').value = '+52'; phoneVal = phoneVal.replace('+52',''); }
                else if(phoneVal.startsWith('+1')) { document.getElementById('recPhoneCode').value = '+1'; phoneVal = phoneVal.replace('+1',''); }
                document.getElementById('recPhone').value = phoneVal; 

                document.getElementById('recCode').value = r.code;
                editingRecruiterId = id; const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Guardar Cambios"; btn.style.backgroundColor = "#f57c00"; 
                document.getElementById('btnCancelRecruiter').style.display = 'block';
            }

            window.resetRecruiterForm = function() {
                document.getElementById('recName').value = ''; document.getElementById('recPhone').value = ''; document.getElementById('recCode').value = ''; editingRecruiterId = null;
                const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Agregar"; btn.style.backgroundColor = "#0a66c2"; 
                document.getElementById('btnCancelRecruiter').style.display = 'none';
            }

            window.deleteRecruiter = function(id) { if(confirm('¬øSeguro que quieres eliminar a este reclutador?')) { remove(ref(db, 'recruiters/' + id)); if(editingRecruiterId === id) resetRecruiterForm(); } }
            
            window.copyLink = function(code) { 
                const link = `${window.location.origin}/?ref=${code}`; 
                navigator.clipboard.writeText(link).then(() => window.showToast('Link copiado')); 
            }

            window.copyJobLink = function(jobId) {
                // Revisamos qui√©n es el reclutador due√±o de esta sesi√≥n
                const savedRef = activeRecruiter ? activeRecruiter.code : localStorage.getItem('recruiterCode');
                // Armamos la URL pegando el ID de la vacante y el c√≥digo de referido si existe
                const urlParaCompartir = `${window.location.origin}/?id=${jobId}${savedRef ? '&ref=' + savedRef.toLowerCase() : ''}`;
                // Lo mandamos al portapapeles
                navigator.clipboard.writeText(urlParaCompartir).then(() => {
                    window.showToast('üîó Link con referido copiado al portapapeles');
                }).catch(err => {
                    console.error("Error al copiar:", err);
                });
            }
            
            function renderRecruitersTable() {
                const list = document.getElementById('recruitersList');
                if(Object.keys(recruiters).length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay reclutadores</td></tr>'; return; }
                list.innerHTML = Object.keys(recruiters).map(key => { 
                    const r = recruiters[key]; 
                    return `<tr><td>${r.name}</td><td><b>${r.code}</b></td><td><button class="copy-btn" onclick="copyLink('${r.code}')">Copiar</button></td><td><button onclick="editRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">‚úèÔ∏è</button><button onclick="deleteRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">üóëÔ∏è</button></td></tr>`; 
                }).join('');
            }

            function populateMetricsList() {
                const list = document.getElementById('metricsMonthList');
                if(!jobStats) { list.innerHTML = 'No hay datos'; return; }
                
                const months = new Set();
                Object.values(clickLogs).forEach(log => {
                    if(log && log.timestamp && typeof log.timestamp === 'string') {
                        try { months.add(log.timestamp.substring(0, 7)); } catch(e){}
                    }
                });
                Object.values(jobStats).forEach(stat => {
                    if(stat && stat.monthlyViews) {
                        Object.keys(stat.monthlyViews).forEach(m => months.add(m));
                    }
                });

                if(months.size === 0) months.add(currentMonthKey);

                const sortedMonths = Array.from(months).sort().reverse();
                
                list.innerHTML = sortedMonths.map(m => 
                    `<label style="display:block; padding:5px; border-bottom:1px solid #eee;">
                        <input type="checkbox" value="${m}" checked> ${m}
                    </label>`
                ).join('');
            }

            window.downloadSelectedMetrics = function() {
                const checkboxes = document.querySelectorAll('#metricsMonthList input:checked');
                const selectedMonths = Array.from(checkboxes).map(cb => cb.value);
                
                if(selectedMonths.length === 0) return alert("Selecciona al menos un mes");

                window.showToast("üìä Generando reporte detallado...");

                const dataRows = [];
                
                Object.keys(jobs).forEach(jobId => {
                    const j = jobs[jobId];
                    const s = jobStats[jobId] || {};
                    
                    let totalViews = 0;
                    let totalClicks = 0;

                    selectedMonths.forEach(m => {
                        if(s.monthlyViews && s.monthlyViews[m]) {
                            totalViews += s.monthlyViews[m];
                        }
                    });
                    
                    const clicksInMonths = Object.values(clickLogs).filter(l => 
                        l && l.jobId === jobId && 
                        l.timestamp && typeof l.timestamp === 'string' &&
                        selectedMonths.includes(l.timestamp.substring(0,7))
                    ).length;

                    dataRows.push({
                        'ID': jobId,
                        'T√≠tulo': j.title,
                        'Empresa': j.company,
                        'Vistas (Meses selecc.)': totalViews,
                        'Clics WhatsApp (Meses selecc.)': clicksInMonths,
                        'Estatus': j.status
                    });
                });

                const recruiterMap = {};
                let totalRecruiterClicks = 0;
                Object.values(clickLogs).forEach(l => {
                    if(l && l.timestamp && typeof l.timestamp === 'string' && selectedMonths.includes(l.timestamp.substring(0,7))) {
                        const recName = l.recruiter || 'Org√°nico';
                        if(!recruiterMap[recName]) recruiterMap[recName] = 0;
                        recruiterMap[recName]++;
                        totalRecruiterClicks++;
                    }
                });
                let recruiterRows = Object.keys(recruiterMap).map(name => ({
                    'Reclutador': name,
                    'Clics Generados': recruiterMap[name],
                    '% del Total': totalRecruiterClicks > 0 ? ((recruiterMap[name] / totalRecruiterClicks) * 100).toFixed(2) + '%' : '0%'
                }));
                if (recruiterRows.length === 0) recruiterRows = [{'Reclutador': 'Sin datos', 'Clics': 0}];

               const detailMap = {}; 

                // 1. LOGICA DE VISTAS (Aqu√≠ faltaba guardar los datos nuevos)
                Object.keys(jobs).forEach(jobId => {
                    const j = jobs[jobId];
                    const s = jobStats[jobId] || {};
                    
                    if (s.viewsByRecruiter) {
                        Object.keys(s.viewsByRecruiter).forEach(recCode => {
                            let recName = 'Org√°nico';
                            if (recCode !== 'ORGANICO') {
                                const foundRec = Object.values(recruiters).find(r => r.code === recCode);
                                recName = foundRec ? foundRec.name : recCode;
                            }

                            const key = `${jobId}_${recName}`;
                            
                            // CORRECCI√ìN AQU√ç: Agregamos company y whatsapp
                            if (!detailMap[key]) detailMap[key] = { 
                                jobId: jobId, 
                                title: j.title, 
                                company: j.company || 'Sin Empresa', // <--- AGREGADO
                                whatsapp: j.whatsapp || 'Sin Num',   // <--- AGREGADO
                                recruiter: recName, 
                                views: 0, 
                                clicks: 0 
                            };
                            
                            detailMap[key].views = s.viewsByRecruiter[recCode];
                        });
                    }
                });

                // 2. LOGICA DE CLICS (Aqu√≠ tambi√©n faltaba)
                Object.values(clickLogs).forEach(l => {
                    if(l && l.jobId && l.timestamp && typeof l.timestamp === 'string' && selectedMonths.includes(l.timestamp.substring(0,7))) {
                        const j = jobs[l.jobId];
                        const jobTitle = j ? j.title : 'Vacante Borrada';
                        const jobCompany = j ? j.company : 'N/A'; // <--- RECUPERAMOS
                        const jobWa = j ? j.whatsapp : 'N/A';     // <--- RECUPERAMOS
                        const recName = l.recruiter || 'Org√°nico';
                        
                        const key = `${l.jobId}_${recName}`;
                        
                        // CORRECCI√ìN AQU√ç: Agregamos company y whatsapp
                        if (!detailMap[key]) detailMap[key] = { 
                            jobId: l.jobId, 
                            title: jobTitle, 
                            company: jobCompany, // <--- AGREGADO
                            whatsapp: jobWa,     // <--- AGREGADO
                            recruiter: recName, 
                            views: 0, 
                            clicks: 0 
                        };
                        
                        detailMap[key].clicks++;
                    }
                });

                // 3. GENERAR EXCEL FINAL
                let detailRows = Object.values(detailMap).map(d => ({
                    'ID Vacante': d.jobId,
                    'Reclutador': d.recruiter,
                    'Empresa': d.company,          // <--- AHORA S√ç YA TIENE DATOS
                    'Vacante': d.title,
                    'Vistas Totales (Hist√≥rico)': d.views, 
                    'Clics (Meses selecc.)': d.clicks,
                    'Conversion %': d.views > 0 ? ((d.clicks / d.views) * 100).toFixed(1) + '%' : '0%',
                    'WhatsApp Destino': d.whatsapp // <--- AHORA S√ç YA TIENE DATOS
                }));

                if (detailRows.length === 0) detailRows = [{'Mensaje': 'A√∫n no hay interacci√≥n detallada registrada'}];

                const wb = XLSX.utils.book_new();
                
                const ws1 = XLSX.utils.json_to_sheet(dataRows);
                XLSX.utils.book_append_sheet(wb, ws1, "Desempe√±o Vacantes");

                const ws2 = XLSX.utils.json_to_sheet(recruiterRows);
                XLSX.utils.book_append_sheet(wb, ws2, "Rendimiento Equipo");

                const summaryRows = [
                    { 'M√©trica': 'Periodo Analizado', 'Valor': selectedMonths.join(', ') },
                    { 'M√©trica': 'Total Vistas', 'Valor': dataRows.reduce((a,b)=>a+b['Vistas (Meses selecc.)'],0) },
                    { 'M√©trica': 'Total Clics (Leads)', 'Valor': dataRows.reduce((a,b)=>a+b['Clics WhatsApp (Meses selecc.)'],0) }
                ];
                const ws3 = XLSX.utils.json_to_sheet(summaryRows);
                XLSX.utils.book_append_sheet(wb, ws3, "Resumen Global");

                const ws4 = XLSX.utils.json_to_sheet(detailRows);
                XLSX.utils.book_append_sheet(wb, ws4, "Detalle Rec-Vacante");

                XLSX.writeFile(wb, `Reporte_TuChamba_${selectedMonths.join('_')}.xlsx`);
            }

            window.handleWhatsAppClick = function(btn, jobId, recruiterName, link) {
                const clickedKey = `clic_${jobId}_${new Date().toISOString().split('T')[0]}`; 
                const alreadyClicked = localStorage.getItem(clickedKey);

                btn.disabled = true;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'üîÑ Abriendo...';

                if (!alreadyClicked) {
                    console.log("‚úÖ Nuevo interesado detectado");
                    localStorage.setItem(clickedKey, 'true');
                    window.registerClick(jobId, recruiterName);
                } else {
                    console.log("‚ö†Ô∏è Clic repetido (Ignorado)");
                }

                setTimeout(() => { window.open(link, '_blank'); }, 300); 
                setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000);
            }

            window.registerClick = function(jobId, recruiterName) {
                runTransaction(ref(db, `jobStats/${jobId}/whatsappClicks`), (c) => (c || 0) + 1);
                push(ref(db, 'clickLogs'), { jobId, recruiter: recruiterName || 'Org√°nico', timestamp: new Date().toISOString(), date_readable: new Date().toLocaleString() });
            }

            // FUNCI√ìN FLYER V24.6 (Depurada)
            window.generateFlyer = function(jobId) {
                const j = jobs[jobId];
                if (!j) return;

                window.showToast("üé® Dise√±ando Flyer...");

                // 1. Datos B√°sicos
                document.getElementById('flyerTitle').innerText = j.title;
                document.getElementById('flyerSalary').innerText = j.salary || 'Sueldo Competitivo';
                
                // 2. L√ìGICA DE UBICACI√ìN (Reforzada)
                let locText = "";
                
                // Intentamos armar "Monterrey, Nuevo Le√≥n"
                if (j.city) {
                    locText = j.city;
                    if (j.state) locText += `, ${j.state}`;
                } 
                // Si falla, usamos el campo libre "location"
                else if (j.location) {
                    locText = j.location;
                } 
                // Si falla todo, ponemos un default
                else {
                    locText = "M√âXICO";
                }

                // INYECTAMOS EL TEXTO EN MAY√öSCULAS
                const locElement = document.getElementById('flyerLocation');
                if(locElement) {
                    locElement.innerText = "üìç " + locText.toUpperCase();
                } else {
                    console.error("‚ùå ERROR: No encontr√© el div 'flyerLocation' en el HTML");
                }

                // 3. Beneficios
                const benefitsList = document.getElementById('flyerBenefitsList');
                benefitsList.innerHTML = '';
                if(j.benefits && j.benefits.length > 0) {
                    j.benefits.slice(0, 4).forEach(ben => {
                        const li = document.createElement('li');
                        li.innerText = '‚úÖ ' + ben;
                        benefitsList.appendChild(li);
                    });
                } else {
                    benefitsList.innerHTML = '<li>‚úÖ Prestaciones de Ley</li><li>‚úÖ Contrataci√≥n Inmediata</li>';
                }

                // 4. QR (FIX FINAL: Siempre incluye &ref= si existe en la URL o storage)
                const qrContainer = document.getElementById('flyerQr');
                qrContainer.innerHTML = ''; 

                // Obtener el ref de forma confiable (igual que en logout)
                const urlParams = new URLSearchParams(window.location.search);
                let refCode = urlParams.get('ref');
                
                // Si no viene en la URL, intentamos fallback a storage (por si acaso)
                if (!refCode) {
                    refCode = sessionStorage.getItem('recruiterCode') || 
                        localStorage.getItem('recruiterCode') || 
                        (activeRecruiter && activeRecruiter.code);
                }

                // Construir la URL completa
                let linkDelQr = `${window.location.origin}/?id=${jobId}`;
                if (refCode) {
                    linkDelQr += `&ref=${refCode.toLowerCase()}`;
                }

                // Generar QR
                new QRCode(qrContainer, {
                    text: linkDelQr,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Opcional: Mostrar la URL en consola para debug (puedes quitar despu√©s)
                console.log("QR generado con URL:", linkDelQr);

                // 5. GENERAR IMAGEN (Con 1 segundo de espera para asegurar renderizado)
                setTimeout(() => {
                    const flyerNode = document.getElementById('flyerTemplate');
                    
                    html2canvas(flyerNode, { 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: false, 
                        backgroundColor: null 
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Flyer_${j.title.replace(/\s+/g, '_')}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        window.showToast("‚úÖ ¬°Flyer listo!");
                    }).catch(err => {
                        console.error(err);
                        alert("Error: " + err.message);
                    });
                }, 1000);
            }

            const visitsRef = ref(db, 'siteStats/visits');
            const monthlyRef = ref(db, `siteStats/monthly/${currentMonthKey}`);
            
            const isMyDevice = localStorage.getItem('iamsuperadmin');
            const alreadyVisited = localStorage.getItem('visited_v2');

            if (!alreadyVisited && !isMyDevice) { 
                runTransaction(visitsRef, (c) => (c || 0) + 1); 
                runTransaction(monthlyRef, (c) => (c || 0) + 1); 
                localStorage.setItem('visited_v2', 'true'); 
            }
            
        onValue(visitsRef, (s) => { 
                const val = s.val() || 0;
                if(document.getElementById('totalVisits')) document.getElementById('totalVisits').innerText = val;
                if(document.getElementById('totalVisitsMobile')) document.getElementById('totalVisitsMobile').innerText = val;
            });
            
            onValue(monthlyRef, (s) => { 
                const val = s.val() || 0;
                if(document.getElementById('monthlyVisits')) document.getElementById('monthlyVisits').innerText = val;
                if(document.getElementById('monthlyVisitsMobile')) document.getElementById('monthlyVisitsMobile').innerText = val;
            });

            window.saveJob = function(e) {
                e.preventDefault();
                
                const phoneCode = document.getElementById('jobPhoneCode').value;
                const rawPhone = document.getElementById('jobContact').value.trim();
                
                let cleanPhone = rawPhone.replace(/\D/g, '');
                const codeDigits = phoneCode.replace('+', '');
                if (cleanPhone.startsWith(codeDigits)) {
                    cleanPhone = cleanPhone.substring(codeDigits.length);
                }
                const finalPhone = cleanPhone ? (phoneCode + cleanPhone) : '';

                const isFeaturedVal = document.getElementById('jobIsFeatured').value === 'true';

                const jobData = {
                    title: document.getElementById('jobTitle').value,
                    company: document.getElementById('jobCompany').value,
                    showCompany: document.getElementById('jobShowCompany').value === 'true', 
                    state: document.getElementById('jobState').value,
                    city: document.getElementById('jobCity').value,
                    zone: document.getElementById('jobZone').value,
                    location: `${document.getElementById('jobCity').value}, ${document.getElementById('jobState').value}`,
                    
                    fecha: document.getElementById('jobDate').value, 
                    
                    salary: document.getElementById('jobSalary').value,
                    description: document.getElementById('jobDescription').value,
                    schedule: document.getElementById('jobSchedule').value, 
                    // BORRADO: tags
                    contact: finalPhone, 
                    status: document.getElementById('jobStatus').value,
                    agency: document.getElementById('jobAgency').value,
                    requirements: tempReqs,
                    benefits: tempBens,
                    isFeatured: isFeaturedVal 
                };
                const id = currentEditId || 'job-' + Date.now();
                set(ref(db, 'jobs/' + id), jobData).then(() => {
                    window.showToast("‚úÖ Vacante guardada");
                    window.closeFormModal();
                });
            }

            window.deleteJob = function(id) { if(confirm('¬øBorrar vacante?')) remove(ref(db, 'jobs/' + id)); }

            function normalizeText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : ""; }

            function formatDateFriendly(dateString) {
                return dateString || '';
            }

            function isNewJob(dateString) {
                if (!dateString) return false;
                let jobDate;
                
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        jobDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } 
                else if (dateString.includes('-')) {
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        jobDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                }

                if (!jobDate || isNaN(jobDate.getTime())) return false;

                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                const diffTime = Math.abs(today - jobDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return diffDays <= 3;
            }

            // --- VARIABLES DE ORDENAMIENTO ---
            let currentSortCol = '';   // Qu√© columna estamos ordenando
            let currentSortAsc = true; // true = A-Z, false = Z-A

            // Funci√≥n para cambiar el orden al dar clic
            window.handleSort = function(colName) {
                if (currentSortCol === colName) {
                    currentSortAsc = !currentSortAsc; // Si es la misma, invierte el orden
                } else {
                    currentSortCol = colName;
                    currentSortAsc = true; // Si es nueva, empieza A-Z
                }
                renderJobsTable(); // Redibuja la tabla
            }

            // --- FUNCI√ìN TABLA (V19.5: FILTRO EXACTO + TODO EL CONTENIDO) ---
            window.renderJobsTable = function() {
                let keys = Object.keys(jobs);
                
                // 1. LLENAR SELECT (Usamos trim para limpiar basura del Excel)
                const companySelect = document.getElementById('headerCompanyFilter');
                if (companySelect && companySelect.options.length <= 1) {
                    // Obtenemos empresas limpias
                    const companies = [...new Set(Object.values(jobs).map(j => j.company.trim()))].sort();
                    companies.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c; 
                        opt.textContent = c;
                        companySelect.appendChild(opt);
                    });
                }

                // 2. APLICAR FILTRO DE EMPRESA
                // Nota: Aqu√≠ NO filtramos por estatus. Mostramos todo lo que coincida con el nombre.
                const selectedCompany = companySelect ? companySelect.value : '';
                if (selectedCompany) {
                    // Comparamos el nombre limpio de la vacante con el seleccionado
                    keys = keys.filter(id => jobs[id].company.trim() === selectedCompany);
                }

                // 3. ACTUALIZAR CONTADOR (Absoluto)
                updateUniversalCounter(); 

                // 4. ORDENAMIENTO (Sin cambios)
                if (currentSortCol && currentSortCol !== 'company') {
                    keys.sort((a, b) => {
                        let valA = '', valB = '';
                        const jA = jobs[a]; const jB = jobs[b];
                        switch(currentSortCol) {
                            case 'title': valA = jA.title; valB = jB.title; break;
                            case 'status': valA = jA.status; valB = jB.status; break;
                            case 'location': valA = jA.city + jA.state; valB = jB.city + jB.state; break;
                            case 'salary': valA = jA.salary; valB = jB.salary; break;
                            default: return 0;
                        }
                        valA = valA ? valA.toString().toLowerCase() : "";
                        valB = valB ? valB.toString().toLowerCase() : "";
                        if (valA < valB) return currentSortAsc ? -1 : 1;
                        if (valA > valB) return currentSortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    keys.sort((a,b) => b.localeCompare(a));
                }

                // 5. DIBUJAR TABLA
                const tableBody = document.getElementById('jobTableBody');
                tableBody.innerHTML = keys.map((id, index) => {
                    const j = jobs[id];
                    const loc = `${j.city}, ${j.state}`;
                    
                    const statusBadge = j.status === 'No Vigente' 
                        ? '<span style="background:#ffebee; color:#c62828; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:11px;">üî¥ No Vigente</span>' 
                        : '<span style="background:#e8f5e9; color:#2e7d32; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:11px;">üü¢ Vigente</span>';

                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td style="font-weight:bold; color:#0a66c2;">${j.company}</td>
                            <td>${j.title}</td>
                            <td>${loc}</td>
                            <td style="color:#d32f2f; font-weight:bold;">${j.salary || 'N/A'}</td>
                            <td style="text-align:center;">${statusBadge}</td>
                            <td>
                                <div class="actions-flex">
                                    <button class="action-icon-btn" title="Flyer" onclick="window.generateFlyer('${id}')">üñºÔ∏è</button>
                                    <button class="action-icon-btn" title="Link" onclick="window.copyJobLink('${id}')">üîó</button>
                                    ${isAdmin && !isRecruiterMode ? `<button class="action-icon-btn" title="Editar" onclick="window.editJob('${id}')">‚úèÔ∏è</button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            
            // --- FUNCI√ìN CONTADOR INTELIGENTE (OBSERVACI√ìN 1) ---
            function updateUniversalCounter() { 
                const counterDiv = document.getElementById('universalCounter');
                if(!counterDiv) return;
                
                const allJobs = Object.values(jobs); 
                const total = allJobs.length;

                // Si no hay vacantes, ocultamos
                if (total === 0) { 
                    counterDiv.style.display = 'none'; 
                    return; 
                } else {
                    counterDiv.style.display = 'flex';
                }

                const vigentes = allJobs.filter(j => j.status !== 'No Vigente').length;
                const noVigentes = total - vigentes;

                // --- AQU√ç EST√Å EL CAMBIO DE L√ìGICA ---
                if (!isAdmin && !isRecruiterMode) {
                    // MODO USUARIO: Solo mostramos lo positivo
                    counterDiv.innerHTML = `
                        <span class="counter-tag tag-active" style="font-size: 15px;">üöÄ ${vigentes} Vacantes Disponibles</span>
                    `;
                } else {
                    // MODO ADMIN/RECLUTADOR: Mostramos el reporte completo
                    counterDiv.innerHTML = `
                        <span class="counter-tag tag-total">Total: ${total}</span>
                        <span class="counter-tag tag-active">üü¢ ${vigentes} Vigentes</span>
                        <span class="counter-tag tag-inactive">üî¥ ${noVigentes} No Vigentes</span>
                    `;
                }
            }

            function renderJobs() {
                let keys = Object.keys(jobs);
                
                keys.sort((a, b) => {
                    const jobA = jobs[a]; const jobB = jobs[b];
                    const statusA = jobA.status === 'No Vigente' ? 1 : 0;
                    const statusB = jobB.status === 'No Vigente' ? 1 : 0;
                    if (statusA !== statusB) return statusA - statusB;
                    
                    const featA = jobA.isFeatured ? 1 : 0;
                    const featB = jobB.isFeatured ? 1 : 0;
                    if (featA !== featB) return featB - featA; 

                    const dateA = parseJobDate(jobA.fecha);
                    const dateB = parseJobDate(jobB.fecha);
                    
                    if (dateA !== dateB) {
                        return dateB - dateA; 
                    }
                    return b.localeCompare(a); 
                });

                currentFilteredJobs = keys; 
                currentPage = 1; 
                applyFilterAndRender();
            }

            window.clearSearch = function() {
                document.getElementById('searchInput').value = '';
                filterJobs();
                document.getElementById('searchInput').focus();
            }

            function applyFilterAndRender() {
                if (currentViewMode === 'table') return;

                const stateVal = document.getElementById('stateFilter').value;
                const cityVal = document.getElementById('cityFilter').value;
                const searchInput = document.getElementById('searchInput');
                const searchText = normalizeText(searchInput.value);

                const clearBtn = document.getElementById('clearSearchBtn');
                clearBtn.style.display = searchText.length > 0 ? 'flex' : 'none';

                const matchedKeys = currentFilteredJobs.filter(id => {
                    const j = jobs[id];
                    if (!isAdmin && j.status === 'No Vigente') return false;

                    const matchState = stateVal === '' || j.state === stateVal;
                    const matchCity = cityVal === '' || j.city === cityVal;

                    let matchSearch = true;
                    if(searchText) {
                        const fullText = normalizeText(`${j.title} ${j.company} ${j.description}`);
                        matchSearch = fullText.includes(searchText);
                    }

                    return matchState && matchCity && matchSearch;
                });

                updateUniversalCounter();

                if (matchedKeys.length === 0) {
                    document.getElementById('jobGrid').innerHTML = '';
                    document.getElementById('paginationContainer').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }
                document.getElementById('emptyState').style.display = 'none';

                const totalPages = Math.ceil(matchedKeys.length / itemsPerPage);
                if(currentPage > totalPages) currentPage = 1;

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const visibleKeys = matchedKeys.slice(startIndex, endIndex);

                const grid = document.getElementById('jobGrid');
                grid.innerHTML = visibleKeys.map(id => {
                    const j = jobs[id];
                    
                    const isVigente = j.status !== 'No Vigente';
                    let statusBadge = '<span class="badge-closed">Cerrada</span>';
                    if(isVigente) statusBadge = '<span class="badge-vigente">üü¢ Vigente</span>';

                    const showAdminButtons = isAdmin && !refCode;
                    const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
                    const finalCompanyName = (isAdmin && !refCode) || showNamePublicly ? j.company : "Empresa Confidencial";
                    const verifiedHtml = showNamePublicly ? '<span class="verified-badge" title="Empresa Verificada">‚úì</span>' : '';

                    let displayLocation = j.location;
                    if (j.city && j.state) displayLocation = `${j.city}, ${j.state}`;

                    const niceDate = formatDateFriendly(j.fecha);
                    const dateHtml = niceDate ? `<span class="card-header-date">üìÖ Publicaci√≥n: ${niceDate}</span>` : '';
                    const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">üî• Nueva</span>' : '';
                    const featuredBadge = j.isFeatured ? '<div class="badge-featured">‚≠ê DESTACADA</div>' : '';

                    return `
                        <div class="job-card" onclick="window.openViewModal('${id}')">
                            ${featuredBadge}
                            ${showAdminButtons ? `<button class="more-btn" onclick="event.stopPropagation(); window.toggleMenu('${id}')">‚ãÆ</button>
                            <div class="admin-actions" id="menu-${id}">
                                <button class="admin-action" onclick="event.stopPropagation(); window.editJob('${id}')">‚úèÔ∏è Editar</button>
                                <button class="admin-action" onclick="event.stopPropagation(); window.generateFlyer('${id}')">üñºÔ∏è Descargar Flyer</button>
                                <button class="admin-action delete" onclick="event.stopPropagation(); window.deleteJob('${id}')">üóëÔ∏è Eliminar</button>
                            </div>` : ''}
                            
                            <div class="card-header-top">
                                <div>${statusBadge} ${newBadge}</div>
                            </div>
                            ${dateHtml}
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; margin-top: 10px;">
                                <div class="company-logo">${j.company.charAt(0)}</div>
                                <div>
                                    <div class="job-title">${j.title}</div>
                                    <div class="company-name">${finalCompanyName} ${verifiedHtml}</div>
                                </div>
                            </div>
                            
                            <div class="location">üìç ${displayLocation}</div>
                            <div class="salary-text">üí∞ ${j.salary || 'A convenir'}</div>
                        </div>
                    `;
                }).join('');

                renderPaginationControls(totalPages);
            }

            function renderPaginationControls(totalPages) {
                const container = document.getElementById('paginationContainer');
                if (totalPages <= 1) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = 'flex';
                
                let html = '';
                
                html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Anterior</button>`;
                
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        html += `<span style="color:#999;">...</span>`;
                    }
                }

                html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente &raquo;</button>`;
                
                html += `<div class="page-info">P√°gina ${currentPage} de ${totalPages}</div>`;
                
                container.innerHTML = html;
            }

            // Funci√≥n para cambiar p√°gina: T√âCNICA "DESAPARECER EL ANCLA" ‚öìüö´
            window.changePage = function(newPage) {
                // 1. Quitar foco del clic
                if (document.activeElement) document.activeElement.blur();
                
                currentPage = newPage;
                
                if (currentViewMode === 'table') {
                    // Renderizamos los datos nuevos
                    renderJobsTable(); 
                    
                    // --- TRUCO MAESTRO ---
                    // Forzamos que los botones de abajo DESAPAREZCAN un instante.
                    // Al no haber "piso" abajo, el navegador no puede anclarse y subir√° s√≠ o s√≠.
                    const pagContainer = document.getElementById('paginationContainer');
                    if(pagContainer) pagContainer.style.display = 'none';

                    // Ordenamos subir (ahora s√≠ nos obedecer√°)
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                    
                    // Hacemos reaparecer los botones un parpadeo despu√©s
                    setTimeout(() => {
                        if(pagContainer) {
                            // RenderJobsTable calcula si debe ser flex o none, aqu√≠ lo forzamos a flex si hay p√°ginas
                            pagContainer.style.display = 'flex'; 
                        }
                    }, 100);

                } else {
                    // MODO USUARIO (Fichas) - Este ya funcionaba, no le movemos
                    applyFilterAndRender(); 
                    const topHeader = document.querySelector('.header');
                    if(topHeader) {
                        setTimeout(() => {
                            topHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100); 
                    }
                }
            }

        // --- TAREA 12: FILTROS INTELIGENTES ---
            window.filterJobs = function() {
                currentPage = 1; 
                const searchText = normalizeText(document.getElementById('searchInput').value);
                
                // 1. Primero actualizamos los municipios disponibles
                updateSmartFilters(searchText);

                // 2. Luego filtramos visualmente
                applyFilterAndRender();
            }

            function updateSmartFilters(searchText) {
                const stateSelect = document.getElementById('stateFilter');
                const citySelect = document.getElementById('cityFilter');
                const selectedState = stateSelect.value;
                const selectedCity = citySelect.value;

                // Filtramos vacantes considerando si est√°n VIGENTES
                const availableJobs = Object.values(jobs).filter(j => {
                    // REGLA DE ORO: Si no es Admin, ocultamos las NO VIGENTES del filtro
                    if (!isAdmin && j.status === 'No Vigente') return false;
                    
                    if (!searchText) return true;
                    const fullText = normalizeText(`${j.title} ${j.company} ${j.tags} ${j.description}`);
                    return fullText.includes(searchText);
                });

                const availableStates = new Set();
                const availableCities = new Set();

                availableJobs.forEach(j => {
                    if (j.state) availableStates.add(j.state);
                    if (!selectedState || j.state === selectedState) {
                        if (j.city) availableCities.add(j.city);
                    }
                });

                // Reconstruir Estados
                let stateHtml = '<option value="">üìç Estado</option>';
                [...availableStates].sort().forEach(s => {
                    stateHtml += `<option value="${s}" ${s === selectedState ? 'selected' : ''}>${s}</option>`;
                });
                stateSelect.innerHTML = stateHtml;

                // Reconstruir Municipios
                let cityHtml = '<option value="">üèôÔ∏è Municipio</option>';
                [...availableCities].sort().forEach(c => {
                    cityHtml += `<option value="${c}" ${c === selectedCity ? 'selected' : ''}>${c}</option>`;
                });
                citySelect.innerHTML = cityHtml;
            }
            
            // Agregar esto para que al cambiar estado, se refresquen los municipios
            window.handleStateChange = function() { filterJobs(); }

            window.loadMoreJobs = function() {
                displayLimit += 20;
                applyFilterAndRender();
            }

            window.toggleMenu = function(id) { 
                document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active')); 
                document.getElementById(`menu-${id}`).classList.toggle('active'); 
            }

            window.openViewModal = function(id) {
                const j = jobs[id];
                updateJobSEO(j, id);
                const isRefMode = !!refCode;

                if (!isAdmin || isRefMode) {
                    runTransaction(ref(db, `jobStats/${id}/totalViews`), (c) => (c || 0) + 1);
                    runTransaction(ref(db, `jobStats/${id}/monthlyViews/${currentMonthKey}`), (c) => (c || 0) + 1);
                    
                    const recCodeSafe = activeRecruiter ? activeRecruiter.code : 'ORGANICO';
                    runTransaction(ref(db, `jobStats/${id}/viewsByRecruiter/${recCodeSafe}`), (c) => (c || 0) + 1);
                }
                
                document.title = `Trabajo en ${j.city || 'M√©xico'} - ${j.title} | TuChamba`;

                const stats = jobStats[id] || {};
                const totalViews = stats.totalViews || 0;
                const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
                const companyDisplay = (isAdmin && !isRefMode) || showNamePublicly ? j.company : "Empresa Confidencial";
                
                let contactHtml = '';
                let targetPhone = '';
                let isReferral = false;

                let excelContact = j.contact ? j.contact.replace(/\D/g, '') : '';
                let isExcelContactValid = excelContact.length >= 10;

                if (activeRecruiter) { 
                    targetPhone = activeRecruiter.phone; 
                    isReferral = true; 
                } 
                else if (isExcelContactValid) { 
                    targetPhone = excelContact; 
                } 
                else if (centralPhone) { 
                    targetPhone = centralPhone.replace(/\D/g, ''); 
                }

                if (targetPhone) {
                    let msg = `Hola, vi la vacante ${j.title} (C√≥d: ${id})`;
                    if(isReferral) msg += ` (Referido por ${activeRecruiter.name})`;
                    const waLink = `https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`;
                    const recNameSafe = activeRecruiter ? activeRecruiter.name : 'Org√°nico';
                    
                    // CAMBIO V25.7: S√°ndwich Compacto (Sin espacios extra)
                    contactHtml = `<div class="sticky-footer" style="padding: 10px 15px 15px;"> <p style="font-size:11px; color:#666; margin: 0 0 4px 0; font-weight:600;">
                                            üëáüèª Respuesta Inmediata üëáüèª
                                        </p>
                                        
                                        <button onclick="window.handleWhatsAppClick(this, '${id}', '${recNameSafe}', '${waLink}')" class="whatsapp-btn-large" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            <span style="white-space: nowrap;">üìÖ ¬°PIDE INFORMES Y EMPIEZA YA! CLIC</span> 
                                            <img src="favicon_2.png" alt="WA" style="height: 26px; width: auto;"> </button>
                                        
                                        <p style="font-size:11px; color:#666; margin: 4px 0 0 0; font-weight:600;">
                                            üëÜüèª ¬°No pierdas tu oportunidad, post√∫late ahora! üëÜüèª
                                        </p>
                                </div>`;
                }

                let adminInfoHtml = '';
                if (isAdmin && !isRefMode) {
                    adminInfoHtml = `<div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom: 15px;">
                            <div class="view-count-badge">üëÅÔ∏è ${totalViews} Vistas</div>
                            <div class="agency-badge">${j.agency || 'Sin asignar'}</div>
                        </div>`;
                }

                let locationDetail = j.location;
                if (j.state && j.city) locationDetail = `${j.city}, ${j.state} ${j.zone ? '('+j.zone+')' : ''}`;
                
                const isVigente = j.status !== 'No Vigente';
                const badgeHtml = isVigente ? '<span class="badge-vigente">üü¢ Vigente</span>' : '<span class="badge-closed">Cerrada</span>';
                const niceDate = formatDateFriendly(j.fecha);
                const dateHtml = niceDate ? `<span class="card-header-date">üìÖ Publicaci√≥n: ${niceDate}</span>` : '';
                const newBadge = isNewJob(j.fecha) ? '<span class="badge-new">üî• Nueva</span>' : '';

                const shareUrl = `${window.location.origin}/?id=${id}${refCode ? '&ref='+refCode : ''}`;
                
                document.getElementById('viewModalBody').innerHTML = `
                    ${adminInfoHtml}
                    
                    <div style="margin-bottom:10px;">
                        ${badgeHtml} ${newBadge}
                    </div>
                    ${dateHtml}

                    <h2 style="font-size: 26px; margin-top: 15px; margin-bottom: 10px; color:#222; line-height:1.2;">
                        ${j.title}
                    </h2>
                    
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                        <div style="font-size: 18px; color: #0a66c2; font-weight:600;">${companyDisplay}</div>
                        <button class="modal-share-btn" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => window.showToast('üîó Link copiado'))">üîó Compartir</button>
                    </div>

                    <div class="job-details" style="background:#f8f9fa; padding:15px; border-radius:12px;">
                        <div class="detail-item">
                            <div style="font-weight:bold; color:#555;">üìç Zona:</div>
                            <div>${locationDetail}</div>
                        </div>
                        <div class="detail-item">
                            <div style="font-weight:bold; color:#d32f2f;">üí∞ Sueldo:</div>
                            <div class="salary-text" style="margin-top:0;">${j.salary || 'A convenir'}</div>
                        </div>
                        <div class="detail-item">
                            <div style="font-weight:bold; color:#555;">üïí Jornada:</div>
                            <div>${j.schedule || 'Horario a definir'}</div>
                        </div>
                    </div>

                    <div class="section-title">Descripci√≥n del Puesto</div>
                    <p style="color: #444; line-height: 1.45; font-size:15px; margin-bottom:20px;">${j.description}</p>
                    
                    ${(j.requirements||[]).length ? `<div class="section-title">Requisitos</div><ul class="item-list">${j.requirements.map(r=>`<li>${r}</li>`).join('')}</ul>` : ''}
                    
                    ${(j.benefits||[]).length ? `<div class="section-title">Ofrecemos</div><ul class="item-list">${j.benefits.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
                    
                    ${contactHtml}
                `;
                document.getElementById('viewModal').classList.add('active');
            }


            window.closeViewModal = function() { 
                document.title = "TuChamba Express | Vacantes Urgentes en Nuevo Le√≥n, CDMX y EdoMex 2026";
                document.getElementById('viewModal').classList.remove('active'); 
            }
            window.closeFormModal = function() { document.getElementById('formModal').classList.remove('active'); }
            window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }
            
            window.openJobForm = function() {
                currentEditId = null; document.getElementById('formTitle').textContent = 'Nueva Vacante'; document.getElementById('jobForm').reset();
                const todayISO = new Date().toISOString().split('T')[0];
                document.getElementById('jobDate').value = todayISO; 
                
                tempReqs = []; tempBens = []; updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
                document.getElementById('jobShowCompany').value = 'true';
                document.getElementById('formModal').classList.add('active');
            }

            window.editJob = function(id) {
                currentEditId = id; const j = jobs[id];
                document.getElementById('formTitle').textContent = 'Editar Vacante';
                document.getElementById('jobTitle').value = j.title; document.getElementById('jobCompany').value = j.company;
                document.getElementById('jobShowCompany').value = (j.showCompany === false || j.showCompany === 'false') ? 'false' : 'true';
                document.getElementById('jobState').value = j.state || '';
                document.getElementById('jobCity').value = j.city || '';
                document.getElementById('jobZone').value = j.zone || '';
                
                document.getElementById('jobDate').value = j.fecha || ''; 

                if(!j.city && j.location) document.getElementById('jobCity').value = j.location;
                document.getElementById('jobSalary').value = j.salary||'';
                document.getElementById('jobDescription').value = j.description; document.getElementById('jobStatus').value = j.status||'Vigente';
                document.getElementById('jobAgency').value = j.agency||'';
                
                let contactVal = j.contact || '';
                let codeVal = '+52';
                if(contactVal.startsWith('+52')) { codeVal = '+52'; contactVal = contactVal.replace('+52',''); }
                else if(contactVal.startsWith('+1')) { codeVal = '+1'; contactVal = contactVal.replace('+1',''); }
                document.getElementById('jobPhoneCode').value = codeVal;
                document.getElementById('jobContact').value = contactVal;

                document.getElementById('jobSchedule').value = j.schedule||''; 
                tempReqs = j.requirements||[]; tempBens = j.benefits||[];
                updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
                document.getElementById('formModal').classList.add('active');
            }

            window.addItem = function(type) {
                const val = document.getElementById(type+'Input').value.trim();
                if(val) { (type==='req'?tempReqs:tempBens).push(val); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); document.getElementById(type+'Input').value=''; }
            }
            window.removeItem = function(type, i) { (type==='req'?tempReqs:tempBens).splice(i,1); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); }
            function updateList(id, arr, type) { document.getElementById(id).innerHTML = arr.map((item,i)=>`<li>${item}<button onclick="removeItem('${type}',${i})" style="color:red;border:none;background:none;cursor:pointer">√ó</button></li>`).join(''); }

            window.exportToExcel = function() {
                if(!Object.keys(jobs).length) return alert('Sin datos');
                const data = Object.keys(jobs).map(id => {
                    const j = jobs[id];
                    return { 
                        'ID': id, 'T√≠tulo': j.title, 'Empresa': j.company, 
                        'Mostrar Empresa Publicamente': (j.showCompany === true || j.showCompany === 'true') ? 'SI' : 'NO',
                        'Estado': j.state, 'Municipio': j.city, 'Zona': j.zone, 
                        'Fecha': j.fecha, 
                        'Salario': j.salary, 'Descripci√≥n': j.description, 
                        'Jornada': j.schedule, 
                        'Requisitos': (j.requirements||[]).join(' | '), 
                        'Beneficios': (j.benefits||[]).join(' | '),
                        'Contacto': j.contact, 'Estatus': j.status, 'Tipo de Servicio o Agencia': j.agency,
                        'IMPULSAR': j.isFeatured ? 'SI' : 'NO' 
                    };
                });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Vacantes"); XLSX.writeFile(wb, "Respaldo_Completo.xlsx");
            }

            window.downloadTemplate = function() {
                const data = [{
                    'ID': 'ej-1', 
                    'FECHA': '15/01/2026', 
                    'T√çTULO': 'Ejemplo', 
                    'EMPRESA': 'Empresa', 
                    'MOSTRAR EMPRESA PUBLICAMENTE': 'SI',
                    'ESTADO': 'CDMX', 
                    'MUNICIPIO': 'Coyoac√°n', 
                    'ZONA': 'Centro',
                    'SALARIO': '10000', 
                    'DESCRIPCI√ìN': 'Desc...', 
                    'JORNADA': 'Lunes a Viernes', 
                    'ETIQUETAS': '#Ventas', 
                    'REQUISITOS': 'Req 1 | Req 2', 
                    'BENEFICIOS': 'Ben 1 | Ben 2', 
                    'CONTACTO': '5512345678', 
                    'ESTATUS': 'Vigente', 
                    'TIPO DE SERVICIO O AGENCIA': 'Agencia Interna',
                    'IMPULSAR': 'SI'
                }];
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Plantilla'); XLSX.writeFile(wb, 'plantilla.xlsx');
            }

            window.shareApp = async function() {
                // CORRECCI√ìN: Usar localStorage
                const refCode = localStorage.getItem('recruiterCode');
                const encodedRef = refCode ? encodeURIComponent(refCode) : '';
                const url = encodedRef ? `${window.location.origin}/?ref=${encodedRef}` : window.location.origin;
                
                const data = { 
                    title: 'TuChamba Express', 
                    text: '¬°Checa esta vacante! Contrataci√≥n r√°pida en CDMX, NL y EdoMex. Detalles aqu√≠:', 
                    url: url
                };

                if(navigator.share) await navigator.share(data); else window.open(`https://wa.me/?text=${encodeURIComponent(data.text+' '+data.url)}`);
            }
            
            window.importFromExcel = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const wb = XLSX.read(data, {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws);
                        if(!json.length) { alert('Archivo vac√≠o'); return; }
                        let count = 0;
                        
                        const normalizeKey = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

                        const findKey = (row, keyName) => {
                            return Object.keys(row).find(k => normalizeKey(k) === normalizeKey(keyName));
                        };

                        json.forEach((row, i) => {
                            const titleKey = findKey(row, 't√≠tulo');
                            const companyKey = findKey(row, 'empresa');
                            
                            const title = titleKey ? row[titleKey] : null;
                            const company = companyKey ? row[companyKey] : null;
                            
                            if(!title || !company) return;
                            
                            const id = row['ID'] || 'job-'+Date.now()+'-'+i;
                            const state = row[findKey(row, 'estado')] || ''; 
                            const city = row[findKey(row, 'municipio')] || ''; 
                            const zone = row[findKey(row, 'zona')] || '';
                            const legacyLoc = row['Ubicaci√≥n'] || ''; 

                            const showCompKey = findKey(row, 'mostrar empresa publicamente');
                            let showCompanyRaw = 'SI';
                            if (showCompKey && row[showCompKey]) {
                                showCompanyRaw = String(row[showCompKey]).trim().toUpperCase();
                            }

                            const featuredKey = findKey(row, 'impulsar') || findKey(row, 'destacar') || findKey(row, 'top');
                            let isFeaturedRaw = 'NO';
                            if(featuredKey && row[featuredKey]) {
                                isFeaturedRaw = String(row[featuredKey]).trim().toUpperCase();
                            }

                            let contactRaw = row[findKey(row, 'contacto')] || '';
                            contactRaw = String(contactRaw).replace(/\D/g, ''); 
                            
                            if(contactRaw.length === 10) {
                                contactRaw = '+52' + contactRaw;
                            } else if (contactRaw.length > 10 && !contactRaw.startsWith('+')) {
                                contactRaw = '+' + contactRaw;
                            }

                            const jobData = {
                        title: title, 
                        company: company, 
                        showCompany: showCompanyRaw === 'SI', 
                        state: state, city: city, zone: zone,
                        location: (city && state) ? `${city}, ${state}` : legacyLoc, 
                        fecha: row[findKey(row, 'fecha')] || '', 
                        salary: row[findKey(row, 'salario')] || '', 
                        description: row[findKey(row, 'descripci√≥n')] || '',
                        schedule: row[findKey(row, 'jornada')] || 'Horario a definir',
                        // BORRADO: tags
                        requirements: (row[findKey(row, 'requisitos')]) ? String(row[findKey(row, 'requisitos')]).split(' | ') : [],
                        benefits: (row[findKey(row, 'beneficios')]) ? String(row[findKey(row, 'beneficios')]).split(/\s*\|\s*/) : [],
                        contact: contactRaw, 
                        status: row[findKey(row, 'estatus')] || 'Vigente',
                        agency: row[findKey(row, 'tipo de servicio o agencia')] || '',
                        isFeatured: isFeaturedRaw === 'SI' 
                    };
                            set(ref(db, 'jobs/' + id), jobData);
                            count++;
                        });
                        window.showToast(`‚úÖ ${count} vacantes cargadas`);
                    } catch(err) { alert('Error: ' + err.message); }
                    e.target.value = '';
                };
                reader.readAsArrayBuffer(file);
                };
                
                // --- MOTOR SEO (V25.10) ---
            function updateJobSEO(j, id) {
                // A. T√≠tulo de Pesta√±a Atractivo
                document.title = `${j.title} en ${j.city} | TuChamba Express`;

                // B. Meta Descripci√≥n (Para Google y compartir link)
                const metaDesc = document.querySelector('meta[name="description"]');
                if (metaDesc) {
                    metaDesc.setAttribute("content", `Vacante: ${j.title} ($${j.salary}) en ${j.city}. ¬°Post√∫late hoy mismo v√≠a WhatsApp!`);
                }

                // C. JSON-LD (Datos Estructurados para Google Jobs)
                const oldScript = document.getElementById('job-schema');
                if (oldScript) oldScript.remove();

                // Convertir fecha de Excel (DD/MM/YYYY) a ISO (YYYY-MM-DD)
                let isoDate = new Date().toISOString().split('T')[0];
                if (j.fecha && j.fecha.includes('/')) {
                    const p = j.fecha.split('/');
                    if(p.length === 3) isoDate = `${p[2]}-${p[1]}-${p[0]}`;
                }

                const schemaData = {
                    "@context": "https://schema.org/",
                    "@type": "JobPosting",
                    "title": j.title,
                    "description": j.description,
                    "identifier": { "@type": "PropertyValue", "name": "TuChamba", "value": id },
                    "datePosted": isoDate,
                    "validThrough": "2026-12-31",
                    "employmentType": "FULL_TIME",
                    "hiringOrganization": {
                        "@type": "Organization",
                        "name": (j.showCompany === true || j.showCompany === 'true') ? j.company : "Empresa Confidencial",
                        "logo": "https://tuchamba-express.vercel.app/favicon.png"
                    },
                    "jobLocation": {
                        "@type": "Place",
                        "address": {
                            "@type": "PostalAddress",
                            "addressLocality": j.city,
                            "addressRegion": j.state,
                            "addressCountry": "MX"
                        }
                    },
                    "baseSalary": {
                        "@type": "MonetaryAmount",
                        "currency": "MXN",
                        "value": {
                            "@type": "QuantitativeValue",
                            "value": parseFloat(j.salary.replace(/[^0-9.]/g, '')) || 0,
                            "unitText": "MONTH"
                        }
                    }
                };

                const script = document.createElement('script');
                script.id = 'job-schema';
                script.type = 'application/ld+json';
                script.text = JSON.stringify(schemaData);
                document.head.appendChild(script);
            }
            
        // --- HERRAMIENTA ADMIN: GENERADOR DE SITEMAP (V26.4 - CORREGIDO) ---
            window.downloadSitemap = function() {
            // 1. Iniciamos el contenido del XML
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlContent += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';

            // 2. P√°gina de inicio (Tu URL ra√≠z)
            xmlContent += '  <url>\n';
            xmlContent += '    <loc>https://tuchamba-express.vercel.app/</loc>\n';
            xmlContent += '    <changefreq>daily</changefreq>\n';
            xmlContent += '    <priority>1.0</priority>\n';
            xmlContent += '  </url>\n';

            // 3. Agregamos las vacantes que est√©n VIGENTES
            Object.keys(jobs).forEach(id => {
            const j = jobs[id];
            if (j.status !== 'No Vigente') {
            // Limpiamos el t√≠tulo para la URL
            const safeTitle = j.title
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9]/g, '-')
                .toLowerCase();

            // Construimos la URL y nos aseguramos de que los s√≠mbolos sean v√°lidos para Google
            const urlBasica = `https://tuchamba-express.vercel.app/?id=${id}`;
            const urlLimpia = urlBasica.replace(/&/g, '&amp;');
            
            xmlContent += '  <url>\n';
            xmlContent += `    <loc>${urlLimpia}</loc>\n`;
            xmlContent += '    <lastmod>' + new Date().toISOString().split('T')[0] + '</lastmod>\n';
            xmlContent += '    <changefreq>weekly</changefreq>\n';
            xmlContent += '    <priority>0.8</priority>\n';
            xmlContent += '  </url>\n';
            }
            });

            xmlContent += '</urlset>';

            // 4. Creamos el archivo y lo descargamos
                try {
            const blob = new Blob([xmlContent], { type: 'application/xml;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'sitemap.xml';
        
            // Lo agregamos al documento un milisegundo para darle clic y lo quitamos
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        
            window.showToast("‚úÖ Sitemap.xml listo para descargar");
            } catch (err) {
            console.error("Error al generar sitemap:", err);
            alert("No se pudo generar el archivo: " + err.message);
            }
        }   

            /* =========================================================
            BLOQUE DE RECUPERACI√ìN TOTAL (V22.FIX) üöë
            (Incluye: Descargas, Equipo, Directorio y Accesos)
            ========================================================= */

            // 1. DESCARGAR BASE (Si ya la tienes arriba, no dupliques, pero si la borraste, aqu√≠ va)
            window.downloadRecruitersDB = function() {
                if (!recruiters || Object.keys(recruiters).length === 0) return window.showToast("‚ùå Sin datos");
                
                const data = Object.values(recruiters).map(r => ({
                    'NOMBRE': r.name,
                    'N√öMERO': r.phone,
                    'C√ìDIGO/USUARIO': r.code,
                    'LINK PERSONAL': `${window.location.origin}/?ref=${r.code.toLowerCase()}`
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reclutadores");
                
                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Base_Reclutadores_${dateStr}.xlsx`);
                window.showToast("‚úÖ Base descargada");
            };

            // 2. M√ìDULO DE EQUIPO (EL QUE FALTABA)
            window.openTeamModal = function() {
                const modal = document.getElementById('teamModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                    resetRecruiterForm(); 
                    renderRecruitersTable(); // <--- PINTA LA LISTA
                }
            };

            window.closeTeamModal = function() {
                const modal = document.getElementById('teamModal');
                if(modal) {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                }
            };

            window.renderRecruitersTable = function() {
                const list = document.getElementById('recruitersList');
                if (!list) return;

                if (!recruiters || Object.keys(recruiters).length === 0) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">No hay reclutadores en el equipo.</td></tr>';
                    return;
                }

                list.innerHTML = Object.keys(recruiters).map(key => {
                    const r = recruiters[key];
                    const personalLink = `${window.location.origin}/?ref=${r.code.toLowerCase()}`;
                    
                    return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px 10px;">
                            <div style="font-weight: 700; color: #333; font-size: 14px;">${r.name}</div>
                            <div style="font-size: 12px; color: #666;">üì± ${r.phone}</div>
                        </td>
                        <td style="padding: 12px 10px;">
                            <span style="background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 12px;">
                                ${r.code}
                            </span>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <button onclick="copyRecruiterLink('${personalLink}')" 
                                    title="Copiar Link"
                                    style="background: #f5f5f5; border: 1px solid #ddd; padding: 6px 10px; border-radius: 4px; cursor: pointer;">
                                üîó
                            </button>
                        </td>
                        <td style="padding: 12px 10px; text-align: right;">
                            <button onclick="editRecruiter('${key}')" title="Editar" style="border: none; background: transparent; font-size: 16px; cursor: pointer; margin-right: 8px;">‚úèÔ∏è</button>
                            <button onclick="deleteRecruiter('${key}')" title="Eliminar" style="border: none; background: transparent; font-size: 16px; cursor: pointer; color: #d32f2f;">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                }).join('');
            };

            window.saveRecruiter = function() {
                const name = document.getElementById('recName').value.trim();
                const rawPhone = document.getElementById('recPhone').value.trim();
                const phoneCode = document.getElementById('recPhoneCode').value;
                const code = document.getElementById('recCode').value.toUpperCase().replace(/\s/g, '');

                if (!name || !rawPhone || !code) return alert('‚ö†Ô∏è Llena todos los campos');

                let cleanPhone = rawPhone.replace(/\D/g, '');
                const codeDigits = phoneCode.replace('+', '');
                if (cleanPhone.startsWith(codeDigits)) cleanPhone = cleanPhone.substring(codeDigits.length);
                const finalPhone = phoneCode + cleanPhone;

                const duplicateCheck = Object.entries(recruiters).find(([key, r]) => { 
                    return r.code === code && key !== editingRecruiterId; 
                });
                if (duplicateCheck) return alert(`‚ö†Ô∏è El c√≥digo '${code}' ya existe.`); 

                const recruiterData = { name, phone: finalPhone, code };
                const idToSave = editingRecruiterId || 'rec-' + Date.now();

                set(ref(db, 'recruiters/' + idToSave), recruiterData)
                    .then(() => {
                        window.showToast(editingRecruiterId ? '‚úÖ Actualizado' : '‚úÖ Agregado');
                        resetRecruiterForm();    
                        renderRecruitersTable(); 
                    });
            };

            window.editRecruiter = function(key) {
            const r = recruiters[key];
            document.getElementById('recName').value = r.name;
            document.getElementById('recCode').value = r.code;
            document.getElementById('recPhone').value = r.phone.replace(/^\+\d{2,3}/, ''); 
            
            editingRecruiterId = key;
            
            // Solo cambiamos el bot√≥n de Guardar, ignoramos el de cancelar
            const btnSave = document.getElementById('btnSaveRecruiter');
            if(btnSave) btnSave.innerHTML = "üîÑ Actualizar";
        };

            window.deleteRecruiter = function(key) {
                if (confirm("¬øEliminar?")) {
                    remove(ref(db, 'recruiters/' + key))
                        .then(() => {
                            window.showToast("üóëÔ∏è Eliminado");
                            renderRecruitersTable();
                        });
                }
            };

            window.resetRecruiterForm = function() {
            document.getElementById('recName').value = '';
            document.getElementById('recCode').value = '';
            document.getElementById('recPhone').value = '';
            editingRecruiterId = null;
            
            // Solo reseteamos el bot√≥n de Guardar
            const btnSave = document.getElementById('btnSaveRecruiter');
            if(btnSave) btnSave.innerHTML = "üíæ Guardar";
        };
          
        // COPIAR LINK PERSONAL - VERSI√ìN DEBUG (para ver por qu√© falla)
        window.copyRecruiterLink = function(specificLink = null) {
            let linkToCopy;
            let debugInfo = [];

            if (specificLink) {
                linkToCopy = specificLink;
                debugInfo.push("Usando link espec√≠fico pasado: " + specificLink);
            } else {
                // Intentamos obtener refCode de varias fuentes
                const urlParams = new URLSearchParams(window.location.search);
                let refCode = urlParams.get('ref');
                debugInfo.push("De URL (?ref=): " + (refCode || "NO ENCONTRADO"));

                if (!refCode) {
                    refCode = sessionStorage.getItem('recruiterCode');
                    debugInfo.push("De sessionStorage ('recruiterCode'): " + (refCode || "NO ENCONTRADO"));
                }

                if (!refCode) {
                    refCode = localStorage.getItem('recruiterCode');
                    debugInfo.push("De localStorage ('recruiterCode'): " + (refCode || "NO ENCONTRADO"));
                }

                if (!refCode && window.activeRecruiter && window.activeRecruiter.code) {
                    refCode = window.activeRecruiter.code;
                    debugInfo.push("De window.activeRecruiter.code: " + refCode);
                }

                if (!refCode) {
                    window.showToast("‚ö†Ô∏è No se encontr√≥ c√≥digo de reclutador en ninguna fuente");
                    console.log("DEBUG copyRecruiterLink - Fuentes chequeadas:", debugInfo);
                    console.log("URL actual:", window.location.href);
                    return;
                }

                linkToCopy = `${window.location.origin}/?ref=${refCode.toLowerCase()}`;
                debugInfo.push("Link final construido: " + linkToCopy);
            }

            navigator.clipboard.writeText(linkToCopy)
                .then(() => {
                    window.showToast("‚úÖ Link copiado: " + linkToCopy);
                    console.log("DEBUG - Link COPIADO exitosamente:", linkToCopy);
                    console.log("Fuentes chequeadas:", debugInfo);
                })
                .catch(err => {
                    console.error("Error al copiar:", err);
                    prompt("Copia manual (Ctrl+C):", linkToCopy);
                });
        };

            window.toggleAdminSearch = function() {
                const searchBar = document.getElementById('userStickyTools');
                if(searchBar) {
                    searchBar.classList.toggle('active');
                    if(searchBar.classList.contains('active')) {
                        setTimeout(() => {
                            const input = document.getElementById('searchInput');
                            if(input) input.focus();
                        }, 100);
                    }
                }
            };

            
        </script>

    <div style="text-align: center; font-size: 10px; color: #666; padding: 20px 10px; opacity: 0.7;">
    <p>
        <strong>TuChamba Express ¬© 2026.</strong> Plataforma de vinculaci√≥n laboral. 
        No somos responsables de las contrataciones ni condiciones laborales (NOM-035) ofrecidas por terceros.
    </p>
    <p>
        Este sitio utiliza almacenamiento local para mejorar tu experiencia. 
        No guardamos datos personales de candidatos sin consentimiento.
        <a href="#" onclick="alert('Aviso de Privacidad Simplificado:\n\n1. No recopilamos tu nombre ni correo.\n2. Los datos de contacto son p√∫blicos bajo responsabilidad del reclutador.\n3. Usamos cookies an√≥nimas para contar visitas.\n\nPara ejercer derechos ARCO, contacta al admin.')" style="color: #666; text-decoration: underline;">Ver Aviso de Privacidad</a>
    </p>
</div>

    </body>
    </html>
