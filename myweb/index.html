<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>TuChamba Express | Vacantes Urgentes en CDMX, Monterrey y EdoMex 2026</title>
    
    <link rel="icon" href="favicon.png" type="image/png">

    <meta name="description" content="Encuentra trabajo sin experiencia y de contrataci√≥n inmediata en Ixtapaluca, Chalco, CDMX y Monterrey. ¬°Sin registros! Contacta directo por WhatsApp. Vacantes vigentes 2026.">
    
    <meta name="keywords" content="bolsa de trabajo 2026, trabajo ixtapaluca, vacantes chalco, empleo valle de chalco, trabajo sin experiencia, cdmx, monterrey, nuevo leon, lunes a viernes, contrataci√≥n inmediata, ayudante general, ventas, atenci√≥n a clientes">

    <meta property="og:title" content="¬øBuscas chamba urgente? Vacantes en CDMX, NL y EdoMex üöÄ">
    <meta property="og:description" content="Sin correos ni registros. Clic y directo al WhatsApp del reclutador. ¬°Entra ya!">
    <meta property="og:image" content="https://tuchamba-express.vercel.app/banner_1.png">
    <meta property="og:url" content="https://tuchamba-express.vercel.app/">
    <meta property="og:type" content="website">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
      body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: 
                linear-gradient(to bottom, rgba(10, 30, 60, 0.75), rgba(10, 30, 60, 0.85)),
                url('https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;       
            background-position: center;  
            background-attachment: fixed; 
            padding: 15px;
            min-height: 100vh;
        }

        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff;
            text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2147483647 !important;
            left: 50%; bottom: 30px; font-size: 15px; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible !important; opacity: 1 !important; bottom: 50px !important; }

        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: #ccc; font-size: 12px; }
        .footer-link { color: #fff; text-decoration: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .legal-note { color: #999; margin-top: 8px; font-style: italic; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 1000px 100%; display: inline-block; position: relative; animation: shimmer 2s infinite linear forwards; border-radius: 4px; }
        .skeleton-card { background: white; border-radius: 16px; padding: 25px; height: 200px; display: flex; flex-direction: column; gap: 15px; }
        .sk-title { width: 70%; height: 24px; } .sk-text { width: 90%; height: 16px; } .sk-tag { width: 30%; height: 20px; border-radius: 20px; }

        .welcome-container { 
            max-width: 480px; 
            margin: 60px auto; 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(8px);            
            -webkit-backdrop-filter: blur(8px);    
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-top: 5px solid #ffc107; 
            padding: 40px 25px; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            text-align: center; 
        }
        
        .welcome-title { font-size: 28px; color: #ffffff; margin-bottom: 10px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.6); }
        .welcome-subtitle { color: #f0f0f0; margin-bottom: 30px; font-size: 16px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5); line-height: 1.5; }
        
        .btn-big-guest { background: #0a66c2; color: white; border: none; padding: 16px; width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-big-guest:hover { background: #004182; transform: translateY(-2px); }
        
        .admin-toggle-link { display: block; margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 13px; text-decoration: underline; cursor: pointer; }
        .admin-login-form { display: none; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); text-align: left; animation: fadeIn 0.5s; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { max-width: 1000px; margin: 0 auto; }

        .header { 
            background: white; 
            padding: 12px 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .header h1 { 
            font-size: 20px; 
            color: #333; 
            font-weight: 800; 
            margin: 0;
            line-height: 1.2;
        }
        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #recruiterBanner { 
            background: #e3f2fd !important; 
            color: #0d47a1 !important; 
            padding: 8px 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            font-size: 13px; 
            display: flex !important; 
            align-items: center; 
            gap: 10px; 
            border: 1px solid #bbdefb; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        #recruiterBanner:hover { background: #bbdefb !important; }

        .filter-container { 
            background: white; 
            padding: 10px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; 
            gap: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            align-items: center; 
        }
        
        .filter-icon-box { display: flex; align-items: center; justify-content: center; background: #f0f2f5; padding: 10px; border-radius: 8px; border: 1px solid #ddd; height: 42px; width: 42px; flex-shrink: 0; }
        .filter-select { flex: 1; min-width: 0; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; outline: none; height: 42px; }

        #mobileFilterToggle { display: none; } 

        .btn-primary, .admin-btn { background: #0a66c2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; font-size: 14px; }
        .add-job-btn { background: #10a37f; padding: 12px 24px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .tool-btn { background: #2c3e50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .metrics-btn { background: #7b1fa2; } .team-btn { background: #e65100; } .settings-btn { background: #607d8b; }
        .danger-section { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 25px; }
        .danger-btn { background: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

        .load-more-container { text-align: center; margin-top: 30px; margin-bottom: 40px; }
        .btn-load-more { background: white; color: #0a66c2; border: 2px solid #0a66c2; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 16px; }

        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px 20px 20px; margin: 20px -30px -30px; border-top: 1px solid #eee; text-align: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 100; }
        
        .whatsapp-btn-large { display: flex; align-items: center; justify-content: center; width: 100%; background-color: #25D366; color: white; text-decoration: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.3); transition: transform 0.1s, background-color 0.3s; border: none; cursor: pointer; }
        .whatsapp-btn-large:active { transform: scale(0.98); }
        .whatsapp-btn-large:disabled { background-color: #9ccc65; cursor: not-allowed; transform: none; }

        .share-btn { background: #25D366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .admin-controls-wrapper { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .metrics-card { background: white; color: #333; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; font-size: 14px; }
        .metric-val { color: #0a66c2; font-weight: 800; margin-left: 4px; margin-right: 12px; }
        .admin-mode-indicator { background: #ffe0b2; color: #e65100; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #ffcc80; }

        .job-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .job-card { background: white; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; border: 1px solid #f0f0f0; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .job-card:hover { transform: translateY(-4px); }
        .job-card.hidden { display: none; }

        .card-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-right: 35px; }
        
        .badge-vigente { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
        .badge-closed { background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }
        .job-date { font-size: 0.75rem; color: #888; background: #f5f5f5; padding: 2px 8px; border-radius: 4px; }

        .job-title { font-size: 1.2rem; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; line-height: 1.3; }
        .company-name { font-size: 0.9rem; color: #0a66c2; font-weight: 600; }
        .location { font-size: 0.9rem; color: #555; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
        .salary-text { color: #d32f2f; font-weight: 800; font-size: 1.1rem; margin-top: 5px; }

        .company-logo { width: 48px; height: 48px; background: linear-gradient(135deg, #0a66c2 0%, #004182 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }

        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 15px; }
        .tag { background: #f3f2ef; color: #444; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }

        .more-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 24px; color: #ccc; cursor: pointer; width: 30px; height: 30px; z-index: 5; }
        .admin-actions { display: none; position: absolute; top: 45px; right: 15px; background: white; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 20; }
        .admin-actions.active { display: block; }
        .admin-action { padding: 10px 20px; width: 100%; text-align: left; border: none; background: none; cursor: pointer; }
        .admin-action:hover { background: #f9f9f9; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; max-width: 600px; width: 100%; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; padding-bottom: 0; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #f0f2f5; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #666; z-index: 10; }
        
        .job-details { display: grid; gap: 15px; margin-bottom: 20px; }
        .detail-item { font-size: 15px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .location-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        /* ESTILO PARA INPUT DE TEL√âFONO INTERNACIONAL */
        .phone-group { display: flex; gap: 10px; }
        .phone-select { width: 110px; flex-shrink: 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        
        @media (max-width: 500px) { .location-grid { grid-template-columns: 1fr; } }
        
        .view-count-badge { background: #e3f2fd; color: #0277bd; font-size: 12px; padding: 6px 14px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 15px; font-weight: 700; border: 1px solid #bbdefb; margin-right: 5px; }
        .agency-badge { background: #fff3e0; color: #ef6c00; font-size: 12px; padding: 6px 14px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 15px; font-weight: 700; border: 1px solid #ffe0b2; }

        .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 12px; margin-top: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 5px; display: inline-block; }
        .item-list li { background: #f9f9f9; padding: 8px 12px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; }
        .recruiters-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .recruiters-table th, .recruiters-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }

        .job-counter { color: white; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-bottom: 10px; display: block; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { 
                flex-direction: row; 
                justify-content: space-between; 
                align-items: center;
                gap: 5px;
            }
            .header h1 {
                font-size: 17px; 
                max-width: 50%; 
                line-height: 1.1;
            }
            .filter-container { 
                display: grid; 
                grid-template-columns: auto 1fr 1fr; 
                gap: 8px;
                overflow-x: visible; 
            }
            .filter-icon-box { height: 40px; width: 40px; }
            .filter-select { height: 40px; font-size: 13px; padding: 5px; }
            
            .admin-controls-wrapper button { flex: 1; min-width: 45%; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="welcome-container">
        <div style="font-size: 50px; margin-bottom: 10px;">üöÄ</div>
        <h1 class="welcome-title">TuChamba Express</h1>
        <p class="welcome-subtitle">
            Tu nueva chamba a un mensaje de distancia.<br>
            Sin registros complicados.
        </p>
        <button class="btn-big-guest" onclick="enterAsGuest()">üîç Ver Vacantes Disponibles</button>
        <div class="admin-toggle-link" onclick="toggleAdminLogin()">¬øEres Reclutador? Ingresa aqu√≠</div>
        <div id="adminForm" class="admin-login-form">
            <div class="form-group"><label style="color:white;">Correo de Acceso</label><input type="email" id="adminEmail" placeholder="admin@empresa.com" autocomplete="off" style="background:rgba(255,255,255,0.9);"></div>
            <div class="form-group"><label style="color:white;">Contrase√±a</label><input type="password" id="adminPassword" placeholder="******" autocomplete="off" style="background:rgba(255,255,255,0.9);"></div>
            <button class="btn-primary" style="width: 100%;" onclick="login()">Entrar al Panel</button>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="container">
            
            <div class="header">
                <h1>Portal de Vacantes</h1>
                <div class="header-buttons">
                    <button class="share-btn" onclick="shareApp()">üì§ Compartir</button>
                    <span id="modeIndicator"></span>
                    <button class="admin-btn" style="background: #333;" onclick="logout()">Salir</button>
                </div>
            </div>

            <div id="recruiterBanner" onclick="contactCentralOffice()">
                üë§ Asistido por: <span id="recruiterNameDisplay">Oficina Central</span> (Clic para contacto)
            </div>

            <div id="adminControls" style="display: none;">
                <div class="admin-controls-wrapper">
                    <div class="metrics-card">
                        üåé <span class="metric-val" id="totalVisits">...</span>
                        üìÖ Mes: <span class="metric-val" id="monthlyVisits">...</span>
                    </div>
                    <button class="add-job-btn" onclick="openJobForm()">‚ûï Nueva</button>
                    <button class="tool-btn" onclick="exportToExcel()">üì¶ Respaldo</button> 
                    <button class="tool-btn metrics-btn" onclick="exportMetrics()">üìä M√©tricas</button>
                    <button class="tool-btn team-btn" onclick="openTeamModal()">üë• Equipo</button>
                    <button class="tool-btn settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Ajustes</button>
                    
                    <button class="tool-btn" onclick="document.getElementById('excelFile').click()">üì§ Cargar</button>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importFromExcel(event)">
                    <button class="tool-btn" onclick="downloadTemplate()">üìã Plantilla</button>
                </div>
            </div>

            <button id="mobileFilterToggle" onclick="toggleMobileFilters()">
                üîç Filtros de B√∫squeda <span>‚ñº</span>
            </button>

            <div class="filter-container" id="filterContainer">
                <div class="filter-icon-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                </div>
                <select id="stateFilter" class="filter-select" onchange="filterJobs()">
                    <option value="">üìç Estado</option>
                </select>
                <select id="cityFilter" class="filter-select" onchange="filterJobs()">
                    <option value="">üèôÔ∏è Municipio</option>
                </select>
            </div>

            <div class="grid-header"><div class="job-counter" id="jobCounter"></div></div>
            
            <div id="skeletonLoader" class="job-grid">
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
                <div class="skeleton-card"><div class="skeleton sk-title"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-tag"></div></div>
            </div>

            <div class="job-grid" id="jobGrid" style="display: none;"></div>
            
            <div id="loadMoreContainer" class="load-more-container" style="display:none;">
                <button class="btn-load-more" onclick="loadMoreJobs()">‚¨áÔ∏è Ver m√°s vacantes</button>
            </div>

            <div class="footer">
                <p>TuChamba Express &copy; 2024. Todos los derechos reservados.</p>
                <div class="legal-note">Aviso: Algunas empresas pueden solicitar examen m√©dico y/o antidoping.</div>
                <div style="margin-top:10px;">
                    <a class="footer-link" onclick="openPrivacyModal()">üîí Aviso de Privacidad</a>
                </div>
            </div>

            <div id="emptyState" class="welcome-container" style="display: none; padding: 30px; margin-top: 20px;">
                <h3>No hay vacantes publicadas üò¢</h3><p>Intenta m√°s tarde o ajusta los filtros.</p>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <div class="modal" id="viewModal"><div class="modal-content"><button class="close-btn" onclick="closeViewModal()">√ó</button><div id="viewModalBody"></div></div></div>

    <div class="modal" id="formModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeFormModal()">√ó</button>
            <h2 id="formTitle">Gestionar Vacante</h2>
            <form id="jobForm" onsubmit="saveJob(event)">
                <div class="form-group"><label>Estatus</label><select id="jobStatus"><option value="Vigente">Vigente (Verde)</option><option value="No Vigente">No Vigente (Rojo)</option></select></div>
                
                <div class="form-group"><label>¬øMostrar nombre de empresa al p√∫blico?</label><select id="jobShowCompany"><option value="true">S√ç (Visible para todos)</option><option value="false">NO (Confidencial / Solo Admin)</option></select></div>
                
                <div class="form-group" style="background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ef6c00;">
                    <label style="color: #e65100;">üè¢ Tipo de Servicio o Agencia (Interno)</label>
                    <input type="text" id="jobAgency" placeholder="Ej. Agencia Norte - Solo visible para Reclutador">
                </div>
                <div class="form-group"><label>T√≠tulo *</label><input type="text" id="jobTitle" required></div>
                <div class="form-group"><label>Empresa (Nombre Real) *</label><input type="text" id="jobCompany" required placeholder="Escribe el nombre real aqu√≠"></div>
                
                <div class="form-group">
                    <label>Ubicaci√≥n Detallada *</label>
                    <div class="location-grid">
                        <input type="text" id="jobState" placeholder="Estado (Ej. CDMX)" required>
                        <input type="text" id="jobCity" placeholder="Municipio (Ej. Coyoac√°n)" required>
                        <input type="text" id="jobZone" placeholder="Colonia/Zona (Ej. Centro)">
                    </div>
                </div>

                <div class="form-group"><label>Fecha de Publicaci√≥n</label><input type="date" id="jobDate"></div>
                
                <div class="form-group"><label>Salario</label><input type="text" id="jobSalary" placeholder="$8,500/mes"></div>
                <div class="form-group"><label>Descripci√≥n *</label><textarea id="jobDescription" required></textarea></div>
                <div class="form-group"><label>Jornada / Horario</label><input type="text" id="jobSchedule" placeholder="Ej. Lunes a Viernes 9 a 6"></div>
                
                <div class="form-group"><label>Etiquetas</label><input type="text" id="jobTags" placeholder="#Ventas, #Seguros"></div>
                <div class="form-group"><label>Requisitos</label><div class="list-input"><input type="text" id="reqInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('req')">+</button></div><ul class="item-list" id="reqList"></ul></div>
                <div class="form-group"><label>Beneficios</label><div class="list-input"><input type="text" id="benInput"><button type="button" class="tool-btn" style="background:#0a66c2" onclick="addItem('ben')">+</button></div><ul class="item-list" id="benList"></ul></div>
                
                <div class="form-group">
                    <label>WhatsApp Contacto (N√∫mero Real)</label>
                    <div class="phone-group">
                        <select id="jobPhoneCode" class="phone-select">
                            <option value="+52">üá≤üáΩ +52</option>
                            <option value="+1">üá∫üá∏ +1</option>
                            <option value="+57">üá®üá¥ +57</option>
                            <option value="+54">üá¶üá∑ +54</option>
                            <option value="+51">üáµüá™ +51</option>
                            <option value="+34">üá™üá∏ +34</option>
                        </select>
                        <input type="text" id="jobContact" placeholder="10 d√≠gitos (Ej. 5512345678)" style="flex:1;">
                    </div>
                </div>

                <div class="form-actions"><button type="button" class="tool-btn" style="background:#666; width:100%" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary" style="width:100%">Guardar</button></div>
            </form>
        </div>
    </div>

    <div class="modal" id="teamModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeTeamModal()">√ó</button>
            <h2>üë• Gesti√≥n de Reclutadores</h2>
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <input type="hidden" id="recIdEdit"> 
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                         <div style="flex:1; min-width:150px;">
                            <label style="font-size:12px; font-weight:bold; color:#555;">Nombre</label>
                            <input type="text" id="recName" placeholder="Ej. Juan P√©rez" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                        </div>
                        <div style="width:120px;">
                            <label style="font-size:12px; font-weight:bold; color:#555;">C√≥digo</label>
                            <input type="text" id="recCode" placeholder="Ej. JUAN" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; text-transform:uppercase;">
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size:12px; font-weight:bold; color:#555;">WhatsApp</label>
                        <div class="phone-group">
                            <select id="recPhoneCode" class="phone-select" style="padding:8px; height:36px;">
                                <option value="+52">üá≤üáΩ +52</option>
                                <option value="+1">üá∫üá∏ +1</option>
                                <option value="+57">üá®üá¥ +57</option>
                                <option value="+54">üá¶üá∑ +54</option>
                                <option value="+51">üáµüá™ +51</option>
                                <option value="+34">üá™üá∏ +34</option>
                            </select>
                            <input type="text" id="recPhone" placeholder="10 d√≠gitos" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button type="button" id="btnSaveRecruiter" class="btn-primary" style="flex:1; padding:9px 15px;" onclick="saveRecruiter()">Agregar</button>
                        <button type="button" id="btnCancelRecruiter" class="tool-btn" style="flex:0; display:none; background:#999;" onclick="resetRecruiterForm()">Cancelar</button>
                    </div>
                </div>
            </div>
            <table class="recruiters-table">
                <thead><tr><th>Nombre</th><th>C√≥digo</th><th>Link</th><th>Acciones</th></tr></thead>
                <tbody id="recruitersList"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            <h2>‚öôÔ∏è Ajustes del Sistema</h2>
            <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bbdefb;">
                <h3 style="font-size:16px; margin-bottom:10px; color:#0d47a1;">üìû Tel√©fono Oficina Central (Respaldo)</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="settingsPhoneInput" placeholder="Ej. 5512345678" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    <button id="btnSaveCentral" class="btn-primary" onclick="saveCentralConfig()">Guardar</button>
                </div>
            </div>
            <div class="danger-section">
                <h3 style="font-size:16px; margin-bottom:10px; color:#d32f2f;">‚ö†Ô∏è Zona de Peligro (Admin)</h3>
                <p style="font-size:12px; color:#666;">Acciones irreversibles protegidas por contrase√±a.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="danger-btn" onclick="requestPassword('resetMetrics')">üóëÔ∏è Resetear M√©tricas (Vistas)</button>
                    <button class="danger-btn" onclick="requestPassword('deleteJobs')">üî• Borrar TODAS las Vacantes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <button class="close-btn" onclick="closePasswordModal()">√ó</button>
            <div style="font-size:40px; margin-bottom:10px;">üîí</div>
            <h3 style="margin-bottom:15px;">Acci√≥n Protegida</h3>
            <p style="margin-bottom:20px; color:#666;">Ingresa la contrase√±a de administrador:</p>
            <input type="password" id="adminPasswordInput" placeholder="Contrase√±a..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px; font-size:16px;">
            <div style="display:flex; gap:10px;">
                <button class="tool-btn" style="flex:1; justify-content:center; background:#999;" onclick="closePasswordModal()">Cancelar</button>
                <button class="btn-primary" style="flex:1; justify-content:center;" onclick="submitPassword()">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closePrivacyModal()">√ó</button>
            <h2 style="margin-bottom:20px;">üîí Aviso de Privacidad</h2>
            <div style="font-size:14px; color:#444; line-height:1.6; max-height:60vh; overflow-y:auto; padding-right:10px;">
                <p><strong>√öltima actualizaci√≥n: Enero 2026</strong></p><br>
                <p>En cumplimiento con la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares, TuChamba Express informa:</p><br>
                <p><strong>1. Responsable de los datos:</strong><br>TuChamba Express act√∫a como enlace entre candidatos y empresas reclutadoras.</p><br>
                <p><strong>2. Datos recopilados:</strong><br>Podemos recopilar datos de contacto (como n√∫mero telef√≥nico) con el √∫nico fin de facilitar la comunicaci√≥n para procesos de reclutamiento.</p><br>
                <p><strong>3. Uso de la informaci√≥n:</strong><br>Los datos proporcionados ser√°n utilizados exclusivamente para:<br>- Contactar al candidato respecto a la vacante de inter√©s.<br>- Agendar entrevistas laborales.<br>- Procesos internos de selecci√≥n.</p><br>
                <p><strong>4. Compartir datos:</strong><br>Su informaci√≥n de contacto ser√° compartida √∫nicamente con la empresa o reclutador responsable de la vacante a la que usted decida postularse voluntariamente.</p><br>
                <p><strong>5. Examen M√©dico:</strong><br>Al utilizar esta plataforma, usted reconoce que algunas empresas contratantes pueden requerir, como parte de su proceso de selecci√≥n y conforme a la ley, la realizaci√≥n de ex√°menes m√©dicos y/o pruebas de detecci√≥n de sustancias.</p>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-primary" onclick="closePrivacyModal()">Entendido</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, runTransaction, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // TUS CLAVES (NO TOCAR)
        const firebaseConfig = {
          apiKey: "AIzaSyB1k1lnQjQXiGYJRT9E9-KYzGSBBmrQGFI",
          authDomain: "vacancy-page-v2.firebaseapp.com",
          databaseURL: "https://vacancy-page-v2-default-rtdb.firebaseio.com",
          projectId: "vacancy-page-v2",
          storageBucket: "vacancy-page-v2.firebasestorage.app",
          messagingSenderId: "242419485392",
          appId: "1:242419485392:web:c486a767a1810ada876cd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isAdmin = false;
        let currentEditId = null;
        let jobs = {};
        let jobStats = {}; 
        let recruiters = {}; 
        let clickLogs = {};
        
        let activeRecruiter = null; 
        let centralPhone = ''; 
        let editingRecruiterId = null; 
        
        let pendingAction = null; 

        let tempReqs = [];
        let tempBens = [];
        let displayLimit = 20; 
        let currentFilteredJobs = []; 

        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) sessionStorage.setItem('recruiterCode', refCode.toLowerCase());

        onAuthStateChanged(auth, (user) => {
            if (user) { isAdmin = true; setAdminMode(true); } 
            else {
                if (sessionStorage.getItem('isGuest') === 'true' || refCode) { isAdmin = false; setAdminMode(false); } 
                else { showLogin(); }
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active'));
        }

        // FUNCIONES MODALES
        window.openPrivacyModal = function() { document.getElementById('privacyModal').classList.add('active'); }
        window.closePrivacyModal = function() { document.getElementById('privacyModal').classList.remove('active'); }
        window.openSettingsModal = function() { document.getElementById('settingsModal').classList.add('active'); if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone; }
        window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.remove('active'); }

        window.requestPassword = function(action) {
            pendingAction = action;
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('passwordModal').classList.add('active');
            setTimeout(() => document.getElementById('adminPasswordInput').focus(), 100);
        }

        window.closePasswordModal = function() {
            document.getElementById('passwordModal').classList.remove('active');
            pendingAction = null;
        }

        window.submitPassword = function() {
            const pass = document.getElementById('adminPasswordInput').value;
            if (pass === "Adm1n*+-2025") {
                const actionToRun = pendingAction; 
                if(confirm("¬øEst√°s seguro de que quieres realizar esta acci√≥n? Es irreversible.")) {
                    if (actionToRun === 'resetMetrics') resetMetrics();
                    if (actionToRun === 'deleteJobs') deleteAllJobs();
                    window.closePasswordModal(); 
                }
            } else {
                window.showToast("‚õî Contrase√±a incorrecta");
                document.getElementById('adminPasswordInput').value = '';
            }
        }

        window.showToast = function(message) {
            const x = document.getElementById("toast");
            if(x) {
                x.textContent = message;
                x.className = "show";
                setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
            }
        }

        function resetMetrics() {
            remove(ref(db, 'siteStats'));
            remove(ref(db, 'jobStats'));
            remove(ref(db, 'clickLogs'));
            window.showToast("‚úÖ M√©tricas reseteadas a 0");
        }

        function deleteAllJobs() {
            remove(ref(db, 'jobs')).then(() => {
                window.showToast("üî• Todas las vacantes eliminadas");
            });
        }

        window.toggleMobileFilters = function() {
            const container = document.getElementById('filterContainer');
            container.classList.toggle('active');
        }

        window.toggleAdminLogin = function() { const f = document.getElementById('adminForm'); f.style.display = (f.style.display==='none'||f.style.display==='') ? 'block' : 'none'; }
        window.login = async function() {
            try { await setPersistence(auth, browserSessionPersistence); await signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPassword').value); sessionStorage.removeItem('isGuest'); } catch (error) { alert("Error: " + error.message); }
        }
        window.enterAsGuest = function() { sessionStorage.setItem('isGuest', 'true'); isAdmin = false; setAdminMode(false); }
        window.logout = function() { signOut(auth).then(() => { sessionStorage.removeItem('isGuest'); isAdmin = false; showLogin(); }); }

        function showLogin() { document.getElementById('loginScreen').style.display = 'block'; document.getElementById('mainApp').style.display = 'none'; document.getElementById('adminForm').style.display = 'none'; }
        function setAdminMode(enableAdmin) {
            document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block';
            
            const isRefMode = !!refCode;
            if (enableAdmin && !isRefMode) {
                document.getElementById('modeIndicator').innerHTML = '<span class="admin-mode-indicator">Super Admin</span>';
                document.getElementById('adminControls').style.display = 'block';
            } else {
                document.getElementById('modeIndicator').innerHTML = '';
                document.getElementById('adminControls').style.display = 'none';
            }
            loadData();
        }

        function loadData() {
            onValue(ref(db, 'jobs'), (s) => { 
                jobs = s.val() || {}; 
                document.getElementById('skeletonLoader').style.display = 'none'; 
                document.getElementById('jobGrid').style.display = 'grid';
                populateFilters(jobs); 
                renderJobs(); 
            });
            onValue(ref(db, 'jobStats'), (s) => { jobStats = s.val() || {}; });
            onValue(ref(db, 'clickLogs'), (s) => { clickLogs = s.val() || {}; });
            
            onValue(ref(db, 'recruiters'), (s) => { 
                recruiters = s.val() || {}; 
                checkActiveRecruiter(); 
                if(isAdmin) renderRecruitersTable(); 
            });
            
            onValue(ref(db, 'settings/centralPhone'), (s) => { 
                centralPhone = s.val() || '';
                if(document.getElementById('settingsPhoneInput')) document.getElementById('settingsPhoneInput').value = centralPhone;
                updateBanner();
            });
        }

        function populateFilters(jobsData) {
            const allJobsArr = Object.values(jobsData);
            const stateSelect = document.getElementById('stateFilter');
            const citySelect = document.getElementById('cityFilter');

            const uniqueStates = [...new Set(allJobsArr.map(j => j.state).filter(Boolean))].sort();
            const uniqueCities = [...new Set(allJobsArr.map(j => j.city).filter(Boolean))].sort();
            
            const currState = stateSelect.value;
            const currCity = citySelect.value;

            stateSelect.innerHTML = '<option value="">üìç Estado</option>';
            uniqueStates.forEach(s => {
                stateSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            citySelect.innerHTML = '<option value="">üèôÔ∏è Municipio</option>';
            uniqueCities.forEach(c => {
                 citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            if(uniqueStates.includes(currState)) stateSelect.value = currState;
            if(uniqueCities.includes(currCity)) citySelect.value = currCity;
        }

        function checkActiveRecruiter() {
            const savedCode = sessionStorage.getItem('recruiterCode');
            activeRecruiter = null; 
            if (savedCode && recruiters) {
                const foundKey = Object.keys(recruiters).find(key => recruiters[key].code.toLowerCase() === savedCode);
                if (foundKey) { 
                    activeRecruiter = recruiters[foundKey]; 
                }
            }
            updateBanner();
        }

        function updateBanner() {
            const bannerName = document.getElementById('recruiterNameDisplay');
            if(activeRecruiter) {
                bannerName.textContent = activeRecruiter.name;
            } else {
                bannerName.textContent = "Oficina Central";
            }
        }

        window.contactCentralOffice = function() {
            let phoneToContact = '';
            if(activeRecruiter) {
                phoneToContact = activeRecruiter.phone;
            } else {
                phoneToContact = centralPhone;
            }

            if(phoneToContact) {
                const cleanPhone = phoneToContact.replace(/\D/g, '');
                window.open(`https://wa.me/${cleanPhone}?text=Hola,%20necesito%20ayuda%20general`, '_blank');
            } else {
                alert("No hay un n√∫mero de contacto general configurado.");
            }
        }

        window.saveCentralConfig = function() {
            const val = document.getElementById('settingsPhoneInput').value.trim();
            const btn = document.getElementById('btnSaveCentral');
            const originalText = btn.textContent;
            
            btn.textContent = "Guardando...";
            set(ref(db, 'settings/centralPhone'), val)
                .then(() => {
                    window.showToast('‚úÖ Tel√©fono de Oficina Central actualizado.');
                    btn.style.backgroundColor = '#2ecc71'; 
                    btn.textContent = '‚úÖ ¬°Guardado!';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                })
                .catch((error) => {
                    window.showToast('‚ùå Error al guardar: ' + error.message);
                    btn.style.backgroundColor = '#e74c3c'; btn.textContent = 'Error';
                    setTimeout(() => { btn.style.backgroundColor = '#0a66c2'; btn.textContent = originalText; }, 2000);
                });
        }

        window.openTeamModal = function() { document.getElementById('teamModal').classList.add('active'); resetRecruiterForm(); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }

        window.saveRecruiter = function() {
            const name = document.getElementById('recName').value.trim();
            const rawPhone = document.getElementById('recPhone').value.trim();
            const phoneCode = document.getElementById('recPhoneCode').value;
            const code = document.getElementById('recCode').value.toUpperCase().replace(/\s/g, '');
            
            if(!name || !rawPhone || !code) return alert('Por favor, llena todos los campos.');
            
            // VALIDACI√ìN Y LIMPIEZA DE TEL√âFONO MEJORADA (EVITA DOBLE PREFIJO)
            let cleanPhone = rawPhone.replace(/\D/g, '');
            
            // Si el usuario peg√≥ el n√∫mero con el c√≥digo de pa√≠s (ej. 5255...), lo quitamos para no duplicar
            const codeDigits = phoneCode.replace('+', ''); // ej. "52"
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            
            const finalPhone = phoneCode + cleanPhone;

            const duplicateCheck = Object.entries(recruiters).find(([key, r]) => { return r.code === code && key !== editingRecruiterId; });
            if (duplicateCheck) { return alert(`‚ö†Ô∏è ERROR: El c√≥digo '${code}' ya est√° siendo usado por ${duplicateCheck[1].name}. Usa otro.`); }
            
            const idToSave = editingRecruiterId || 'rec-' + Date.now();
            set(ref(db, 'recruiters/' + idToSave), { name, phone: finalPhone, code }).then(() => { window.showToast(editingRecruiterId ? '‚úÖ Reclutador actualizado' : '‚úÖ Reclutador agregado'); resetRecruiterForm(); });
        }

        window.editRecruiter = function(id) {
            const r = recruiters[id]; if(!r) return;
            document.getElementById('recName').value = r.name; 
            
            let phoneVal = r.phone;
            // Detecci√≥n autom√°tica b√°sica de lada
            if(phoneVal.startsWith('+52')) { document.getElementById('recPhoneCode').value = '+52'; phoneVal = phoneVal.replace('+52',''); }
            else if(phoneVal.startsWith('+1')) { document.getElementById('recPhoneCode').value = '+1'; phoneVal = phoneVal.replace('+1',''); }
            // ... otros c√≥digos
            document.getElementById('recPhone').value = phoneVal; 

            document.getElementById('recCode').value = r.code;
            editingRecruiterId = id; const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Guardar Cambios"; btn.style.backgroundColor = "#f57c00"; 
            document.getElementById('btnCancelRecruiter').style.display = 'block';
        }

        window.resetRecruiterForm = function() {
            document.getElementById('recName').value = ''; document.getElementById('recPhone').value = ''; document.getElementById('recCode').value = ''; editingRecruiterId = null;
            const btn = document.getElementById('btnSaveRecruiter'); btn.textContent = "Agregar"; btn.style.backgroundColor = "#0a66c2"; 
            document.getElementById('btnCancelRecruiter').style.display = 'none';
        }

        window.deleteRecruiter = function(id) { if(confirm('¬øSeguro que quieres eliminar a este reclutador?')) { remove(ref(db, 'recruiters/' + id)); if(editingRecruiterId === id) resetRecruiterForm(); } }
        
        // CORRECCI√ìN DIN√ÅMICA DE LINKS (Para que funcionen en Vercel, Netlify o .com)
        window.copyLink = function(code) { 
            const link = `${window.location.origin}/?ref=${code}`; 
            navigator.clipboard.writeText(link).then(() => window.showToast('Link copiado')); 
        }
        
        function renderRecruitersTable() {
            const list = document.getElementById('recruitersList');
            if(Object.keys(recruiters).length === 0) { list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay reclutadores</td></tr>'; return; }
            list.innerHTML = Object.keys(recruiters).map(key => { 
                const r = recruiters[key]; 
                return `<tr><td>${r.name}</td><td><b>${r.code}</b></td><td><button class="copy-btn" onclick="copyLink('${r.code}')">Copiar</button></td><td><button onclick="editRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">‚úèÔ∏è</button><button onclick="deleteRecruiter('${key}')" style="cursor:pointer; border:none; background:none;">üóëÔ∏è</button></td></tr>`; 
            }).join('');
        }

        // REGISTER CLICK (ANTI DOBLE CLICK) - CONFIRMADO QUE EST√Å AQU√ç
        window.handleWhatsAppClick = function(btn, jobId, recruiterName, link) {
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Abriendo...';
            window.registerClick(jobId, recruiterName);
            setTimeout(() => { window.open(link, '_blank'); }, 300); 
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000);
        }

        window.registerClick = function(jobId, recruiterName) {
            runTransaction(ref(db, `jobStats/${jobId}/whatsappClicks`), (c) => (c || 0) + 1);
            push(ref(db, 'clickLogs'), { jobId, recruiter: recruiterName || 'Org√°nico', timestamp: new Date().toISOString(), date_readable: new Date().toLocaleString() });
        }

        const visitsRef = ref(db, 'siteStats/visits');
        const monthlyRef = ref(db, `siteStats/monthly/${currentMonthKey}`);
        if (!sessionStorage.getItem('visited')) { runTransaction(visitsRef, (c) => (c || 0) + 1); runTransaction(monthlyRef, (c) => (c || 0) + 1); sessionStorage.setItem('visited', 'true'); }
        onValue(visitsRef, (s) => { if(document.getElementById('totalVisits')) document.getElementById('totalVisits').innerText = s.val() || 0; });
        onValue(monthlyRef, (s) => { if(document.getElementById('monthlyVisits')) document.getElementById('monthlyVisits').innerText = s.val() || 0; });

        window.saveJob = function(e) {
            e.preventDefault();
            
            const phoneCode = document.getElementById('jobPhoneCode').value;
            const rawPhone = document.getElementById('jobContact').value.trim();
            
            // VALIDACI√ìN Y LIMPIEZA PARA JOB CONTACT
            let cleanPhone = rawPhone.replace(/\D/g, '');
            const codeDigits = phoneCode.replace('+', '');
            if (cleanPhone.startsWith(codeDigits)) {
                cleanPhone = cleanPhone.substring(codeDigits.length);
            }
            const finalPhone = cleanPhone ? (phoneCode + cleanPhone) : '';

            const jobData = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                showCompany: document.getElementById('jobShowCompany').value === 'true', 
                state: document.getElementById('jobState').value,
                city: document.getElementById('jobCity').value,
                zone: document.getElementById('jobZone').value,
                location: `${document.getElementById('jobCity').value}, ${document.getElementById('jobState').value}`,
                
                fecha: document.getElementById('jobDate').value, 
                
                salary: document.getElementById('jobSalary').value,
                description: document.getElementById('jobDescription').value,
                schedule: document.getElementById('jobSchedule').value, 
                tags: document.getElementById('jobTags').value,
                contact: finalPhone, 
                status: document.getElementById('jobStatus').value,
                agency: document.getElementById('jobAgency').value,
                requirements: tempReqs,
                benefits: tempBens
            };
            const id = currentEditId || 'job-' + Date.now();
            set(ref(db, 'jobs/' + id), jobData).then(() => {
                window.showToast("‚úÖ Vacante guardada");
                window.closeFormModal();
            });
        }

        window.deleteJob = function(id) { if(confirm('¬øBorrar vacante?')) remove(ref(db, 'jobs/' + id)); }

        function normalizeText(text) { return text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : ""; }

        function formatDateFriendly(dateString) {
            if(!dateString) return '';
            // Si viene YYYY-MM-DD
            if(dateString.includes('-')) {
                const parts = dateString.split('-');
                if(parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateString; // Si es legacy o texto libre, lo muestra tal cual
        }

        function renderJobs() {
            let keys = Object.keys(jobs);
            keys.sort((a, b) => {
                const jobA = jobs[a]; const jobB = jobs[b];
                const statusA = jobA.status === 'No Vigente' ? 1 : 0;
                const statusB = jobB.status === 'No Vigente' ? 1 : 0;
                if (statusA !== statusB) return statusA - statusB;
                
                if(jobA.fecha && jobB.fecha) {
                    return jobB.fecha.localeCompare(jobA.fecha); 
                }
                return b.localeCompare(a); 
            });

            currentFilteredJobs = keys; 
            applyFilterAndRender();
        }

        function applyFilterAndRender() {
            const stateVal = document.getElementById('stateFilter').value;
            const cityVal = document.getElementById('cityFilter').value;

            const matchedKeys = currentFilteredJobs.filter(id => {
                const j = jobs[id];
                
                if (!isAdmin && j.status === 'No Vigente') return false;

                const matchState = stateVal === '' || j.state === stateVal;
                const matchCity = cityVal === '' || j.city === cityVal;

                return matchState && matchCity;
            });

            document.getElementById('jobCounter').textContent = `${matchedKeys.length} vacantes encontradas`;
            
            if (matchedKeys.length === 0) {
                document.getElementById('jobGrid').innerHTML = '';
                document.getElementById('loadMoreContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            const visibleKeys = matchedKeys.slice(0, displayLimit);
            const showLoadMore = matchedKeys.length > displayLimit;

            const grid = document.getElementById('jobGrid');
            grid.innerHTML = visibleKeys.map(id => {
                const j = jobs[id];
                const tags = j.tags ? j.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                const isVigente = j.status !== 'No Vigente';
                
                let statusBadge = '<span class="badge-closed">Cerrada</span>';
                if(isVigente) statusBadge = '<span class="badge-vigente">üü¢ Vigente</span>';

                const showAdminButtons = isAdmin && !refCode;
                const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
                const finalCompanyName = (isAdmin && !refCode) || showNamePublicly ? j.company : "Empresa Confidencial";
                let displayLocation = j.location;
                if (j.city && j.state) displayLocation = `${j.city}, ${j.state}`;

                const niceDate = formatDateFriendly(j.fecha);
                const dateHtml = niceDate ? `<span class="job-date">üìÖ Publicaci√≥n: ${niceDate}</span>` : '';

                return `
                    <div class="job-card" onclick="window.openViewModal('${id}')">
                        ${showAdminButtons ? `<button class="more-btn" onclick="event.stopPropagation(); window.toggleMenu('${id}')">‚ãÆ</button>
                        <div class="admin-actions" id="menu-${id}">
                            <button class="admin-action" onclick="event.stopPropagation(); window.editJob('${id}')">‚úèÔ∏è Editar</button>
                            <button class="admin-action delete" onclick="event.stopPropagation(); window.deleteJob('${id}')">üóëÔ∏è Eliminar</button>
                        </div>` : ''}
                        
                        <div class="card-top-row">
                            ${statusBadge}
                            ${dateHtml}
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div class="company-logo">${j.company.charAt(0)}</div>
                            <div>
                                <div class="job-title">${j.title}</div>
                                <div class="company-name">${finalCompanyName}</div>
                            </div>
                        </div>
                        
                        <div class="location">üìç ${displayLocation}</div>
                        <div class="salary-text">üí∞ ${j.salary || 'A convenir'}</div>
                        
                        ${tags.length > 0 ? `<div class="tags">${tags.slice(0,3).map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('loadMoreContainer').style.display = showLoadMore ? 'block' : 'none';
        }

        window.filterJobs = function() {
            displayLimit = 20; 
            applyFilterAndRender();
        }

        window.loadMoreJobs = function() {
            displayLimit += 20;
            applyFilterAndRender();
        }

        window.toggleMenu = function(id) { 
            document.querySelectorAll('.admin-actions').forEach(m => m.classList.remove('active')); 
            document.getElementById(`menu-${id}`).classList.toggle('active'); 
        }

        window.openViewModal = function(id) {
            const j = jobs[id];
            const isRefMode = !!refCode;

            if (!isAdmin || isRefMode) {
                runTransaction(ref(db, `jobStats/${id}/totalViews`), (c) => (c || 0) + 1);
                runTransaction(ref(db, `jobStats/${id}/monthlyViews/${currentMonthKey}`), (c) => (c || 0) + 1);
            }
            
            const stats = jobStats[id] || {};
            const totalViews = stats.totalViews || 0;
            const showNamePublicly = j.showCompany === true || j.showCompany === 'true';
            const companyDisplay = (isAdmin && !isRefMode) || showNamePublicly ? j.company : "Empresa Confidencial";
            
            let contactHtml = '';
            let targetPhone = '';
            let isReferral = false;

            if (activeRecruiter) { targetPhone = activeRecruiter.phone; isReferral = true; } 
            else if (j.contact) { targetPhone = j.contact.replace(/\D/g, ''); } 
            else if (centralPhone) { targetPhone = centralPhone.replace(/\D/g, ''); }

            if (targetPhone) {
                let msg = `Hola, vi la vacante ${j.title} (C√≥d: ${id})`;
                if(isReferral) msg += ` (Referido por ${activeRecruiter.name})`;
                const waLink = `https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`;
                const recNameSafe = activeRecruiter ? activeRecruiter.name : 'Org√°nico';
                
                contactHtml = `<div class="sticky-footer">
                                    <p style="font-size:12px; color:#666; margin-bottom:5px;">üëá Respuesta Inmediata üëá</p>
                                    <button onclick="window.handleWhatsAppClick(this, '${id}', '${recNameSafe}', '${waLink}')" class="whatsapp-btn-large">
                                        üìÖ Agenda Entrevista Ahora üì≤
                                    </button>
                               </div>`;
            }

            let adminInfoHtml = '';
            if (isAdmin && !isRefMode) {
                adminInfoHtml = `<div style="display:flex; flex-wrap:wrap; gap:10px;">
                        <div class="view-count-badge">üëÅÔ∏è ${totalViews} Vistas</div>
                        <div class="agency-badge">${j.agency || 'Sin asignar'}</div>
                    </div>`;
            }

            let locationDetail = j.location;
            if (j.state && j.city) locationDetail = `${j.city}, ${j.state} ${j.zone ? '('+j.zone+')' : ''}`;
            
            const isVigente = j.status !== 'No Vigente';
            const badgeHtml = isVigente ? '<span class="badge-vigente">üü¢ Vigente</span>' : '<span class="badge-closed">Cerrada</span>';
            
            const niceDate = formatDateFriendly(j.fecha);
            const dateHtml = niceDate ? `<span style="font-size:0.8rem; color:#888;">Publicaci√≥n: ${niceDate}</span>` : '';

            document.getElementById('viewModalBody').innerHTML = `
                ${adminInfoHtml}
                
                <div class="card-top-row" style="margin-top:10px; margin-right:40px;">
                    ${badgeHtml}
                    ${dateHtml}
                </div>

                <h2 style="font-size: 24px; margin-bottom: 5px; color:#333;">${j.title}</h2>
                <div style="font-size: 18px; color: #0a66c2; margin-bottom: 20px;">${companyDisplay}</div>

                <div class="job-details">
                    <div class="detail-item">üìç ${locationDetail}</div>
                    <div class="detail-item salary-text">üí∞ ${j.salary || 'A convenir'}</div>
                    <div class="detail-item">üïí ${j.schedule || 'Horario a definir'}</div>
                </div>

                <div class="section-title">Descripci√≥n</div>
                <p style="color: #444; line-height: 1.6;">${j.description}</p>
                ${(j.requirements||[]).length ? `<div class="section-title">Requisitos</div><ul class="item-list">${j.requirements.map(r=>`<li>${r}</li>`).join('')}</ul>` : ''}
                ${(j.benefits||[]).length ? `<div class="section-title">Beneficios</div><ul class="item-list">${j.benefits.map(b=>`<li>${b}</li>`).join('')}</ul>` : ''}
                
                <p style="font-size:12px; color:#888; font-style:italic; margin-top:20px;">‚ö†Ô∏è Nota: Algunas empresas pueden solicitar examen m√©dico y/o antidoping.</p>
                
                ${contactHtml}
            `;
            document.getElementById('viewModal').classList.add('active');
        }

        window.closeViewModal = function() { document.getElementById('viewModal').classList.remove('active'); }
        window.closeFormModal = function() { document.getElementById('formModal').classList.remove('active'); }
        window.closeTeamModal = function() { document.getElementById('teamModal').classList.remove('active'); }
        
        window.openJobForm = function() {
            currentEditId = null; document.getElementById('formTitle').textContent = 'Nueva Vacante'; document.getElementById('jobForm').reset();
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('jobDate').value = todayISO; 
            
            tempReqs = []; tempBens = []; updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('jobShowCompany').value = 'true';
            document.getElementById('formModal').classList.add('active');
        }

        window.editJob = function(id) {
            currentEditId = id; const j = jobs[id];
            document.getElementById('formTitle').textContent = 'Editar Vacante';
            document.getElementById('jobTitle').value = j.title; document.getElementById('jobCompany').value = j.company;
            document.getElementById('jobShowCompany').value = (j.showCompany === false || j.showCompany === 'false') ? 'false' : 'true';
            document.getElementById('jobState').value = j.state || '';
            document.getElementById('jobCity').value = j.city || '';
            document.getElementById('jobZone').value = j.zone || '';
            
            document.getElementById('jobDate').value = j.fecha || ''; 

            if(!j.city && j.location) document.getElementById('jobCity').value = j.location;
            document.getElementById('jobSalary').value = j.salary||'';
            document.getElementById('jobDescription').value = j.description; document.getElementById('jobStatus').value = j.status||'Vigente';
            document.getElementById('jobAgency').value = j.agency||'';
            
            let contactVal = j.contact || '';
            let codeVal = '+52';
            if(contactVal.startsWith('+52')) { codeVal = '+52'; contactVal = contactVal.replace('+52',''); }
            else if(contactVal.startsWith('+1')) { codeVal = '+1'; contactVal = contactVal.replace('+1',''); }
            document.getElementById('jobPhoneCode').value = codeVal;
            document.getElementById('jobContact').value = contactVal;

            document.getElementById('jobSchedule').value = j.schedule||''; 
            tempReqs = j.requirements||[]; tempBens = j.benefits||[];
            updateList('reqList', tempReqs, 'req'); updateList('benList', tempBens, 'ben');
            document.getElementById('formModal').classList.add('active');
        }

        window.addItem = function(type) {
            const val = document.getElementById(type+'Input').value.trim();
            if(val) { (type==='req'?tempReqs:tempBens).push(val); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); document.getElementById(type+'Input').value=''; }
        }
        window.removeItem = function(type, i) { (type==='req'?tempReqs:tempBens).splice(i,1); updateList(type+'List', (type==='req'?tempReqs:tempBens), type); }
        function updateList(id, arr, type) { document.getElementById(id).innerHTML = arr.map((item,i)=>`<li>${item}<button onclick="removeItem('${type}',${i})" style="color:red;border:none;background:none;cursor:pointer">√ó</button></li>`).join(''); }

        window.exportToExcel = function() {
            if(!Object.keys(jobs).length) return alert('Sin datos');
            const data = Object.keys(jobs).map(id => {
                const j = jobs[id];
                return { 
                    'ID': id, 'T√≠tulo': j.title, 'Empresa': j.company, 
                    'Mostrar Empresa Publicamente': (j.showCompany === true || j.showCompany === 'true') ? 'SI' : 'NO',
                    'Estado': j.state, 'Municipio': j.city, 'Zona': j.zone, 
                    'Fecha': j.fecha, 
                    'Salario': j.salary, 'Descripci√≥n': j.description, 
                    'Jornada': j.schedule, 
                    'Etiquetas': j.tags,
                    'Requisitos': (j.requirements||[]).join(' | '), 
                    'Beneficios': (j.benefits||[]).join(' | '),
                    'Contacto': j.contact, 'Estatus': j.status, 'Tipo de Servicio o Agencia': j.agency
                };
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Vacantes"); XLSX.writeFile(wb, "Respaldo_Completo.xlsx");
        }

        window.exportMetrics = function() {
             if(!Object.keys(jobs).length) return alert('Sin datos para m√©tricas');
            const generalData = Object.keys(jobs).map(id => {
                const j = jobs[id]; const stats = jobStats[id] || {};
                return {
                    'ID Vacante': id, 'Puesto': j.title, 'Empresa': j.company, 'Vistas Totales': stats.totalViews || 0, 'Clics WhatsApp': stats.whatsappClicks || 0
                };
            });
            const breakdown = {};
            Object.values(clickLogs).forEach(log => {
                const key = (log.recruiter||'Desc') + '|' + log.jobId;
                if(!breakdown[key]) breakdown[key] = { rec: log.recruiter, jId: log.jobId, clicks: 0 };
                breakdown[key].clicks++;
            });
            const recruiterData = Object.values(breakdown).map(i => ({ 'Reclutador': i.rec, 'ID': i.jId, 'Clics': i.clicks }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(generalData), "General_KPIs"); 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(recruiterData), "Desempe√±o_Reclutadores");
            XLSX.writeFile(wb, `Reporte_Metricas_${currentMonthKey}.xlsx`);
        }

        window.downloadTemplate = function() {
            const data = [{
                'ID': 'ej-1', 
                'FECHA': '2026-01-12', 
                'T√çTULO': 'Ejemplo', 
                'EMPRESA': 'Empresa', 
                'MOSTRAR EMPRESA PUBLICAMENTE': 'SI',
                'ESTADO': 'CDMX', 
                'MUNICIPIO': 'Coyoac√°n', 
                'ZONA': 'Centro',
                'SALARIO': '10000', 
                'DESCRIPCI√ìN': 'Desc...', 
                'JORNADA': 'Lunes a Viernes', 
                'ETIQUETAS': '#Ventas', 
                'REQUISITOS': 'Req 1 | Req 2', 
                'BENEFICIOS': 'Ben 1 | Ben 2', 
                'CONTACTO': '5512345678', 
                'ESTATUS': 'Vigente',
                'TIPO DE SERVICIO O AGENCIA': 'Agencia Interna'
            }];
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla'); XLSX.writeFile(wb, 'plantilla.xlsx');
        }

        // CAMBIO IMPORTANTE: TRACKING EN SHARE
        window.shareApp = async function() {
             const refCode = sessionStorage.getItem('recruiterCode');
             const url = refCode ? `${window.location.origin}/?ref=${refCode}` : window.location.href;
             
             const data = { 
                 title: 'TuChamba', 
                 text: '¬°Checa esta vacante! Contrataci√≥n r√°pida en CDMX, NL y EdoMex. Detalles aqu√≠:', 
                 url: url 
             };
             if(navigator.share) await navigator.share(data); else window.open(`https://wa.me/?text=${encodeURIComponent(data.text+' '+data.url)}`);
        }
        
        window.importFromExcel = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);
                    if(!json.length) { alert('Archivo vac√≠o'); return; }
                    let count = 0;
                    
                    const findKey = (row, keyName) => {
                        return Object.keys(row).find(k => k.toLowerCase() === keyName.toLowerCase());
                    };

                    json.forEach((row, i) => {
                         const titleKey = findKey(row, 't√≠tulo') || findKey(row, 'titulo');
                         const companyKey = findKey(row, 'empresa');
                         
                         const title = titleKey ? row[titleKey] : null;
                         const company = companyKey ? row[companyKey] : null;
                         
                         if(!title || !company) return;
                         
                         const id = row['ID'] || 'job-'+Date.now()+'-'+i;
                         const state = row[findKey(row, 'estado')] || ''; 
                         const city = row[findKey(row, 'municipio')] || ''; 
                         const zone = row[findKey(row, 'zona')] || '';
                         const legacyLoc = row['Ubicaci√≥n'] || ''; 

                         const showCompKey = findKey(row, 'mostrar empresa publicamente');
                         const showCompanyRaw = showCompKey ? row[showCompKey] : 'SI';

                         let contactRaw = row[findKey(row, 'contacto')] || '';
                         contactRaw = String(contactRaw).replace(/\D/g, ''); 
                         if(contactRaw.length === 10) contactRaw = '+52' + contactRaw; 

                         const jobData = {
                             title: title, 
                             company: company, 
                             showCompany: String(showCompanyRaw).toUpperCase() === 'SI',
                             state: state, city: city, zone: zone,
                             location: (city && state) ? `${city}, ${state}` : legacyLoc, 
                             
                             fecha: row[findKey(row, 'fecha')] || '', 
                             
                             salary: row[findKey(row, 'salario')] || '', 
                             description: row[findKey(row, 'descripci√≥n')] || row[findKey(row, 'descripcion')] || '',
                             schedule: row[findKey(row, 'jornada')] || 'Horario a definir',
                             tags: row[findKey(row, 'etiquetas')] || '',
                             requirements: (row[findKey(row, 'requisitos')]) ? String(row[findKey(row, 'requisitos')]).split(' | ') : [],
                             benefits: (row[findKey(row, 'beneficios')]) ? String(row[findKey(row, 'beneficios')]).split(/\s*\|\s*/) : [],
                             contact: contactRaw, 
                             status: row[findKey(row, 'estatus')] || 'Vigente',
                             agency: row[findKey(row, 'tipo de servicio o agencia')] || '' 
                         };
                         set(ref(db, 'jobs/' + id), jobData);
                         count++;
                    });
                    window.showToast(`‚úÖ ${count} vacantes cargadas`);
                } catch(err) { alert('Error: ' + err.message); }
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
